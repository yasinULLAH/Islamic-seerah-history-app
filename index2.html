<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیرت النبی ﷺ - پیش رفتہ بصری تجزیہ</title>
    <meta name="description" content="نبی اکرم صلی اللہ علیہ وسلم کی حیات طیبہ کے اہم واقعات کا ایک جامع اور بصری تجزیہ۔ ٹائم لائن، چارٹس، اور تفصیلی معلومات کے ساتھ۔">
    <meta name="keywords" content="سیرت النبی, سیرت, محمد, اسلام, تاریخ اسلام, واقعات, ٹائم لائن, تجزیہ, Yasin Ullah, Pakistani">
    <meta name="author" content="Yasin Ullah">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --card-bg: #ffffff;
            --header-bg: #343a40;
            --header-text: #f8f9fa;
            --accent-color: #007bff;
            --accent-color-dark: #0056b3;
            --border-color: #dee2e6;
            --modal-bg: rgba(0,0,0,0.6);
            --modal-content-bg: #ffffff;
            --button-bg: #007bff;
            --button-text: #ffffff;
            --danger-bg: #dc3545;
            --success-bg: #28a745;
            --font-family-urdu: 'Noto Nastaliq Urdu', serif;
            --shadow: 0 4px 8px rgba(0,0,0,0.1);
            --border-radius: 8px;
        }

        .dark-mode {
            --bg-color: #2c3034; 
            --text-color: #e9ecef;
            --card-bg: #343a40; 
            --header-bg: #212529; 
            --header-text: #f8f9fa;
            --accent-color: #0d6efd; 
            --accent-color-dark: #0b5ed7;
            --border-color: #495057; 
            --modal-content-bg: #343a40;
            --button-bg: #0d6efd;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-urdu);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            direction: rtl;
            transition: background-color 0.3s, color 0.3s;
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 1rem 1.5rem;
            text-align: center;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        header h1 {
            font-size: 2rem;
            margin: 0;
        }

        #themeToggle {
            background: var(--accent-color);
            color: var(--button-text);
            border: none;
            padding: 10px 15px;
            cursor: pointer;
            border-radius: var(--border-radius);
            font-family: var(--font-family-urdu);
            font-size: 0.9rem;
            transition: background-color 0.2s ease-in-out;
        }
        #themeToggle:hover {
            background: var(--accent-color-dark);
        }

        .controls-section {
            background-color: var(--card-bg);
            padding: 20px;
            margin-bottom: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .controls-section input[type="search"],
        .controls-section select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family-urdu);
            font-size: 1rem;
        }
        
        .controls-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            font-size: 0.95rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 25px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        .tab-button {
            flex-grow: 1;
            padding: 14px 18px;
            cursor: pointer;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: none;
            border-left: 1px solid var(--border-color); 
            font-family: var(--font-family-urdu);
            font-size: 1.05rem;
            transition: background-color 0.3s, color 0.3s;
        }
        .tab-button:first-child {
             border-left: none; 
        }

        .tab-button.active {
            background-color: var(--accent-color);
            color: var(--button-text);
            font-weight: bold;
        }
        .tab-button:hover:not(.active) {
            background-color: var(--bg-color);
        }

        .tab-content {
            display: none;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-height: 300px; 
        }

        .tab-content.active {
            display: block;
        }

        #eventListViewContainer { }
        #eventListView {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
        }

        .event-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .event-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.1);
        }

        .event-card h3 {
            color: var(--accent-color);
            margin-bottom: 12px;
            font-size: 1.5rem;
        }
        .event-card p {
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .event-card strong {
            font-weight: bold;
        }
        .event-card .meta-info {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.85;
            margin-bottom: 12px;
        }

        .details-button {
            background-color: var(--accent-color);
            color: var(--button-text);
            border: none;
            padding: 10px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            text-align: center;
            font-family: var(--font-family-urdu);
            margin-top: auto; 
            transition: background-color 0.2s ease-in-out;
            font-size: 0.95rem;
        }
        .details-button:hover {
            background-color: var(--accent-color-dark);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-bg);
        }

        .modal-content {
            background-color: var(--modal-content-bg);
            margin: 5% auto;
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            width: 85%;
            max-width: 750px;
            color: var(--text-color);
            position: relative;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .close-button {
            color: var(--text-color);
            position: absolute;
            left: 20px; 
            top: 15px;
            font-size: 32px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .close-button:hover,
        .close-button:focus {
            opacity: 0.7;
        }
        
        .modal-content h2 {
            color: var(--accent-color);
            margin-bottom: 20px;
            font-size: 1.8rem;
        }
        .modal-content p {
            margin-bottom: 12px;
            font-size: 1.05rem;
        }
        .modal-content .tag {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--button-text);
            padding: 4px 10px;
            border-radius: var(--border-radius);
            margin: 3px;
            font-size: 0.95em;
        }

        #loadingIndicator, .empty-state-message {
            text-align: center;
            padding: 30px;
            font-size: 1.25rem;
            display: none; 
            color: var(--text-color);
            opacity: 0.8;
        }

        .visualization-container {
            min-height: 350px;
            background-color: var(--bg-color);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
            overflow-x: auto; 
            border: 1px solid var(--border-color);
        }
        .visualization-container h4 {
            text-align: center;
            margin-bottom: 20px;
            color: var(--accent-color);
            font-size: 1.3rem;
        }
        .timeline-svg, .chart-svg {
            display: block;
            margin: auto;
            overflow: visible; 
        }
        .timeline-event-marker {
            cursor: pointer;
            transition: r 0.2s, fill 0.2s;
        }
        .timeline-event-marker:hover {
            r: 10px; 
            fill: var(--accent-color-dark);
        }
        .axis path, .axis line {
            fill: none;
            stroke: var(--text-color);
            shape-rendering: crispEdges;
            opacity: 0.7;
        }
        .axis text {
            fill: var(--text-color);
            font-family: var(--font-family-urdu);
            font-size: 0.9em;
        }
        .tooltip {
            position: absolute;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 10px;
            font-size: 0.95em;
            pointer-events: none; 
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: var(--shadow);
            z-index: 1001;
            max-width: 250px;
        }

        .backup-restore-section {
            margin-top: 30px;
            padding: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .backup-restore-section h3 {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 1.4rem;
        }
        .backup-restore-section button, .backup-restore-section input[type="file"] {
            margin: 8px;
            padding: 12px 18px;
            border-radius: var(--border-radius);
            border: none;
            cursor: pointer;
            font-family: var(--font-family-urdu);
            font-size: 1rem;
        }
        .backup-restore-section button {
            background-color: var(--accent-color);
            color: var(--button-text);
            transition: background-color 0.2s ease-in-out;
        }
        .backup-restore-section button:hover {
            background-color: var(--accent-color-dark);
        }
        #restoreFile {
            color: var(--text-color);
        }
        #restoreStatus {
            margin-top: 12px;
            font-size: 0.95em;
        }

        .pagination-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            margin-top: 20px;
        }
        .pagination-controls button {
            background-color: var(--button-bg);
            color: var(--button-text);
            border: none;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-family: var(--font-family-urdu);
            transition: background-color 0.2s ease-in-out;
        }
        .pagination-controls button:hover:not(:disabled) {
            background-color: var(--accent-color-dark);
        }
        .pagination-controls button:disabled {
            background-color: var(--border-color);
            color: var(--text-color);
            opacity: 0.7;
            cursor: not-allowed;
        }
        .pagination-controls .page-number-container {
            display: flex;
            align-items: center;
            margin: 0 10px;
        }
        .pagination-controls .page-number {
            padding: 8px 12px;
            margin: 0 3px;
            cursor: pointer;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            transition: background-color 0.2s, color 0.2s;
        }
        .pagination-controls .page-number:hover:not(.active) {
            background-color: var(--bg-color);
        }
        .pagination-controls .page-number.active {
            background-color: var(--accent-color);
            color: var(--button-text);
            border-color: var(--accent-color);
            font-weight: bold;
        }
        .pagination-controls .page-info {
            margin: 0 10px;
            font-size: 0.95rem;
        }

        #groupsView .group-category {
            margin-bottom: 25px;
        }
        #groupsView h4 {
            color: var(--accent-color);
            margin-bottom: 10px;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 5px;
            display: inline-block;
        }
        #groupsView ul {
            list-style: none;
            padding-right: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        #groupsView li {
            background-color: var(--bg-color);
            padding: 8px 15px;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
            border: 1px solid var(--border-color);
        }
        #groupsView li:hover {
            background-color: var(--accent-color);
            color: var(--button-text);
            border-color: var(--accent-color);
        }

        #mapLocationList {
            list-style: none;
            padding: 0;
        }
        #mapLocationList li {
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s;
        }
        #mapLocationList li:last-child {
            border-bottom: none;
        }
        #mapLocationList li:hover {
            background-color: var(--bg-color);
        }
        #mapLocationList li strong {
            color: var(--accent-color);
        }

        #personalitiesListContainer .personality-entry {
            margin-bottom: 20px;
            padding: 15px;
            background-color: var(--bg-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }
        #personalitiesListContainer .personality-entry h5 {
            color: var(--accent-color);
            font-size: 1.2rem;
            margin-bottom: 8px;
        }
        #personalitiesListContainer .personality-entry ul {
            list-style-type: disc;
            padding-right: 25px;
        }
        #personalitiesListContainer .personality-entry li a {
            color: var(--text-color);
            text-decoration: none;
            transition: color 0.2s;
        }
        #personalitiesListContainer .personality-entry li a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            header h1 {
                font-size: 1.6rem;
            }
            .tabs {
                flex-direction: column;
            }
            .tab-button {
                border-left: none;
                border-bottom: 1px solid var(--border-color);
            }
            .tab-button:last-child {
                border-bottom: none;
            }
            .modal-content {
                width: 95%;
                margin: 8% auto;
                padding: 25px;
            }
            .controls-grid {
                grid-template-columns: 1fr; 
            }
        }
        @media (max-width: 480px) {
             header {
                flex-direction: column;
                gap: 12px;
            }
            header h1 {
                font-size: 1.4rem;
            }
            #eventListView {
                grid-template-columns: 1fr; 
            }
            .pagination-controls {
                flex-direction: column;
                gap: 10px;
            }
            .pagination-controls .page-number-container {
                flex-wrap: wrap;
                justify-content: center;
            }
        }
        .toast-message {
            position: fixed;
            bottom: 20px;
            right: 20px; 
            padding: 12px 20px;
            border-radius: var(--border-radius);
            color: white;
            font-family: var(--font-family-urdu);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.5s, transform 0.5s;
            transform: translateY(20px);
            box-shadow: var(--shadow);
        }
        .toast-message.show {
            opacity: 1;
            transform: translateY(0);
        }
        .toast-message.success { background-color: var(--success-bg); }
        .toast-message.error { background-color: var(--danger-bg); }
        .toast-message.info { background-color: var(--accent-color); }

    </style>
</head>
<body>
    <header>
        <h1>سیرت النبی ﷺ - پیش رفتہ بصری تجزیہ</h1>
        <button id="themeToggle">روشن/تاریک موڈ</button>
    </header>

    <div class="container">
        <div class="controls-section">
            <div class="controls-grid">
                <div>
                    <label for="searchInput">تلاش کریں:</label>
                    <input type="search" id="searchInput" placeholder="واقعہ، تفصیل، شخصیات، ٹیگز...">
                </div>
                <div>
                    <label for="periodFilter">دور/ہجری سال:</label>
                    <select id="periodFilter">
                        <option value="">تمام ادوار</option>
                    </select>
                </div>
                <div>
                    <label for="tagFilter">ٹیگز:</label>
                    <select id="tagFilter">
                        <option value="">تمام ٹیگز</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab-button active" data-tab="eventListViewContainer">واقعات کی فہرست</button>
            <button class="tab-button" data-tab="groupsView">خلاصہ اور گروپس</button>
            <button class="tab-button" data-tab="timelineView">ٹائم لائن منظر</button>
            <button class="tab-button" data-tab="chartsView">شماریاتی چارٹ</button>
            <button class="tab-button" data-tab="mapView">جغرافیائی نقشہ (مقامات)</button>
            <button class="tab-button" data-tab="personalitiesView">متعلقہ شخصیات</button>
        </div>

        <div id="loadingIndicator">ڈیٹا لوڈ ہو رہا ہے، براہ کرم انتظار کریں...</div>
        
        <div id="eventListViewContainer" class="tab-content active">
            <div id="eventListView">
                <!-- Event cards will be injected here -->
            </div>
            <div id="paginationControlsContainer">
                <!-- Pagination controls will be injected here -->
            </div>
            <div id="emptyStateMessageEventList" class="empty-state-message" style="display:none;">کوئی واقعات نہیں ملے۔ براہ کرم اپنے فلٹرز کو تبدیل کرنے کی کوشش کریں۔</div>
        </div>

        <div id="groupsView" class="tab-content">
            <h4>ڈیٹا گروپس</h4>
            <div class="group-category" id="periodGroupsContainer">
                <h4>ادوار کے لحاظ سے</h4>
                <ul id="periodGroupsList"></ul>
            </div>
            <div class="group-category" id="yearGroupsContainer">
                <h4>سالوں کے لحاظ سے (عیسوی)</h4>
                <ul id="yearGroupsList"></ul>
            </div>
            <div class="group-category" id="locationGroupsContainer">
                <h4>مقامات کے لحاظ سے</h4>
                <ul id="locationGroupsList"></ul>
            </div>
            <div class="group-category" id="tagGroupsContainer">
                <h4>ٹیگز کے لحاظ سے</h4>
                <ul id="tagGroupsList"></ul>
            </div>
            <div id="emptyStateMessageGroups" class="empty-state-message" style="display:none;">گروپ بندی کے لیے کوئی ڈیٹا دستیاب نہیں۔</div>
        </div>


        <div id="timelineView" class="tab-content">
            <div class="visualization-container">
                <h4>واقعات کی ٹائم لائن (عیسوی سال)</h4>
                <svg id="timelineSvg" class="timeline-svg" width="1000" height="400"></svg>
            </div>
            <div id="emptyStateMessageTimeline" class="empty-state-message" style="display:none;">ٹائم لائن کے لیے کوئی ڈیٹا دستیاب نہیں۔</div>
        </div>

        <div id="chartsView" class="tab-content">
            <div class="visualization-container">
                <h4>ٹیگز کے لحاظ سے واقعات کی تقسیم</h4>
                <svg id="tagsChartSvg" class="chart-svg" width="500" height="350"></svg>
            </div>
            <div class="visualization-container">
                <h4>ادوار کے لحاظ سے واقعات کی تقسیم</h4>
                <svg id="periodsChartSvg" class="chart-svg" width="500" height="350"></svg>
            </div>
            <div id="emptyStateMessageCharts" class="empty-state-message" style="display:none;">چارٹس کے لیے کوئی ڈیٹا دستیاب نہیں۔</div>
        </div>
        
        <div id="mapView" class="tab-content">
            <div class="visualization-container">
                <h4>واقعات کے مقامات</h4>
                <ul id="mapLocationList"></ul>
            </div>
             <div id="emptyStateMessageMap" class="empty-state-message" style="display:none;">نقشے کے لیے کوئی مقامات دستیاب نہیں۔</div>
        </div>

        <div id="personalitiesView" class="tab-content">
             <h4>متعلقہ شخصیات اور ان سے منسلک واقعات</h4>
             <div id="personalitiesListContainer">
                <!-- Personalities will be listed here -->
             </div>
             <div id="emptyStateMessagePersonalities" class="empty-state-message" style="display:none;">کوئی شخصیات نہیں ملیں۔</div>
        </div>
        
        <div class="backup-restore-section">
            <h3>ڈیٹا بیک اپ اور بحالی</h3>
            <button id="backupDataBtn">ڈیٹا کا بیک اپ لیں</button>
            <input type="file" id="restoreFile" accept=".json" style="display: none;">
            <button onclick="document.getElementById('restoreFile').click()">ڈیٹا بحال کریں</button>
            <p id="restoreStatus"></p>
        </div>

    </div> <!-- /container -->

    <div id="eventDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" aria-label="بند کریں" role="button" tabindex="0">×</span>
            <h2 id="modalTitle"></h2>
            <p><strong>عیسوی سال:</strong> <span id="modalGregorianYear"></span></p>
            <p><strong>ہجری سال / دور:</strong> <span id="modalHijriYear"></span></p>
            <p><strong>مختصر تفصیل:</strong> <span id="modalShortDescription"></span></p>
            <p><strong>تفصیلی وضاحت:</strong> <span id="modalDetailedExplanation"></span></p>
            <p><strong>متعلقہ شخصیات:</strong> <span id="modalPersonalities"></span></p>
            <p><strong>مقام:</strong> <span id="modalLocation"></span></p>
            <p><strong>نقشہ کوآرڈینیٹس:</strong> <span id="modalCoordinates"></span></p>
            <p><strong>ٹیگز:</strong> <span id="modalTags"></span></p>
            <p><strong>تصویری حوالہ:</strong> <span id="modalImageRef"></span></p>
        </div>
    </div>
    
    <div class="tooltip" id="tooltip"></div>

    <script>
        (function() {
            // --- Constants ---
            const DB_NAME = 'SeerahEventsDB_YasinUllah_V3_Fetch'; 
            const DB_VERSION = 1;
            const STORE_NAME = 'seerah_events';
            const KEY_PATH = 'شمار';
            const ITEMS_PER_PAGE = 9; 

            // --- DOM Elements ---
            const themeToggle = document.getElementById('themeToggle');
            const searchInput = document.getElementById('searchInput');
            const periodFilter = document.getElementById('periodFilter');
            const tagFilter = document.getElementById('tagFilter');
            
            const eventListViewContainer = document.getElementById('eventListViewContainer');
            const eventListView = document.getElementById('eventListView');
            const paginationControlsContainer = document.getElementById('paginationControlsContainer');
            
            const groupsView = document.getElementById('groupsView');
            const periodGroupsList = document.getElementById('periodGroupsList');
            const yearGroupsList = document.getElementById('yearGroupsList');
            const locationGroupsList = document.getElementById('locationGroupsList');
            const tagGroupsList = document.getElementById('tagGroupsList');

            const timelineView = document.getElementById('timelineView');
            const timelineSvg = document.getElementById('timelineSvg');
            const chartsView = document.getElementById('chartsView');
            const tagsChartSvg = document.getElementById('tagsChartSvg');
            const periodsChartSvg = document.getElementById('periodsChartSvg');
            const mapView = document.getElementById('mapView');
            const mapLocationList = document.getElementById('mapLocationList');
            const personalitiesView = document.getElementById('personalitiesView');
            const personalitiesListContainer = document.getElementById('personalitiesListContainer');

            const loadingIndicator = document.getElementById('loadingIndicator');
            const emptyStateMessages = {
                eventList: document.getElementById('emptyStateMessageEventList'),
                groups: document.getElementById('emptyStateMessageGroups'),
                timeline: document.getElementById('emptyStateMessageTimeline'),
                charts: document.getElementById('emptyStateMessageCharts'),
                map: document.getElementById('emptyStateMessageMap'),
                personalities: document.getElementById('emptyStateMessagePersonalities')
            };

            const modal = document.getElementById('eventDetailModal');
            const modalCloseButton = modal.querySelector('.close-button');
            const tooltip = document.getElementById('tooltip');

            const backupDataBtn = document.getElementById('backupDataBtn');
            const restoreFileInput = document.getElementById('restoreFile');
            const restoreStatus = document.getElementById('restoreStatus');

            // --- State Variables ---
            let db;
            let allEvents = [];
            let currentFilters = {
                searchTerm: '',
                period: '',
                tag: '',
                gregorianYear: '', 
                location: ''      
            };
            let currentPage = 1;
            let activeTab = 'eventListViewContainer';

            // --- Fallback Sample CSV Data (Embedded for offline/initial load if fetch fails) ---
            const fallbackHistoryCSV = `شمار,عیسوی سال (تقریباً),ہجری سال / دور,واقعہ (اردو),مختصر تفصیل (اردو)
1,570,قبل از نبوت,ولادت با سعادت,نبی اکرم صلی اللہ علیہ وسلم کی مکہ مکرمہ میں ولادت ہوئی۔
2,610,مکی دور,پہلی وحی,غار حرا میں پہلی وحی کا نزول ہوا۔
3,622,مدنی دور,ہجرت مدینہ,مکہ سے مدینہ کی طرف ہجرت فرمائی۔
4,624,مدنی دور,غزوہ بدر,کفار مکہ کے خلاف پہلی فیصلہ کن جنگ۔
6,595,قبل از نبوت,حضرت خدیجہؓ سے نکاح,آپ ﷺ کا پچیس سال کی عمر میں حضرت خدیجہؓ سے نکاح ہوا۔
7,613,مکی دور,اعلان نبوت (عام),کوہ صفا پر کھڑے ہو کر قریش کو اسلام کی دعوت دی۔
8,615,مکی دور,ہجرت حبشہ (پہلی),صحابہ کرام کی ایک جماعت نے حبشہ کی طرف ہجرت کی۔
9,619,مکی دور,عام الحزن,حضرت خدیجہؓ اور حضرت ابو طالب کی وفات کا سال۔
10,620,مکی دور,واقعہ معراج,آپ ﷺ کو مسجد حرام سے مسجد اقصیٰ اور پھر آسمانوں کی سیر کرائی گئی۔
11,628,مدنی دور,صلح حدیبیہ,مسلمانوں اور قریش مکہ کے درمیان دس سالہ امن معاہدہ۔
12,630,مدنی دور,فتح مکہ,مسلمانوں نے بغیر کسی بڑی لڑائی کے مکہ مکرمہ فتح کیا۔
13,632,مدنی دور,حجۃ الوداع,آپ ﷺ کا آخری حج اور خطبہ۔
14,632,مدنی دور,وفات النبی ﷺ,آپ ﷺ نے مدینہ منورہ میں وصال فرمایا۔`;

            const fallbackDetailsCSV = `شمار,تفصیلی وضاحت,متعلقہ شخصیات,مقام,نقشہ_کوآرڈینیٹس,تصویری_حوالہ,ٹیگز
1,"آپ ﷺ بروز پیر، ١٢ ربیع الاول، عام الفیل میں پیدا ہوئے۔ والد کا نام عبداللہ اور والدہ کا نام آمنہ تھا۔","حضرت آمنہ;حضرت عبداللہ;عبدالمطلب",مکہ مکرمہ,"21.3891,39.8579","birth.jpg","ولادت,مکی دور,ابتدائی زندگی"
2,"چالیس سال کی عمر میں رمضان المبارک کے مہینے میں غار حرا میں اللہ تعالیٰ کی طرف سے حضرت جبرائیل علیہ السلام کے ذریعے پہلی وحی نازل ہوئی۔ اقراء باسم ربک الذی خلق۔","حضرت جبرائیل علیہ السلام;حضرت خدیجہؓ",غار حرا,"21.4592,39.8876","first_revelation.jpg","وحی,نبوت,مکی دور"
3,"کفار مکہ کے مظالم سے تنگ آکر اللہ کے حکم سے مسلمانوں نے مدینہ کی طرف ہجرت کی۔ آپ ﷺ نے حضرت ابوبکر صدیقؓ کے ہمراہ سفر کیا۔","حضرت ابوبکر صدیقؓ;سراقہ بن مالک",مدینہ منورہ,"24.4686,39.6142","hijrah.jpg","ہجرت,مدنی دور,ریاست مدینہ"
4,"اسلام اور کفر کے درمیان پہلا بڑا معرکہ جو رمضان المبارک ٢ ہجری میں بدر کے مقام پر پیش آیا۔ مسلمانوں کو فتح نصیب ہوئی۔","حضرت حمزہؓ;حضرت علیؓ;ابوجہل",بدر,"23.7667,38.7833","badr.jpg","غزوہ,جنگ,مدنی دور"
6,"حضرت خدیجہ بنت خویلدؓ ایک مالدار اور باعزت خاتون تھیں۔ آپ ﷺ کی صداقت و امانت سے متاثر ہو کر نکاح کا پیغام بھیجا۔","حضرت خدیجہؓ;نفیسہ بنت منبہ",مکہ مکرمہ,"21.3891,39.8579","marriage_khadija.jpg","نکاح,ازدواجی زندگی,مکی دور"
7,"نبوت کے تیسرے سال اللہ کے حکم سے آپ ﷺ نے کوہ صفا پر چڑھ کر قریش کے خاندانوں کو پکارا اور انہیں توحید کی دعوت دی۔","قریش کے سردار;حضرت علیؓ",کوہ صفا, "21.4230,39.8262","public_preaching.jpg","دعوت,اعلان نبوت,مکی دور"
8,"مشرکین مکہ کے مظالم بڑھنے پر گیارہ مردوں اور چار عورتوں پر مشتمل پہلا قافلہ حضرت عثمان بن عفانؓ کی قیادت میں حبشہ روانہ ہوا۔","حضرت عثمان بن عفانؓ;حضرت رقیہؓ;نجاشی بادشاہ",حبشہ (ایتھوپیا),"9.1450,40.4897","abyssinia_migration1.jpg","ہجرت,مظالم,مکی دور"
9,"اسی سال آپ ﷺ کی زوجہ محترمہ حضرت خدیجہؓ اور آپ کے چچا و محافظ حضرت ابو طالب کا انتقال ہوا۔ یہ سال آپ ﷺ کے لیے بہت غم کا باعث بنا۔","حضرت خدیجہؓ;حضرت ابو طالب",مکہ مکرمہ,"21.3891,39.8579","year_of_sorrow.jpg","وفات,غم,مکی دور"
10,"رجب کی ستائیسویں شب آپ ﷺ کو براق پر سوار کر کے مسجد حرام سے مسجد اقصیٰ لے جایا گیا، وہاں انبیاء کی امامت فرمائی، پھر ساتوں آسمانوں کی سیر کرائی گئی۔","حضرت جبرائیل علیہ السلام",بیت المقدس و آسمان,"31.7781,35.2354","miraj.jpg","معراج,اسراء,مکی دور,معجزہ"
11,"چھ ہجری میں آپ ﷺ چودہ سو صحابہ کے ہمراہ عمرہ کی نیت سے نکلے، حدیبیہ کے مقام پر قریش نے روکا۔ یہاں ایک معاہدہ طے پایا جو صلح حدیبیہ کہلاتا ہے۔","حضرت عثمان بن عفانؓ;سہیل بن عمرو",حدیبیہ,"21.3000,39.6833","treaty_hudaibiya.jpg","معاہدہ,صلح,مدنی دور"
12,"صلح حدیبیہ کی خلاف ورزی پر آپ ﷺ دس ہزار صحابہ کے ساتھ مکہ روانہ ہوئے۔ بغیر خون خرابے کے مکہ فتح ہوگیا اور عام معافی کا اعلان کیا گیا۔","حضرت عباسؓ;ابو سفیان",مکہ مکرمہ,"21.3891,39.8579","conquest_makkah.jpg","فتح,مکہ,مدنی دور,رحمت"
13,"دس ہجری میں آپ ﷺ نے ایک لاکھ سے زائد صحابہ کے ہمراہ حج ادا فرمایا۔ عرفات کے میدان میں تاریخی خطبہ دیا جو انسانی حقوق کا منشور ہے۔","صحابہ کرام کی کثیر تعداد",عرفات, مکہ,"21.3549,39.9841","farewell_pilgrimage.jpg","حج,خطبہ,مدنی دور,انسانی حقوق"
14,"حجۃ الوداع سے واپسی کے بعد آپ ﷺ بیمار ہوئے اور ١٢ ربیع الاول ١١ ہجری کو مدینہ منورہ میں اپنے رفیق اعلیٰ سے جا ملے۔","حضرت عائشہؓ;حضرت فاطمہؓ;حضرت ابوبکر صدیقؓ",مدینہ منورہ,"24.4686,39.6142","demise.jpg","وفات,مدنی دور,اختتام"`;

            const fallbackHistoryUpdateCSV = `شمار,عیسوی سال (تقریباً),ہجری سال / دور,واقعہ (اردو),مختصر تفصیل (اردو)
5,625,مدنی دور,غزوہ احد,مسلمانوں کو ابتدائی فتح کے بعد کچھ نقصان اٹھانا پڑا۔`;
            const fallbackDetailsUpdateCSV = `شمار,تفصیلی وضاحت,متعلقہ شخصیات,مقام,نقشہ_کوآرڈینیٹس,تصویری_حوالہ,ٹیگز
5,"شوال ٣ ہجری میں احد پہاڑ کے دامن میں یہ جنگ ہوئی۔ ابتدائی کامیابی کے بعد تیر اندازوں کی غلطی سے مسلمانوں کو نقصان ہوا۔ حضرت حمزہؓ شہید ہوئے۔","حضرت حمزہؓ;خالد بن ولید (قبل از اسلام)",احد,"24.5008,39.6125","uhud.jpg","غزوہ,جنگ,مدنی دور,شہادت"`;


            // --- Utility Functions ---
            function parseCSV(csvText) {
                if (!csvText || typeof csvText !== 'string') return [];
                const lines = csvText.trim().split('\n');
                if (lines.length < 2) return []; 
                
                const header = lines[0].split(',').map(h => h.trim());
                const data = [];

                for (let i = 1; i < lines.length; i++) {
                    // More robust CSV parsing to handle commas within quoted fields
                    const values = [];
                    let currentVal = '';
                    let inQuotes = false;
                    for (let char of lines[i]) {
                        if (char === '"') {
                            inQuotes = !inQuotes;
                        } else if (char === ',' && !inQuotes) {
                            values.push(currentVal.trim());
                            currentVal = '';
                        } else {
                            currentVal += char;
                        }
                    }
                    values.push(currentVal.trim()); // Add the last value

                    if (values.length === header.length) {
                        const entry = {};
                        header.forEach((col, index) => {
                            entry[col] = values[index];
                        });
                        data.push(entry);
                    } else {
                        console.warn(`Skipping malformed CSV line (length mismatch: ${values.length} vs ${header.length}): ${lines[i]}`);
                    }
                }
                return data;
            }

            function debounce(func, delay) {
                let timeout;
                return function(...args) {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(this, args), delay);
                };
            }
            
            // --- IndexedDB Functions ---
            async function openDB() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);
                    request.onerror = (event) => reject("Database error: " + event.target.errorCode);
                    request.onsuccess = (event) => {
                        db = event.target.result;
                        resolve(db);
                    };
                    request.onupgradeneeded = (event) => {
                        const storeDb = event.target.result;
                        if (!storeDb.objectStoreNames.contains(STORE_NAME)) {
                            storeDb.createObjectStore(STORE_NAME, { keyPath: KEY_PATH });
                        }
                    };
                });
            }

            async function addDataToDB(data) {
                if (!db) return Promise.reject("DB not initialized");
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    let completedCount = 0;
                    if (!Array.isArray(data)) data = [data];
                    if (data.length === 0) { resolve(); return; }
                    
                    data.forEach(item => {
                        if (typeof item[KEY_PATH] === 'string' && !isNaN(parseInt(item[KEY_PATH]))) {
                           item[KEY_PATH] = parseInt(item[KEY_PATH]);
                        }
                        const request = store.put(item); 
                        request.onsuccess = () => {
                            completedCount++;
                            if (completedCount === data.length) resolve();
                        };
                        request.onerror = (event) => {
                            console.error("Error adding item to DB:", item, event.target.error);
                        };
                    });
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = (event) => reject("Transaction error: " + event.target.error);
                });
            }

            async function getAllDataFromDB() {
                if (!db) return Promise.resolve([]);
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readonly');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.getAll();
                    request.onsuccess = (event) => resolve(event.target.result);
                    request.onerror = (event) => reject("Error fetching all data: " + event.target.error);
                });
            }
            
            async function clearStoreInDB() {
                if (!db) return Promise.reject("DB not initialized");
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction([STORE_NAME], 'readwrite');
                    const store = transaction.objectStore(STORE_NAME);
                    const request = store.clear();
                    request.onsuccess = () => resolve();
                    request.onerror = (event) => reject("Error clearing store: " + event.target.error);
                });
            }

            // --- Data Loading and Processing ---
            async function fetchAndParseCSVWithFallback(url, fallbackData) {
                try {
                    const response = await fetch(url);
                    if (!response.ok) {
                        console.warn(`Failed to fetch ${url} (status: ${response.status}), using fallback data.`);
                        return parseCSV(fallbackData);
                    }
                    const csvText = await response.text();
                    if (!csvText.trim()) { // Check if fetched content is empty
                        console.warn(`Fetched ${url} but content is empty, using fallback data.`);
                        return parseCSV(fallbackData);
                    }
                    return parseCSV(csvText);
                } catch (error) {
                    console.warn(`Error fetching ${url}: ${error}. Using fallback data.`);
                    return parseCSV(fallbackData);
                }
            }
            
            function enrichEventData(historyEvents, detailEvents) {
                const detailsMap = new Map();
                detailEvents.forEach(detail => {
                    detailsMap.set(String(detail['شمار']), detail);
                });

                return historyEvents.map(event => {
                    const detail = detailsMap.get(String(event['شمار']));
                    if (detail) {
                        return {
                            ...event,
                            ...detail,
                            'شمار': parseInt(event['شمار']),
                            'متعلقہ شخصیات': detail['متعلقہ شخصیات'] ? detail['متعلقہ شخصیات'].split(';').map(p => p.trim()) : [], 
                            'ٹیگز': detail['ٹیگز'] ? detail['ٹیگز'].split(',').map(t => t.trim()) : []
                        };
                    }
                    return {
                        ...event,
                        'شمار': parseInt(event['شمار']),
                        'تفصیلی وضاحت': event['مختصر تفصیل (اردو)'],
                        'متعلقہ شخصیات': [], 'مقام': 'نامعلوم', 'نقشہ_کوآرڈینیٹس': '',
                        'تصویری_حوالہ': '', 'ٹیگز': []
                    };
                }).filter(event => event['واقعہ (اردو)']); 
            }

            async function loadInitialData() {
                showLoading(true);
                try {
                    const existingEvents = await getAllDataFromDB();
                    if (existingEvents.length === 0) {
                        console.log("IndexedDB is empty. Attempting to fetch initial data from CSV files...");
                        // Attempt to fetch from local CSV files. These files (history.csv, details.csv)
                        // should be in the same directory as the HTML file.
                        const historyEvents = await fetchAndParseCSVWithFallback('history.csv', fallbackHistoryCSV);
                        const detailEvents = await fetchAndParseCSVWithFallback('details.csv', fallbackDetailsCSV);
                        
                        if (historyEvents.length === 0) {
                            console.error("Failed to load primary history data from fetch or fallback.");
                            showToast("بنیادی تاریخی ڈیٹا لوڈ کرنے میں ناکامی!", "error");
                            showLoading(false);
                            return;
                        }

                        const enrichedEvents = enrichEventData(historyEvents, detailEvents);
                        await addDataToDB(enrichedEvents);
                        console.log("Initial data loaded and enriched.");
                        showToast("ابتدائی ڈیٹا کامیابی سے لوڈ ہوگیا۔", "success");
                    } else {
                        console.log("Data already exists in IndexedDB.");
                    }
                    await loadUpdateData(); 
                } catch (error) {
                    console.error("Error during initial data load:", error);
                    showToast("ڈیٹا لوڈنگ میں خرابی: " + error.message, "error");
                } finally {
                    await refreshAllDataAndViews();
                    showLoading(false);
                }
            }

            async function loadUpdateData() {
                console.log("Attempting to fetch update data (historyupdate.csv, detailsupdate.csv)...");
                try {
                    const updateHistoryEventsRaw = await fetchAndParseCSVWithFallback('historyupdate.csv', fallbackHistoryUpdateCSV);
                    const updateDetailEventsRaw = await fetchAndParseCSVWithFallback('detailsupdate.csv', fallbackDetailsUpdateCSV);

                    if (updateHistoryEventsRaw && updateHistoryEventsRaw.length > 0) {
                        const updateEvents = enrichEventData(updateHistoryEventsRaw, updateDetailEventsRaw);
                        await addDataToDB(updateEvents); 
                        console.log(`${updateEvents.length} events from update files/fallbacks processed.`);
                        showToast(`${updateEvents.length} اپڈیٹس شامل کی گئیں۔`, "success");
                    } else {
                        console.log("No new updates found in update files or fallbacks.");
                    }
                } catch (error) {
                    console.error("Error loading update data:", error);
                    showToast("اپڈیٹ ڈیٹا لوڈ کرنے میں خرابی: " + error.message, "error");
                }
            }
            
            async function refreshAllDataAndViews() {
                allEvents = await getAllDataFromDB();
                allEvents.sort((a, b) => (parseInt(a['عیسوی سال (تقریباً)']) || 0) - (parseInt(b['عیسوی سال (تقریباً)']) || 0)); 
                populateFilterOptions();
                applyFiltersAndRender(); 
            }

            // --- UI Rendering Functions ---
            function renderEventCard(event) {
                const card = document.createElement('div');
                card.className = 'event-card';
                card.innerHTML = `
                    <h3>${event['واقعہ (اردو)'] || 'N/A'}</h3>
                    <p class="meta-info"><strong>عیسوی سال:</strong> ${event['عیسوی سال (تقریباً)'] || 'N/A'} | <strong>ہجری سال / دور:</strong> ${event['ہجری سال / دور'] || 'N/A'}</p>
                    <p>${event['مختصر تفصیل (اردو)'] || 'کوئی مختصر تفصیل دستیاب نہیں'}</p>
                    <button class="details-button" data-id="${event['شمار']}" aria-label="واقعہ ${event['واقعہ (اردو)']} کی مزید تفصیلات دیکھیں">مزید تفصیلات</button>
                `;
                card.querySelector('.details-button').addEventListener('click', () => showEventModal(event['شمار']));
                return card;
            }

            function renderPaginatedEventList(eventsToRender) {
                eventListView.innerHTML = ''; 
                const startIndex = (currentPage - 1) * ITEMS_PER_PAGE;
                const endIndex = startIndex + ITEMS_PER_PAGE;
                const paginatedItems = eventsToRender.slice(startIndex, endIndex);

                if (paginatedItems.length === 0) {
                    emptyStateMessages.eventList.style.display = 'block';
                } else {
                    emptyStateMessages.eventList.style.display = 'none';
                    const fragment = document.createDocumentFragment();
                    paginatedItems.forEach(event => {
                        fragment.appendChild(renderEventCard(event));
                    });
                    eventListView.appendChild(fragment);
                }
                renderPaginationControls(eventsToRender.length);
            }
            
            function renderPaginationControls(totalItems) {
                paginationControlsContainer.innerHTML = '';
                if (totalItems <= ITEMS_PER_PAGE && currentPage === 1) return; // No controls if only one page or no items

                const totalPages = Math.ceil(totalItems / ITEMS_PER_PAGE);
                if (totalPages === 0 && totalItems > 0) { // Should not happen if ITEMS_PER_PAGE > 0
                     console.warn("Total pages is 0 but totalItems > 0. Check ITEMS_PER_PAGE.");
                     return;
                }
                 if (totalPages === 1 && totalItems > 0) return; // Also no controls for a single page

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'pagination-controls';

                const prevButton = document.createElement('button');
                prevButton.textContent = 'گزشتہ';
                prevButton.disabled = currentPage === 1;
                prevButton.setAttribute('aria-label', 'پچھلا صفحہ');
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        applyFiltersAndRender();
                        // Focus on the first card of the new page for accessibility
                        setTimeout(() => {
                            const firstCard = eventListView.querySelector('.event-card .details-button');
                            if (firstCard) firstCard.focus();
                        }, 100);
                    }
                });

                const nextButton = document.createElement('button');
                nextButton.textContent = 'اگلا';
                nextButton.disabled = currentPage === totalPages || totalPages === 0;
                nextButton.setAttribute('aria-label', 'اگلا صفحہ');
                nextButton.addEventListener('click', () => {
                    if (currentPage < totalPages) {
                        currentPage++;
                        applyFiltersAndRender();
                        setTimeout(() => {
                            const firstCard = eventListView.querySelector('.event-card .details-button');
                            if (firstCard) firstCard.focus();
                        }, 100);
                    }
                });

                const pageInfo = document.createElement('span');
                pageInfo.className = 'page-info';
                pageInfo.textContent = totalPages > 0 ? `صفحہ ${currentPage} از ${totalPages}` : `صفحہ 0 از 0`;
                
                const pageNumberDiv = document.createElement('div');
                pageNumberDiv.className = 'page-number-container';

                // Logic for displaying page numbers (e.g., 1 ... 5 6 7 ... 10)
                const maxPagesToShow = 5; // Max number of direct page links
                let startPage, endPage;
                if (totalPages <= maxPagesToShow) {
                    startPage = 1;
                    endPage = totalPages;
                } else {
                    const maxPagesBeforeCurrent = Math.floor(maxPagesToShow / 2);
                    const maxPagesAfterCurrent = Math.ceil(maxPagesToShow / 2) - 1;
                    if (currentPage <= maxPagesBeforeCurrent) {
                        startPage = 1;
                        endPage = maxPagesToShow;
                    } else if (currentPage + maxPagesAfterCurrent >= totalPages) {
                        startPage = totalPages - maxPagesToShow + 1;
                        endPage = totalPages;
                    } else {
                        startPage = currentPage - maxPagesBeforeCurrent;
                        endPage = currentPage + maxPagesAfterCurrent;
                    }
                }

                if (startPage > 1) {
                    pageNumberDiv.appendChild(createPageNumberButton(1));
                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        ellipsis.className = 'page-number';
                        ellipsis.style.cursor = 'default';
                        pageNumberDiv.appendChild(ellipsis);
                    }
                }

                for (let i = startPage; i <= endPage; i++) {
                    if (i > 0) pageNumberDiv.appendChild(createPageNumberButton(i));
                }

                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                         const ellipsis = document.createElement('span');
                        ellipsis.textContent = '...';
                        ellipsis.className = 'page-number';
                        ellipsis.style.cursor = 'default';
                        pageNumberDiv.appendChild(ellipsis);
                    }
                    pageNumberDiv.appendChild(createPageNumberButton(totalPages));
                }


                controlsDiv.appendChild(prevButton);
                controlsDiv.appendChild(pageNumberDiv);
                controlsDiv.appendChild(pageInfo);
                controlsDiv.appendChild(nextButton);
                paginationControlsContainer.appendChild(controlsDiv);
            }

            function createPageNumberButton(page) {
                const pageButton = document.createElement('span');
                pageButton.textContent = page;
                pageButton.className = 'page-number';
                pageButton.setAttribute('role', 'button');
                pageButton.setAttribute('tabindex', '0');
                pageButton.setAttribute('aria-label', `صفحہ ${page} پر جائیں`);
                if (page === currentPage) {
                    pageButton.classList.add('active');
                    pageButton.setAttribute('aria-current', 'page');
                }
                pageButton.addEventListener('click', () => {
                    currentPage = page;
                    applyFiltersAndRender();
                     setTimeout(() => {
                        const firstCard = eventListView.querySelector('.event-card .details-button');
                        if (firstCard) firstCard.focus();
                    }, 100);
                });
                pageButton.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        currentPage = page;
                        applyFiltersAndRender();
                         setTimeout(() => {
                            const firstCard = eventListView.querySelector('.event-card .details-button');
                            if (firstCard) firstCard.focus();
                        }, 100);
                    }
                });
                return pageButton;
            }


            function showEventModal(eventId) {
                const event = allEvents.find(e => e['شمار'] === eventId);
                if (!event) return;

                document.getElementById('modalTitle').textContent = event['واقعہ (اردو)'] || 'N/A';
                document.getElementById('modalGregorianYear').textContent = event['عیسوی سال (تقریباً)'] || 'N/A';
                document.getElementById('modalHijriYear').textContent = event['ہجری سال / دور'] || 'N/A';
                document.getElementById('modalShortDescription').textContent = event['مختصر تفصیل (اردو)'] || 'N/A';
                document.getElementById('modalDetailedExplanation').textContent = event['تفصیلی وضاحت'] || 'N/A';
                document.getElementById('modalPersonalities').textContent = Array.isArray(event['متعلقہ شخصیات']) ? event['متعلقہ شخصیات'].join('، ') : 'N/A';
                document.getElementById('modalLocation').textContent = event['مقام'] || 'N/A';
                document.getElementById('modalCoordinates').textContent = event['نقشہ_کوآرڈینیٹس'] || 'N/A';
                
                const tagsContainer = document.getElementById('modalTags');
                tagsContainer.innerHTML = '';
                if (Array.isArray(event['ٹیگز']) && event['ٹیگز'].length > 0) {
                    event['ٹیگز'].forEach(tagText => {
                        const tagEl = document.createElement('span');
                        tagEl.className = 'tag';
                        tagEl.textContent = tagText;
                        tagsContainer.appendChild(tagEl);
                    });
                } else {
                    tagsContainer.textContent = 'N/A';
                }
                
                document.getElementById('modalImageRef').textContent = event['تصویری_حوالہ'] || 'N/A';
                modal.style.display = 'block';
                modal.querySelector('.close-button').focus(); 
            }
            
            function populateFilterOptions() {
                const periods = new Set();
                const tags = new Set();
                allEvents.forEach(event => {
                    if (event['ہجری سال / دور']) periods.add(event['ہجری سال / دور']);
                    if (Array.isArray(event['ٹیگز'])) {
                        event['ٹیگز'].forEach(tag => tags.add(tag));
                    }
                });

                periodFilter.innerHTML = '<option value="">تمام ادوار</option>';
                Array.from(periods).sort().forEach(p => {
                    const option = document.createElement('option');
                    option.value = p;
                    option.textContent = p;
                    periodFilter.appendChild(option);
                });

                tagFilter.innerHTML = '<option value="">تمام ٹیگز</option>';
                Array.from(tags).sort().forEach(t => {
                    const option = document.createElement('option');
                    option.value = t;
                    option.textContent = t;
                    tagFilter.appendChild(option);
                });
            }
            
            function applyFiltersAndRender() {
                let filteredEvents = allEvents;

                if (currentFilters.searchTerm) {
                    const term = currentFilters.searchTerm.toLowerCase();
                    filteredEvents = filteredEvents.filter(event => 
                        (event['واقعہ (اردو)'] && event['واقعہ (اردو)'].toLowerCase().includes(term)) ||
                        (event['مختصر تفصیل (اردو)'] && event['مختصر تفصیل (اردو)'].toLowerCase().includes(term)) ||
                        (event['تفصیلی وضاحت'] && event['تفصیلی وضاحت'].toLowerCase().includes(term)) ||
                        (Array.isArray(event['متعلقہ شخصیات']) && event['متعلقہ شخصیات'].some(p => p.toLowerCase().includes(term))) ||
                        (Array.isArray(event['ٹیگز']) && event['ٹیگز'].some(t => t.toLowerCase().includes(term)))
                    );
                }

                if (currentFilters.period) {
                    filteredEvents = filteredEvents.filter(event => event['ہجری سال / دور'] === currentFilters.period);
                }

                if (currentFilters.tag) {
                    filteredEvents = filteredEvents.filter(event => Array.isArray(event['ٹیگز']) && event['ٹیگز'].includes(currentFilters.tag));
                }
                if (currentFilters.gregorianYear) {
                    filteredEvents = filteredEvents.filter(event => String(event['عیسوی سال (تقریباً)']) === String(currentFilters.gregorianYear));
                }
                if (currentFilters.location) {
                     filteredEvents = filteredEvents.filter(event => event['مقام'] === currentFilters.location);
                }
                
                // Reset to page 1 if filters change, except when it's just a page change itself
                // This logic is handled by resetting currentPage before calling this in filter handlers

                // Render content based on active tab
                if (activeTab === 'eventListViewContainer') {
                    renderPaginatedEventList(filteredEvents);
                } else if (activeTab === 'timelineView') {
                    renderTimeline(filteredEvents);
                } else if (activeTab === 'chartsView') {
                    renderCharts(filteredEvents);
                } else if (activeTab === 'mapView') {
                    renderMap(filteredEvents);
                } else if (activeTab === 'personalitiesView') {
                    renderPersonalitiesView(filteredEvents);
                } else if (activeTab === 'groupsView') {
                    renderGroupsView(filteredEvents); // Pass all events for grouping, then filter display if needed
                }
            }

            function showLoading(isLoading) {
                loadingIndicator.style.display = isLoading ? 'block' : 'none';
            }

            function showToast(message, type = 'info') { 
                const toast = document.createElement('div');
                toast.className = `toast-message ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                
                // Trigger reflow for transition
                toast.offsetHeight; 

                toast.classList.add('show');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => {
                        toast.remove();
                    }, 500); // Wait for fade out transition
                }, 3000);
            }

            // --- Visualization Functions (SVG) ---
            function renderTimeline(eventsToRender) {
                timelineSvg.innerHTML = ''; 
                if (eventsToRender.length === 0) {
                    emptyStateMessages.timeline.style.display = 'block';
                    return;
                }
                emptyStateMessages.timeline.style.display = 'none';

                const width = timelineSvg.clientWidth || 1000; 
                const height = 400;
                const margin = { top: 40, right: 50, bottom: 70, left: 70 }; // Adjusted for RTL labels
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;

                const years = eventsToRender.map(e => parseInt(e['عیسوی سال (تقریباً)'])).filter(y => !isNaN(y));
                if (years.length === 0) {
                     timelineSvg.innerHTML = '<text x="50%" y="50%" class="axis" text-anchor="middle" fill="var(--text-color)">ٹائم لائن کے لیے سال کا ڈیٹا دستیاب نہیں۔</text>';
                     return;
                }
                const minYear = Math.min(...years);
                const maxYear = Math.max(...years);

                const xScale = (year) => {
                    if (maxYear === minYear) return innerWidth / 2; 
                    return ((year - minYear) / (maxYear - minYear)) * innerWidth;
                };

                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("transform", `translate(${margin.left},${margin.top})`);
                g.classList.add("axis");
                timelineSvg.appendChild(g);

                const xAxisLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                xAxisLine.setAttribute("x1", 0);
                xAxisLine.setAttribute("y1", innerHeight);
                xAxisLine.setAttribute("x2", innerWidth);
                xAxisLine.setAttribute("y2", innerHeight);
                g.appendChild(xAxisLine);

                const numTicks = Math.min(10, (maxYear - minYear) > 0 ? (maxYear - minYear + 1) : 1);
                const tickYears = new Set(); // To avoid duplicate ticks if range is small

                for (let i = 0; i <= numTicks; i++) {
                    const year = Math.round(minYear + i * (maxYear - minYear) / numTicks);
                    if(tickYears.has(year) && (maxYear - minYear > 0)) continue; // Skip if already added and not single year
                    tickYears.add(year);

                    const xPos = xScale(year);
                    
                    const tickMark = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    tickMark.setAttribute("x1", xPos);
                    tickMark.setAttribute("y1", innerHeight);
                    tickMark.setAttribute("x2", xPos);
                    tickMark.setAttribute("y2", innerHeight + 6);
                    g.appendChild(tickMark);

                    const yearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    yearLabel.setAttribute("x", xPos);
                    yearLabel.setAttribute("y", innerHeight + 25);
                    yearLabel.setAttribute("text-anchor", "middle");
                    yearLabel.textContent = year;
                    g.appendChild(yearLabel);
                }
                const axisTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
                axisTitle.setAttribute("x", innerWidth / 2);
                axisTitle.setAttribute("y", innerHeight + 50);
                axisTitle.setAttribute("text-anchor", "middle");
                axisTitle.textContent = "عیسوی سال";
                g.appendChild(axisTitle);

                const eventMarkersGroup = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.appendChild(eventMarkersGroup);

                eventsToRender.forEach((event, index) => {
                    const year = parseInt(event['عیسوی سال (تقریباً)']);
                    if (isNaN(year)) return;

                    const cx = xScale(year);
                    const baseCy = innerHeight - 30;
                    const yOffset = (index % 7) * 12; // Stagger more vertically
                    const cy = baseCy - yOffset; 
                    const radius = 6; 

                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", cx);
                    circle.setAttribute("cy", cy);
                    circle.setAttribute("r", radius);
                    circle.setAttribute("fill", "var(--accent-color)");
                    circle.classList.add("timeline-event-marker");
                    circle.dataset.id = event['شمار'];
                    
                    circle.addEventListener('mouseover', (e) => {
                        tooltip.innerHTML = `<strong>${event['واقعہ (اردو)']}</strong><br>${event['عیسوی سال (تقریباً)']} / ${event['ہجری سال / دور']}`;
                        tooltip.style.opacity = '1';
                        let tooltipX = e.pageX - tooltip.offsetWidth - 15;
                        if (tooltipX < 0) tooltipX = e.pageX + 15; // Adjust if too far left
                        tooltip.style.left = tooltipX + 'px'; 
                        tooltip.style.top = (e.pageY + 15) + 'px';
                    });
                    circle.addEventListener('mouseout', () => {
                        tooltip.style.opacity = '0';
                    });
                    circle.addEventListener('click', () => showEventModal(event['شمار']));
                    eventMarkersGroup.appendChild(circle);
                });
            }
            
            function renderBarChart(svgElement, data, title, dataLabelKey, dataValueKey) {
                svgElement.innerHTML = ''; 
                if (data.length === 0) {
                    emptyStateMessages.charts.style.display = 'block'; // Assuming this is a general empty state for charts tab
                    svgElement.innerHTML = `<text x="50%" y="50%" class="axis" text-anchor="middle" fill="var(--text-color)">${title} کے لیے ڈیٹا نہیں۔</text>`;
                    return;
                }
                 emptyStateMessages.charts.style.display = 'none';


                const width = svgElement.clientWidth || 500;
                const height = 350;
                const margin = { top: 40, right: 30, bottom: 100, left: 60 }; 
                const innerWidth = width - margin.left - margin.right;
                const innerHeight = height - margin.top - margin.bottom;

                const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
                g.setAttribute("transform", `translate(${margin.left},${margin.top})`);
                g.classList.add("axis");
                svgElement.appendChild(g);

                const maxValue = Math.max(...data.map(d => d[dataValueKey]));
                const barWidth = Math.max(10, innerWidth / data.length * 0.7); // Ensure min width
                const barSpacing = innerWidth / data.length * 0.3;

                // Y-axis (Value)
                const yScale = (value) => innerHeight - (value / maxValue) * innerHeight;
                
                // Draw Y-axis line and ticks
                const yAxisLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
                yAxisLine.setAttribute("x1", 0); yAxisLine.setAttribute("y1", 0);
                yAxisLine.setAttribute("x2", 0); yAxisLine.setAttribute("y2", innerHeight);
                g.appendChild(yAxisLine);

                const numYTicks = 5;
                for(let i=0; i<=numYTicks; i++) {
                    const tickValue = Math.round((maxValue / numYTicks) * i);
                    const yPos = yScale(tickValue);
                    const yTick = document.createElementNS("http://www.w3.org/2000/svg", "line");
                    yTick.setAttribute("x1", -5); yTick.setAttribute("y1", yPos);
                    yTick.setAttribute("x2", 0); yTick.setAttribute("y2", yPos);
                    g.appendChild(yTick);
                    const yLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    yLabel.setAttribute("x", -10); yLabel.setAttribute("y", yPos + 4);
                    yLabel.setAttribute("text-anchor", "end");
                    yLabel.textContent = tickValue;
                    g.appendChild(yLabel);
                }


                data.forEach((d, i) => {
                    const barHeight = Math.max(1, (d[dataValueKey] / maxValue) * innerHeight); // Min height 1px
                    const x = i * (barWidth + barSpacing);
                    const y = innerHeight - barHeight;

                    const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                    rect.setAttribute("x", x);
                    rect.setAttribute("y", y);
                    rect.setAttribute("width", barWidth);
                    rect.setAttribute("height", barHeight);
                    rect.setAttribute("fill", "var(--accent-color)");
                    rect.addEventListener('mouseover', (e) => {
                        tooltip.innerHTML = `<strong>${d[dataLabelKey]}</strong>: ${d[dataValueKey]}`;
                        tooltip.style.opacity = '1';
                        let tooltipX = e.pageX - tooltip.offsetWidth - 15;
                        if (tooltipX < 0) tooltipX = e.pageX + 15;
                        tooltip.style.left = tooltipX + 'px';
                        tooltip.style.top = (e.pageY + 15) + 'px';
                    });
                    rect.addEventListener('mouseout', () => {
                        tooltip.style.opacity = '0';
                    });
                    g.appendChild(rect);
                    
                    const catLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    catLabel.setAttribute("x", x + barWidth / 2);
                    catLabel.setAttribute("y", innerHeight + 20);
                    catLabel.setAttribute("text-anchor", "middle");
                    catLabel.style.fontSize = "11px";
                    // Rotate labels if too many or long
                    if (data.length > 7 || d[dataLabelKey].length > 10) {
                         catLabel.setAttribute("transform", `rotate(-45, ${x + barWidth / 2}, ${innerHeight + 20}) translate(0, 10)`);
                         catLabel.setAttribute("text-anchor", "end");
                    }
                    catLabel.textContent = d[dataLabelKey];
                    g.appendChild(catLabel);
                });

                const chartTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
                chartTitle.setAttribute("x", width / 2);
                chartTitle.setAttribute("y", margin.top / 2 + 5);
                chartTitle.setAttribute("text-anchor", "middle");
                chartTitle.style.fontWeight = "bold";
                chartTitle.style.fill = "var(--accent-color)";
                chartTitle.textContent = title;
                svgElement.appendChild(chartTitle);
            }


            function renderCharts(eventsToRender) {
                if (eventsToRender.length === 0) {
                    emptyStateMessages.charts.style.display = 'block';
                    tagsChartSvg.innerHTML = '';
                    periodsChartSvg.innerHTML = '';
                    return;
                }
                emptyStateMessages.charts.style.display = 'none';

                const tagCounts = {};
                eventsToRender.forEach(event => {
                    if (Array.isArray(event['ٹیگز'])) {
                        event['ٹیگز'].forEach(tag => {
                            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                        });
                    }
                });
                const tagData = Object.entries(tagCounts).map(([tag, count]) => ({ tag, count })).sort((a,b) => b.count - a.count).slice(0,12); 
                renderBarChart(tagsChartSvg, tagData, "ٹاپ 12 ٹیگز", "tag", "count");

                const periodCounts = {};
                eventsToRender.forEach(event => {
                    const period = event['ہجری سال / دور'] || 'نامعلوم';
                    periodCounts[period] = (periodCounts[period] || 0) + 1;
                });
                const periodData = Object.entries(periodCounts).map(([period, count]) => ({ period, count })).sort((a,b) => b.count - a.count);
                renderBarChart(periodsChartSvg, periodData, "ادوار کے لحاظ سے تقسیم", "period", "count");
            }
            
            function renderMap(eventsToRender) {
                mapLocationList.innerHTML = ''; 
                const eventsWithCoords = eventsToRender.filter(e => e['مقام'] && e['مقام'] !== 'نامعلوم' && e['نقشہ_کوآرڈینیٹس']);
                
                if (eventsWithCoords.length === 0) {
                    emptyStateMessages.map.style.display = 'block';
                    return;
                }
                emptyStateMessages.map.style.display = 'none';

                eventsWithCoords.forEach(event => {
                    const listItem = document.createElement('li');
                    listItem.innerHTML = `<strong>${event['واقعہ (اردو)']}</strong>: ${event['مقام']} (${event['نقشہ_کوآرڈینیٹس']})`;
                    listItem.setAttribute('role', 'button');
                    listItem.setAttribute('tabindex', '0');
                    listItem.addEventListener('click', () => showEventModal(event['شمار']));
                     listItem.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' || e.key === ' ') showEventModal(event['شمار']);
                    });
                    mapLocationList.appendChild(listItem);
                });
            }

            function renderPersonalitiesView(eventsToRender) {
                personalitiesListContainer.innerHTML = '';
                const personalityMap = new Map();

                eventsToRender.forEach(event => {
                    if (Array.isArray(event['متعلقہ شخصیات'])) {
                        event['متعلقہ شخصیات'].forEach(person => {
                            if(person.trim() === "") return; // Skip empty personality strings
                            if (!personalityMap.has(person)) {
                                personalityMap.set(person, []);
                            }
                            personalityMap.get(person).push({
                                id: event['شمار'],
                                name: event['واقعہ (اردو)']
                            });
                        });
                    }
                });

                if (personalityMap.size === 0) {
                    emptyStateMessages.personalities.style.display = 'block';
                    return;
                }
                emptyStateMessages.personalities.style.display = 'none';

                const sortedPersonalities = Array.from(personalityMap.keys()).sort((a,b) => a.localeCompare(b, 'ur'));

                sortedPersonalities.forEach(person => {
                    const personDiv = document.createElement('div');
                    personDiv.className = 'personality-entry';
                    const personHeader = document.createElement('h5');
                    personHeader.textContent = person;
                    personDiv.appendChild(personHeader);

                    const eventListUl = document.createElement('ul');
                    personalityMap.get(person).forEach(eventInfo => {
                        const eventLi = document.createElement('li');
                        const link = document.createElement('a');
                        link.href = "#";
                        link.dataset.eventId = eventInfo.id;
                        link.textContent = eventInfo.name;
                        link.addEventListener('click', (e) => {
                            e.preventDefault();
                            showEventModal(eventInfo.id);
                        });
                        eventLi.appendChild(link);
                        eventListUl.appendChild(eventLi);
                    });
                    personDiv.appendChild(eventListUl);
                    personalitiesListContainer.appendChild(personDiv);
                });
            }

            function renderGroupsView(allAvailableEvents) {
                // Clear previous groups
                periodGroupsList.innerHTML = '';
                yearGroupsList.innerHTML = '';
                locationGroupsList.innerHTML = '';
                tagGroupsList.innerHTML = '';

                if (allAvailableEvents.length === 0) {
                    emptyStateMessages.groups.style.display = 'block';
                    return;
                }
                emptyStateMessages.groups.style.display = 'none';

                const periods = new Map();
                const years = new Map();
                const locations = new Map();
                const tags = new Map();

                allAvailableEvents.forEach(event => {
                    // Period groups
                    const period = event['ہجری سال / دور'] || 'نامعلوم';
                    periods.set(period, (periods.get(period) || 0) + 1);

                    // Year groups
                    const year = event['عیسوی سال (تقریباً)'] || 'نامعلوم';
                    years.set(year, (years.get(year) || 0) + 1);
                    
                    // Location groups
                    const location = event['مقام'] || 'نامعلوم';
                    if (location !== 'نامعلوم') { // Only group valid locations
                        locations.set(location, (locations.get(location) || 0) + 1);
                    }

                    // Tag groups
                    if (Array.isArray(event['ٹیگز'])) {
                        event['ٹیگز'].forEach(tag => {
                            tags.set(tag, (tags.get(tag) || 0) + 1);
                        });
                    }
                });

                // Populate Period Groups
                Array.from(periods.entries()).sort((a,b) => a[0].localeCompare(b[0],'ur')).forEach(([name, count]) => {
                    const li = document.createElement('li');
                    li.textContent = `${name} (${count})`;
                    li.dataset.filterType = 'period';
                    li.dataset.filterValue = name;
                    li.setAttribute('role', 'button');
                    li.setAttribute('tabindex', '0');
                    periodGroupsList.appendChild(li);
                });

                // Populate Year Groups
                Array.from(years.entries()).sort((a,b) => parseInt(a[0]) - parseInt(b[0])).forEach(([name, count]) => {
                    const li = document.createElement('li');
                    li.textContent = `${name} (${count})`;
                    li.dataset.filterType = 'gregorianYear';
                    li.dataset.filterValue = name;
                    li.setAttribute('role', 'button');
                    li.setAttribute('tabindex', '0');
                    yearGroupsList.appendChild(li);
                });
                
                // Populate Location Groups
                Array.from(locations.entries()).sort((a,b) => a[0].localeCompare(b[0],'ur')).forEach(([name, count]) => {
                    const li = document.createElement('li');
                    li.textContent = `${name} (${count})`;
                    li.dataset.filterType = 'location';
                    li.dataset.filterValue = name;
                    li.setAttribute('role', 'button');
                    li.setAttribute('tabindex', '0');
                    locationGroupsList.appendChild(li);
                });

                // Populate Tag Groups
                Array.from(tags.entries()).sort((a,b) => a[0].localeCompare(b[0],'ur')).forEach(([name, count]) => {
                    const li = document.createElement('li');
                    li.textContent = `${name} (${count})`;
                    li.dataset.filterType = 'tag';
                    li.dataset.filterValue = name;
                    li.setAttribute('role', 'button');
                    li.setAttribute('tabindex', '0');
                    tagGroupsList.appendChild(li);
                });
                
                // Add event listeners to group items
                document.querySelectorAll('#groupsView ul li').forEach(item => {
                    item.addEventListener('click', handleGroupFilterClick);
                    item.addEventListener('keypress', (e) => {
                         if (e.key === 'Enter' || e.key === ' ') handleGroupFilterClick(e);
                    });
                });
            }


            // --- Event Handlers ---
            function handleSearch() {
                currentFilters.searchTerm = searchInput.value;
                currentFilters.period = ''; // Reset other filters when searching broadly
                currentFilters.tag = '';
                currentFilters.gregorianYear = '';
                currentFilters.location = '';
                periodFilter.value = '';
                tagFilter.value = '';
                currentPage = 1;
                applyFiltersAndRender();
            }

            function handleMainFilterChange() {
                currentFilters.period = periodFilter.value;
                currentFilters.tag = tagFilter.value;
                currentFilters.searchTerm = ''; // Clear search when using dropdown filters
                currentFilters.gregorianYear = ''; // Clear group-specific filters
                currentFilters.location = '';
                searchInput.value = '';
                currentPage = 1;
                applyFiltersAndRender();
            }

            function handleGroupFilterClick(event) {
                const target = event.target.closest('li');
                if (!target) return;

                const filterType = target.dataset.filterType;
                const filterValue = target.dataset.filterValue;

                // Reset all filters first
                currentFilters.searchTerm = ''; searchInput.value = '';
                currentFilters.period = ''; periodFilter.value = '';
                currentFilters.tag = ''; tagFilter.value = '';
                currentFilters.gregorianYear = '';
                currentFilters.location = '';

                // Apply the specific group filter
                if (filterType === 'period') currentFilters.period = filterValue;
                else if (filterType === 'tag') currentFilters.tag = filterValue;
                else if (filterType === 'gregorianYear') currentFilters.gregorianYear = filterValue;
                else if (filterType === 'location') currentFilters.location = filterValue;
                
                currentPage = 1;
                // Switch to event list view and apply filters
                document.querySelector('.tab-button[data-tab="eventListViewContainer"]').click();
                // applyFiltersAndRender will be called by the tab click handler
            }
            
            function handleTabClick(event) {
                const clickedTabButton = event.target.closest('.tab-button');
                if (!clickedTabButton) return;

                document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

                clickedTabButton.classList.add('active');
                activeTab = clickedTabButton.dataset.tab;
                document.getElementById(activeTab).classList.add('active');
                
                // Reset page to 1 when changing tabs, unless it's a group filter navigating to event list
                if (event.isTrusted) { // Only reset if it's a direct user click, not programmatic
                    currentPage = 1;
                     // Clear specific group filters when navigating away from groups or to a new general view
                    currentFilters.gregorianYear = '';
                    currentFilters.location = '';
                }
                
                applyFiltersAndRender(); 
            }

            function handleThemeToggle() {
                document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
                // Re-render visualizations as colors might have changed.
                // This will be handled by applyFiltersAndRender if the active tab has visualizations.
                if (activeTab === 'timelineView' || activeTab === 'chartsView') {
                    applyFiltersAndRender();
                }
            }
            
            async function handleBackup() {
                try {
                    const dataToBackup = await getAllDataFromDB();
                    if (dataToBackup.length === 0) {
                        showToast("بیک اپ کے لیے کوئی ڈیٹا موجود نہیں۔", "info");
                        return;
                    }
                    const jsonData = JSON.stringify(dataToBackup, null, 2);
                    const blob = new Blob([jsonData], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    const date = new Date().toISOString().slice(0,10);
                    a.download = `seerah_events_backup_${date}_YasinUllah.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    showToast("ڈیٹا کامیابی سے بیک اپ ہوگیا۔", "success");
                    restoreStatus.textContent = "آخری بیک اپ: ابھی";
                } catch (error) {
                    console.error("Backup error:", error);
                    showToast("بیک اپ میں خرابی: " + error.message, "error");
                    restoreStatus.textContent = "بیک اپ میں خرابی۔";
                }
            }

            async function handleRestore(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = async (e) => {
                    try {
                        const jsonData = e.target.result;
                        const dataToRestore = JSON.parse(jsonData);
                        
                        if (!Array.isArray(dataToRestore) || dataToRestore.some(item => typeof item[KEY_PATH] === 'undefined')) {
                             throw new Error("غلط فائل فارمیٹ یا کلیدی راستہ 'شمار' غائب ہے۔");
                        }

                        await clearStoreInDB(); 
                        await addDataToDB(dataToRestore);
                        await refreshAllDataAndViews(); // This reloads allEvents and re-renders
                        showToast("ڈیٹا کامیابی سے بحال ہوگیا۔", "success");
                        restoreStatus.textContent = `کامیابی سے بحال کیا گیا: ${file.name}`;
                    } catch (error) {
                        console.error("Restore error:", error);
                        showToast("ڈیٹا بحال کرنے میں خرابی: " + error.message, "error");
                        restoreStatus.textContent = "بحالی میں خرابی: " + error.message;
                    } finally {
                        restoreFileInput.value = ''; 
                    }
                };
                reader.readAsText(file);
            }

            // --- Initialization ---
            async function initApp() {
                const savedTheme = localStorage.getItem('theme');
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                }
                
                try {
                    await openDB();
                    await loadInitialData(); 
                } catch (error) {
                    console.error("App initialization failed:", error);
                    showToast("ایپلیکیشن شروع کرنے میں ناکامی: " + error.message, "error");
                    showLoading(false);
                    const mainContainer = document.querySelector('.container');
                    if (mainContainer) {
                        mainContainer.innerHTML = `<p style="color: var(--danger-bg); text-align: center; padding: 20px;">ایپلیکیشن شروع نہیں ہو سکی۔ ڈیٹا بیس تک رسائی میں مسئلہ ہے۔ براہ کرم یقینی بنائیں کہ آپ کا براؤزر IndexedDB کو سپورٹ کرتا ہے اور پرائیویٹ موڈ میں نہیں ہے۔</p>`;
                    }
                    return; 
                }

                themeToggle.addEventListener('click', handleThemeToggle);
                searchInput.addEventListener('input', debounce(handleSearch, 300));
                periodFilter.addEventListener('change', handleMainFilterChange);
                tagFilter.addEventListener('change', handleMainFilterChange);

                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', handleTabClick);
                });
                
                modalCloseButton.addEventListener('click', () => modal.style.display = 'none');
                modalCloseButton.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') modal.style.display = 'none';
                });
                window.addEventListener('click', (event) => {
                    if (event.target == modal) {
                        modal.style.display = 'none';
                    }
                });
                 window.addEventListener('keydown', (event) => {
                    if (event.key === 'Escape' && modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
                
                backupDataBtn.addEventListener('click', handleBackup);
                restoreFileInput.addEventListener('change', handleRestore);

                // Initial render based on default filters and active tab
                applyFiltersAndRender(); // This will also render groups for the first time
            }

            document.addEventListener('DOMContentLoaded', initApp);
        })();
    </script>
</body>
</html>