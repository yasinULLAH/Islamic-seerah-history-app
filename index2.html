<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیرت النبی ﷺ - پیش رفتہ بصری تجزیہ</title>
    <meta name="description" content="سیرت النبی ﷺ کے اہم واقعات کا بصری تجزیہ، تلاش، فلٹرنگ، ٹائم لائن، اور شماریاتی چارٹس کے ساتھ۔">
    <meta name="keywords" content="سیرت النبی, سیرت, نبی محمد, اسلام, تاریخ اسلام, واقعات سیرت, ٹائم لائن سیرت, شماریات سیرت, اردو">
    <meta name="author" content="Yasin Ullah">

    <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --bg-color: #f4f4f4;
            --text-color: #333;
            --card-bg: #fff;
            --header-bg: #2c3e50;
            --header-text: #ecf0f1;
            --accent-color: #3498db;
            --accent-color-dark: #2980b9;
            --border-color: #ddd;
            --modal-bg: rgba(0,0,0,0.6);
            --modal-content-bg: #fff;
            --button-bg: #3498db;
            --button-text: #fff;
            --danger-bg: #e74c3c;
            --success-bg: #2ecc71;
            --warning-bg: #f39c12;
            --font-family-urdu: 'Noto Nastaliq Urdu', serif;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --border-radius: 8px;
        }

        .dark-mode {
            --bg-color: #2c3e50;
            --text-color: #ecf0f1;
            --card-bg: #34495e;
            --header-bg: #1a252f;
            --header-text: #ecf0f1;
            --accent-color: #5dade2;
            --accent-color-dark: #3498db;
            --border-color: #4a6278;
            --modal-content-bg: #34495e;
            --button-bg: #5dade2;
            --button-text: #ecf0f1;
            --shadow: 0 2px 5px rgba(0,0,0,0.3);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-urdu);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            direction: rtl;
            transition: background-color 0.3s, color 0.3s;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            width: 94%;
            margin: 0 auto;
            padding: 15px;
            flex-grow: 1;
        }

        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 1rem 20px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        header h1 {
            font-size: 1.8rem;
            margin: 0;
            flex-grow: 1;
            text-align: center;
        }

        header .header-buttons {
            display: flex;
            gap: 10px;
        }

        #themeToggle, .header-button {
            background: var(--accent-color);
            color: var(--button-text);
            border: none;
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 5px;
            font-family: var(--font-family-urdu);
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        #themeToggle:hover, .header-button:hover {
            background: var(--accent-color-dark);
        }

        .controls-section {
            background-color: var(--card-bg);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .controls-section input[type="search"],
        .controls-section select {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-family-urdu);
            font-size: 1rem;
        }

        .controls-section label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        .tabs {
            display: flex;
            margin-bottom: 20px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
            flex-wrap: wrap; /* Allow tabs to wrap on smaller screens */
        }

        .tab-button {
            flex-grow: 1;
            padding: 12px 15px;
            cursor: pointer;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: none;
            border-left: 1px solid var(--border-color);
            font-family: var(--font-family-urdu);
            font-size: 1rem;
            transition: background-color 0.3s, color 0.3s;
            min-width: 120px; /* Ensure minimum width for tabs */
            text-align: center;
        }
        .tab-button:first-child {
             border-left: none;
        }
         .tab-button:last-child {
             border-right: none; /* Add for RTL consistency */
        }


        .tab-button.active {
            background-color: var(--accent-color);
            color: var(--button-text);
        }
        .tab-button:hover:not(.active) {
            background-color: var(--bg-color);
        }

        .tab-content {
            display: none;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            min-height: 300px; /* Ensure content area has minimum height */
        }

        .tab-content.active {
            display: block;
        }

        #eventListView {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .event-card {
            background-color: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            flex-direction: column;
            transition: transform 0.2s ease-in-out;
        }
         .event-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
        }

        .event-card h3 {
            color: var(--accent-color);
            margin-bottom: 10px;
            font-size: 1.4rem;
        }
        .event-card p {
            margin-bottom: 8px;
            font-size: 0.95rem;
        }
        .event-card strong {
            font-weight: bold;
        }
        .event-card .meta-info {
            font-size: 0.85rem;
            color: var(--text-color);
            opacity: 0.8;
            margin-bottom: 10px;
        }

        .details-button {
            background-color: var(--accent-color);
            color: var(--button-text);
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            font-family: var(--font-family-urdu);
            margin-top: auto;
            transition: background-color 0.3s;
            font-size: 0.9rem;
        }
        .details-button:hover {
            background-color: var(--accent-color-dark);
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 20px;
            gap: 10px;
        }
        .pagination button {
            background-color: var(--accent-color);
            color: var(--button-text);
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-family-urdu);
            transition: background-color 0.3s;
        }
        .pagination button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }
         .pagination button:hover:not(:disabled) {
             background-color: var(--accent-color-dark);
         }
        .pagination span {
            font-weight: bold;
        }


        /* Modal Styling */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: var(--modal-bg);
            animation: fadeIn 0.3s ease-out;
        }

        .modal-content {
            background-color: var(--modal-content-bg);
            margin: 5% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 700px;
            color: var(--text-color);
            position: relative;
            animation: slideInFromTop 0.3s ease-out;
            box-shadow: var(--shadow);
        }

        .close-button {
            color: var(--text-color);
            position: absolute;
            left: 15px;
            top: 10px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }
        .close-button:hover,
        .close-button:focus {
            color: var(--danger-bg);
            opacity: 0.9;
        }

        .modal-content h2 {
            color: var(--accent-color);
            margin-bottom: 15px;
            font-size: 1.6rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }
        .modal-content p {
            margin-bottom: 10px;
            font-size: 1rem;
        }
        .modal-content strong {
            color: var(--accent-color-dark);
        }
        .modal-content .tag {
            display: inline-block;
            background-color: var(--accent-color);
            color: var(--button-text);
            padding: 3px 8px;
            border-radius: 4px;
            margin: 2px;
            font-size: 0.9em;
        }
         .modal-content .tag:hover {
             opacity: 0.8;
         }

        #loadingIndicator, .empty-state-message {
            text-align: center;
            padding: 20px;
            font-size: 1.2rem;
            color: var(--text-color);
            opacity: 0.7;
            display: none; /* Hidden by default */
        }

        /* Charts and Timeline Styling */
        .visualization-container {
            min-height: 300px;
            background-color: var(--bg-color);
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            overflow-x: auto;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.1); /* Subtle inner shadow */
        }
        .visualization-container h4 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 1.3rem;
        }
        .timeline-svg, .chart-svg {
            display: block;
            margin: auto;
            overflow: visible;
        }
        .timeline-event-marker {
            cursor: pointer;
            transition: r 0.2s, fill 0.2s, opacity 0.2s;
        }
        .timeline-event-marker:hover {
            r: 8px;
            fill: var(--accent-color-dark);
            opacity: 0.9;
        }
         .timeline-event-marker.active {
            stroke: var(--warning-bg);
            stroke-width: 2;
         }
        .timeline-axis path, .timeline-axis line {
            fill: none;
            stroke: var(--text-color);
            shape-rendering: crispEdges;
            opacity: 0.7;
        }
        .timeline-axis text {
            fill: var(--text-color);
            font-family: var(--font-family-urdu);
            font-size: 12px;
        }
        .tooltip {
            position: absolute;
            background-color: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 8px;
            font-size: 0.9em;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: var(--shadow);
            z-index: 1001;
            white-space: nowrap; /* Prevent text wrapping */
        }

        /* Backup and Restore Section */
        .backup-restore-section {
            margin-top: 20px;
            padding: 15px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        .backup-restore-section h3 {
            margin-bottom: 10px;
            color: var(--accent-color);
            font-size: 1.3rem;
        }
        .backup-restore-section button, .backup-restore-section input[type="file"] {
            margin: 5px;
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-family: var(--font-family-urdu);
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        .backup-restore-section button {
            background-color: var(--accent-color);
            color: var(--button-text);
        }
        .backup-restore-section button:hover {
            background-color: var(--accent-color-dark);
        }
        #restoreFile {
            color: var(--text-color);
            display: inline-block !important; /* Override hidden style */
            width: auto; /* Allow file input to size naturally */
            margin-left: 10px; /* Space after button */
        }
         .file-input-label {
            background-color: var(--accent-color);
            color: var(--button-text);
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-family: var(--font-family-urdu);
            font-size: 0.9rem;
            transition: background-color 0.3s;
            display: inline-block;
            margin: 5px;
        }
        .file-input-label:hover {
             background-color: var(--accent-color-dark);
        }
        #restoreFile {
            display: none; /* Hide the actual file input */
        }

        #restoreStatus {
            margin-top: 10px;
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.8;
        }

        /* Personalities View */
        .personality-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .personality-group h5 {
            color: var(--accent-color-dark);
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 5px;
        }
        .personality-group ul {
            list-style: none;
            padding: 0;
        }
        .personality-group li {
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        .personality-group li a {
            color: var(--text-color);
            text-decoration: none;
            transition: color 0.3s;
        }
        .personality-group li a:hover {
            color: var(--accent-color);
            text-decoration: underline;
        }

         /* Grouped Events View */
        .grouped-events-section {
            margin-top: 20px;
        }
        .grouped-events-section h3 {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 1.3rem;
        }
        .event-group {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--bg-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        .event-group h4 {
            color: var(--accent-color-dark);
            margin-bottom: 10px;
            font-size: 1.1rem;
            border-bottom: 1px dashed var(--border-color);
            padding-bottom: 5px;
            cursor: pointer;
        }
         .event-group h4 i {
             margin-left: 10px; /* Space for icon RTL */
             transition: transform 0.3s;
         }
         .event-group h4.collapsed i {
             transform: rotate(-90deg);
         }
        .event-group-content {
            display: none;
            padding-top: 10px;
        }
         .event-group-content.active {
             display: block;
         }
        .event-group-content .event-card {
            margin-bottom: 10px; /* Space between cards in group */
        }


        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideInFromTop {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 10px;
                padding: 10px 15px;
            }
             header h1 {
                 font-size: 1.5rem;
             }
             header .header-buttons {
                 width: 100%;
                 justify-content: center;
             }
             .header-button, #themeToggle {
                 flex-grow: 1;
                 text-align: center;
             }
            .tabs {
                flex-direction: column;
            }
            .tab-button {
                border-left: none;
                border-bottom: 1px solid var(--border-color);
                min-width: auto;
            }
            .tab-button:last-child {
                border-bottom: none;
            }
            .modal-content {
                width: 95%;
                margin: 10% auto;
                padding: 20px;
            }
            .controls-grid {
                grid-template-columns: 1fr;
            }
             #eventListView {
                grid-template-columns: 1fr;
            }
             .timeline-svg, .chart-svg {
                 width: 100%; /* Allow SVG to take full width, enable overflow-x scroll */
             }
             .tooltip {
                 /* Adjust tooltip positioning for smaller screens if needed */
                 /* e.g., position relative to event, or center it */
             }
        }
        @media (max-width: 480px) {
             header h1 {
                font-size: 1.3rem;
             }
             .tab-button {
                 font-size: 0.9rem;
                 padding: 10px 10px;
             }
             .event-card h3 {
                 font-size: 1.2rem;
             }
             .event-card p {
                 font-size: 0.9rem;
             }
             .details-button {
                 font-size: 0.85rem;
                 padding: 6px 10px;
             }
             .pagination button {
                 padding: 6px 10px;
                 font-size: 0.9rem;
             }
              .modal-content h2 {
                 font-size: 1.4rem;
             }
             .modal-content p {
                 font-size: 0.95rem;
             }
             .backup-restore-section button, .file-input-label {
                 font-size: 0.85rem;
                 padding: 8px 12px;
             }
        }
    </style>

</head>
<body>
    <header>
        <div class="header-buttons">
            <button id="themeToggle" title="روشن/تاریک موڈ تبدیل کریں"><i class="fas fa-adjust"></i> موڈ</button>
            <button id="backupDataBtn" class="header-button" title="ڈیٹا کا بیک اپ لیں"><i class="fas fa-download"></i> بیک اپ</button>
             <label for="restoreFile" class="file-input-label header-button" title="ڈیٹا بحال کریں"><i class="fas fa-upload"></i> بحال کریں</label>
             <input type="file" id="restoreFile" accept=".json">
        </div>
        <h1>سیرت النبی ﷺ - پیش رفتہ بصری تجزیہ</h1>
         <div></div> <!-- Placeholder for alignment -->
    </header>

<div class="container">
    <div class="controls-section">
        <div class="controls-grid">
            <div>
                <label for="searchInput"><i class="fas fa-search"></i> تلاش کریں:</label>
                <input type="search" id="searchInput" placeholder="واقعہ، تفصیل، شخصیات، ٹیگز...">
            </div>
            <div>
                <label for="periodFilter"><i class="fas fa-calendar-alt"></i> دور/ہجری سال:</label>
                <select id="periodFilter">
                    <option value="">تمام ادوار</option>
                </select>
            </div>
            <div>
                <label for="tagFilter"><i class="fas fa-tags"></i> ٹیگز:</label>
                <select id="tagFilter">
                    <option value="">تمام ٹیگز</option>
                </select>
            </div>
             <div>
                 <label for="locationFilter"><i class="fas fa-map-marker-alt"></i> مقامات:</label>
                 <select id="locationFilter">
                     <option value="">تمام مقامات</option>
                 </select>
             </div>
        </div>
    </div>

    <div class="tabs">
        <button class="tab-button active" data-tab="eventListView"><i class="fas fa-list"></i> واقعات کی فہرست</button>
        <button class="tab-button" data-tab="timelineView"><i class="fas fa-chart-line"></i> ٹائم لائن منظر</button>
        <button class="tab-button" data-tab="chartsView"><i class="fas fa-chart-pie"></i> شماریاتی چارٹ</button>
        <button class="tab-button" data-tab="mapView"><i class="fas fa-map"></i> جغرافیائی نقشہ</button>
        <button class="tab-button" data-tab="personalitiesView"><i class="fas fa-users"></i> متعلقہ شخصیات</button>
         <button class="tab-button" data-tab="groupedView"><i class="fas fa-layer-group"></i> گروپس</button>
    </div>

    <div id="loadingIndicator"><i class="fas fa-spinner fa-spin"></i> ڈیٹا لوڈ ہو رہا ہے، براہ کرم انتظار کریں...</div>

    <div id="eventListView" class="tab-content active">
        <!-- Event cards will be injected here -->
        <div id="emptyStateMessageEventList" class="empty-state-message"><i class="fas fa-box-open"></i> کوئی واقعات نہیں ملے۔</div>
<div class="pagination" style="display: flex; justify-content: center; align-items: center; width: 100%;">
        <button id="prevPageBtn" disabled="" style="flex: 1; text-align: center; max-width: 120px;">
            <i class="fas fa-chevron-right"></i> پچھلا
        </button>
        <span id="pageInfo" style="flex: 1; text-align: center;">صفحہ 1 از 11</span>
        <button id="nextPageBtn" style="flex: 1; text-align: center; max-width: 120px;">
            اگلا <i class="fas fa-chevron-left"></i>
        </button>
    </div>

   
    </div>

    <div id="timelineView" class="tab-content">
        <div class="visualization-container">
            <h4>واقعات کی ٹائم لائن</h4>
            <svg id="timelineSvg" class="timeline-svg" width="100%" height="400"></svg>
        </div>
        <div id="emptyStateMessageTimeline" class="empty-state-message"><i class="fas fa-chart-line"></i> ٹائم لائن کے لیے کوئی ڈیٹا دستیاب نہیں۔</div>
    </div>

    <div id="chartsView" class="tab-content">
        <div class="visualization-container">
            <h4>ٹیگز کے لحاظ سے واقعات کی تقسیم</h4>
            <svg id="tagsChartSvg" class="chart-svg" width="100%" height="300"></svg>
        </div>
        <div class="visualization-container">
            <h4>ادوار کے لحاظ سے واقعات کی تقسیم</h4>
            <svg id="periodsChartSvg" class="chart-svg" width="100%" height="300"></svg>
        </div>
         <div class="visualization-container">
            <h4>مقامات کے لحاظ سے واقعات کی تقسیم</h4>
            <svg id="locationsChartSvg" class="chart-svg" width="100%" height="300"></svg>
        </div>
        <div id="emptyStateMessageCharts" class="empty-state-message"><i class="fas fa-chart-pie"></i> چارٹس کے لیے کوئی ڈیٹا دستیاب نہیں۔</div>
    </div>

    <div id="mapView" class="tab-content">
        <div class="visualization-container">
            <h4>واقعات کے مقامات (تصوراتی نقشہ)</h4>
            <p style="text-align:center; margin-bottom: 15px;">یہاں ایک سادہ SVG نقشہ یا مقامات کی فہرست دکھائی جائے گی۔</p>
            <div id="mapSvgContainer" style="width: 100%; overflow-x: auto;">
                 <!-- SVG Map Placeholder -->
                 <svg id="mapSvg" width="800" height="500" style="border: 1px solid var(--border-color); background-color: var(--bg-color);"></svg>
            </div>
            <ul id="mapLocationList" style="margin-top: 20px; list-style: disc; padding-right: 20px;"></ul>
        </div>
         <div id="emptyStateMessageMap" class="empty-state-message"><i class="fas fa-map"></i> نقشے کے لیے کوئی ڈیٹا دستیاب نہیں۔</div>
    </div>

    <div id="personalitiesView" class="tab-content">
         <h4>متعلقہ شخصیات اور ان سے منسلک واقعات</h4>
         <div id="personalitiesListContainer">
            <!-- Personalities will be listed here -->
         </div>
         <div id="emptyStateMessagePersonalities" class="empty-state-message"><i class="fas fa-users"></i> کوئی شخصیات نہیں ملیں۔</div>
    </div>

    <div id="groupedView" class="tab-content grouped-events-section">
        <h3>واقعات کی گروپ بندی</h3>
        <div id="groupedEventsContainer">
            <!-- Grouped events will be injected here -->
        </div>
         <div id="emptyStateMessageGrouped" class="empty-state-message"><i class="fas fa-layer-group"></i> گروپ بندی کے لیے کوئی ڈیٹا دستیاب نہیں۔</div>
    </div>


    <div id="restoreStatus" style="text-align: center; margin-top: 10px; font-size: 0.9em;"></div>

</div> <!-- /container -->

<div id="eventDetailModal" class="modal">
    <div class="modal-content">
        <span class="close-button" title="بند کریں">×</span>
        <h2 id="modalTitle"></h2>
        <p><strong>عیسوی سال:</strong> <span id="modalGregorianYear"></span></p>
        <p><strong>ہجری سال / دور:</strong> <span id="modalHijriYear"></span></p>
        <p><strong>مختصر تفصیل:</strong> <span id="modalShortDescription"></span></p>
        <p><strong>تفصیلی وضاحت:</strong> <span id="modalDetailedExplanation"></span></p>
        <p><strong>متعلقہ شخصیات:</strong> <span id="modalPersonalities"></span></p>
        <p><strong>مقام:</strong> <span id="modalLocation"></span></p>
        <p><strong>نقشہ کوآرڈینیٹس:</strong> <span id="modalCoordinates"></span></p>
        <p><strong>تصویری حوالہ:</strong> <span id="modalImageRef"></span></p>
        <p><strong>ٹیگز:</strong> <span id="modalTags"></span></p>
    </div>
</div>

<div class="tooltip" id="tooltip"></div>

<footer>
    <div class="container" style="text-align: center; font-size: 0.9em; color: var(--text-color); opacity: 0.7; padding: 10px;">
        © <span id="currentYear"></span> سیرت النبی ﷺ پیش رفتہ بصری تجزیہ. Yasin Ullah.
    </div>
</footer>

<script>
    (function() {
        // --- Constants ---
        const DB_NAME = 'SeerahEventsDB_v3'; // Increment DB version for schema changes
        const DB_VERSION = 2;
        const STORE_NAME = 'enriched_events';
        const KEY_PATH = 'شمار';

        const EVENTS_PER_PAGE = 12; // For pagination

        // --- DOM Elements ---
        const themeToggle = document.getElementById('themeToggle');
        const searchInput = document.getElementById('searchInput');
        const periodFilter = document.getElementById('periodFilter');
        const tagFilter = document.getElementById('tagFilter');
        const locationFilter = document.getElementById('locationFilter');

        const eventListView = document.getElementById('eventListView');
        const timelineView = document.getElementById('timelineView');
        const timelineSvg = document.getElementById('timelineSvg');
        const chartsView = document.getElementById('chartsView');
        const tagsChartSvg = document.getElementById('tagsChartSvg');
        const periodsChartSvg = document.getElementById('periodsChartSvg');
        const locationsChartSvg = document.getElementById('locationsChartSvg');
        const mapView = document.getElementById('mapView');
        const mapSvg = document.getElementById('mapSvg');
        const mapLocationList = document.getElementById('mapLocationList');
        const personalitiesView = document.getElementById('personalitiesView');
        const personalitiesListContainer = document.getElementById('personalitiesListContainer');
        const groupedView = document.getElementById('groupedView');
        const groupedEventsContainer = document.getElementById('groupedEventsContainer');


        const loadingIndicator = document.getElementById('loadingIndicator');
        const emptyStateMessages = {
            eventListView: document.getElementById('emptyStateMessageEventList'),
            timelineView: document.getElementById('emptyStateMessageTimeline'),
            chartsView: document.getElementById('emptyStateMessageCharts'),
            mapView: document.getElementById('emptyStateMessageMap'),
            personalitiesView: document.getElementById('emptyStateMessagePersonalities'),
            groupedView: document.getElementById('emptyStateMessageGrouped')
        };

        const modal = document.getElementById('eventDetailModal');
        const modalCloseButton = modal.querySelector('.close-button');
        const tooltip = document.getElementById('tooltip');

        const backupDataBtn = document.getElementById('backupDataBtn');
        const restoreFileInput = document.getElementById('restoreFile');
        const restoreStatus = document.getElementById('restoreStatus');

        let prevPageBtn = document.getElementById('prevPageBtn');
        let nextPageBtn = document.getElementById('nextPageBtn');
        let pageInfoSpan = document.getElementById('pageInfo');

        // --- State Variables ---
        let db;
        let allEvents = [];
        let filteredEvents = [];
        let currentFilters = {
            searchTerm: '',
            period: '',
            tag: '',
            location: ''
        };
        let currentPage = 1;
        let totalPages = 1;
        let activeTab = 'eventListView'; // Keep track of the active tab


        // --- Sample CSV Data (Embedded for fallback/offline demo) ---
        // Add more sample data to make the app more useful out-of-the-box
        const sampleHistoryCSV = `شمار,عیسوی سال (تقریباً),ہجری سال / دور,واقعہ (اردو),مختصر تفصیل (اردو)
1,570,عام الفیل/قبل از نبوت,ولادت با سعادت,نبی اکرم صلی اللہ علیہ وسلم کی مکہ مکرمہ میں ولادت ہوئی۔
2,610,مکی دور/پہلی وحی,پہلی وحی کا نزول,غار حرا میں پہلی وحی کا نزول ہوا۔
3,613,مکی دور/دعوت,اعلان نبوت,آپ ﷺ نے کوہ صفا پر چڑھ کر قریش کو دعوت دی۔
4,615,مکی دور/ہجرت حبشہ,پہلی ہجرت حبشہ,مسلمانوں کے ایک گروہ نے حبشہ کی طرف ہجرت کی۔
5,616,مکی دور/بائیکاٹ,معاشی و سماجی بائیکاٹ,قریش نے بنو ہاشم کا بائیکاٹ کیا۔
6,619,مکی دور/عام الحزن,عام الحزن,حضرت خدیجہؓ اور حضرت ابوطالب کی وفات کا سال۔
7,620,مکی دور/طائف,سفر طائف,آپ ﷺ نے طائف کا سفر کیا اور وہاں کے لوگوں کو اسلام کی دعوت دی۔
8,621,مکی دور/معراج,واقعہ معراج,آپ ﷺ کا آسمانوں کا سفر اور نماز کی فرضیت۔
9,622,مدنی دور/ہجرت,ہجرت مدینہ,مکہ سے مدینہ کی طرف ہجرت فرمائی۔
10,622,مدنی دور/ریاست مدینہ,میثاق مدینہ,مدینہ کے مختلف گروہوں کے درمیان معاہدہ۔
11,624,مدنی دور/غزوات,غزوہ بدر,اسلام اور کفر کے درمیان پہلی بڑی جنگ۔
12,625,مدنی دور/غزوات,غزوہ احد,مسلمانوں کو نقصان اٹھانا پڑا۔
13,627,مدنی دور/غزوات,غزوہ خندق/احزاب,مدینہ کے گرد خندق کھودی گئی۔
14,628,مدنی دور/صلح حدیبیہ,صلح حدیبیہ,مسلمانوں اور قریش کے درمیان دس سالہ معاہدہ۔
15,628,مدنی دور/دعوت,مختلف بادشاہوں کو خطوط,آپ ﷺ نے اسلام کی دعوت کے لیے خطوط بھیجے۔
16,629,مدنی دور/غزوات,غزوہ خیبر,خیبر کے یہودی قلعوں کی فتح۔
17,630,مدنی دور/فتح مکہ,فتح مکہ,مسلمانوں نے مکہ مکرمہ کو فتح کیا۔
18,630,مدنی دور/غزوات,غزوہ حنین,فتح مکہ کے بعد ہوازن اور ثقیف سے جنگ۔
19,631,مدنی دور/غزوات,غزوہ تبوک,رومیوں کے خلاف تیاری۔
20,632,مدنی دور/حجۃ الوداع,حجۃ الوداع,آپ ﷺ کا آخری حج اور خطبہ۔
21,632,مدنی دور/وفات,وفات النبی ﷺ,آپ ﷺ کی مدینہ منورہ میں وفات۔
`;

        const sampleDetailsCSV = `شمار,تفصیلی وضاحت,متعلقہ شخصیات,مقام,نقشہ_کوآرڈینیٹس,تصویری_حوالہ,ٹیگز,گروپ
1,"آپ ﷺ بروز پیر، ١٢ ربیع الاول، عام الفیل میں پیدا ہوئے۔ والد کا نام عبداللہ اور والدہ کا نام آمنہ تھی۔ آپ ﷺ کی پرورش دادا عبدالمطلب اور چچا ابوطالب نے کی۔",حضرت آمنہ,حضرت عبداللہ,عبدالمطلب,ابوطالب,حلیمہ سعدیہ,مکہ مکرمہ,"21.3891,39.8579","birth.jpg","ولادت,مکی دور,ابتدائی زندگی,خاندان","ابتدائی زندگی"
2,"رمضان المبارک کے مہینے میں، جب آپ ﷺ غار حرا میں عبادت کر رہے تھے، اللہ تعالیٰ کی طرف سے حضرت جبرائیل علیہ السلام پہلی وحی لے کر آئے۔ یہ سورۃ العلق کی ابتدائی آیات تھیں۔","حضرت جبرائیل علیہ السلام,حضرت خدیجہؓ",غار حرا,"21.4592,39.8876","first_revelation.jpg","وحی,نبوت,مکی دور","نبوت کا آغاز"
3,"تین سال تک خفیہ دعوت کے بعد، اللہ کے حکم سے آپ ﷺ نے کوہ صفا پر قریش کو جمع کر کے علی الاعلان اسلام کی دعوت دی۔ اکثر نے انکار کیا۔",ابولہب,ابوطالب,مکہ مکرمہ,"21.3891,39.8579","public_invitation.jpg","دعوت,مکی دور","نبوت کا آغاز"
4,"کفار مکہ کے بڑھتے ہوئے مظالم سے بچنے کے لیے، آپ ﷺ کی اجازت سے مسلمانوں کے ایک چھوٹے گروہ نے حبشہ کے عیسائی بادشاہ نجاشی کے پاس ہجرت کی۔",نجاشی,حضرت جعفر بن ابی طالبؓ,حبشہ (ایتھوپیا),"~9.1450,40.4897","hijrah_habesha.jpg","ہجرت,مکی دور","ہجرتیں"
5,"قریش نے مسلمانوں اور بنو ہاشم کا مکمل سماجی اور معاشی بائیکاٹ کر دیا۔ انہیں شعب ابی طالب میں محصور کر دیا گیا۔ یہ بائیکاٹ تقریباً تین سال جاری رہا۔",ابوطالب,ابوجہل,شعب ابی طالب (مکہ کے قریب),"21.3891,39.8579","boycott.jpg","بائیکاٹ,مکی دور","مکی دور کے مصائب"
6,"یہ سال آپ ﷺ کے لیے انتہائی غم کا سال تھا۔ پہلے آپ ﷺ کے چچا ابوطالب کا انتقال ہوا جنہوں نے آپ کی حفاظت کی، پھر آپ کی پیاری زوجہ حضرت خدیجہؓ کا انتقال ہوا۔",حضرت خدیجہؓ,ابوطالب,مکہ مکرمہ,"21.3891,39.8579","year_of_grief.jpg","عام الحزن,مکی دور","مکی دور کے مصائب"
7,"آپ ﷺ نے طائف کا سفر کیا تاکہ وہاں کے لوگوں کو اسلام کی دعوت دیں۔ لیکن انہیں شدید مخالفت اور پتھروں کا سامنا کرنا پڑا۔",زید بن حارثہؓ,طائف,"21.2702,40.4070","taif.jpg","سفر,دعوت,مکی دور","دعوت و مشکلات"
8,"یہ ایک معجزاتی سفر تھا جس میں آپ ﷺ رات کے وقت مکہ سے بیت المقدس گئے اور وہاں سے آسمانوں کی سیر کی۔ اس سفر میں نماز کی فرضیت کا حکم ملا۔",حضرت جبرائیل علیہ السلام,بیت المقدس (یروشلم),"31.7767,35.2345","miraj.jpg","معراج,مکی دور,معجزہ","نبوت کا آغاز"
9,"اللہ کے حکم سے، آپ ﷺ اور مسلمانوں نے مکہ سے یثرب (جو بعد میں مدینہ کہلایا) کی طرف ہجرت کی۔ یہ ہجرت اسلامی کیلنڈر کی بنیاد بنی۔",حضرت ابوبکر صدیقؓ,سراقہ بن مالک,مدینہ منورہ,"24.4686,39.6142","hijrah_madinah.jpg","ہجرت,مدنی دور,ریاست مدینہ","ہجرتیں"
10,"مدینہ پہنچ کر، آپ ﷺ نے انصار، مہاجرین اور یہودیوں کے درمیان ایک معاہدہ کرایا جس نے مدینہ کو ایک ریاست کی شکل دی۔",انصار,مہاجرین,یہودی قبائل,مدینہ منورہ,"24.4686,39.6142","constitution_madinah.jpg","میثاق مدینہ,ریاست مدینہ,مدنی دور","ریاست مدینہ کا قیام"
11,"رمضان المبارک ٢ ہجری میں، مسلمانوں کا ایک چھوٹا لشکر قریش کے بڑے لشکر سے بدر کے مقام پر ٹکرایا۔ اللہ کی مدد سے مسلمانوں کو شاندار فتح نصیب ہوئی۔",ابوجہل,عتبہ بن ربیعہ,شیبہ بن ربیعہ,حضرت حمزہؓ,حضرت علیؓ,بدر,"23.7667,38.7833","badr.jpg","غزوہ,جنگ,مدنی دور","اہم غزوات"
12,"شوال ٣ ہجری میں، قریش نے بدر کا بدلہ لینے کے لیے احد کے مقام پر جنگ کی۔ مسلمانوں کو ابتدائی کامیابی کے بعد تیر اندازوں کی غلطی کی وجہ سے نقصان اٹھانا پڑا۔",حضرت حمزہؓ,خالد بن ولید (اس وقت کافر),ابوسفیان (اس وقت کافر),احد,"24.5214,39.5597","uhud.jpg","غزوہ,جنگ,مدنی دور","اہم غزوات"
13,"شوال ٥ ہجری میں، قریش اور دیگر قبائل کے ایک بڑے اتحاد (احزاب) نے مدینہ پر حملہ کیا۔ مسلمانوں نے سلمان فارسیؓ کے مشورے سے مدینہ کے گرد خندق کھودی۔",سلمان فارسیؓ,ابوسفیان,حئی بن اخطب,مدینہ منورہ کے اطراف,"24.4686,39.6142","khandaq.jpg","غزوہ,خندق,احزاب,مدنی دور","اہم غزوات"
14,"ذوالقعدہ ٦ ہجری میں، مسلمان عمرہ کی نیت سے مکہ گئے لیکن قریش نے روک لیا۔ حدیبیہ کے مقام پر ایک معاہدہ ہوا جو بظاہر مسلمانوں کے خلاف تھا مگر بعد میں فتح مکہ کا پیش خیمہ ثابت ہوا۔",سہیل بن عمرو,حضرت عثمانؓ,حدیبیہ (مکہ کے قریب),"21.3891,39.8579","hudaybiyah.jpg","صلح,معاہدہ,مدنی دور","اہم معاہدات"
15,"صلح حدیبیہ کے بعد، آپ ﷺ نے مختلف بادشاہوں اور حکمرانوں کو اسلام کی دعوت دینے کے لیے خطوط بھیجے۔ ان میں قیصر روم، کسریٰ فارس، نجاشی حبشہ وغیرہ شامل تھے۔",ہرقل (قیصر روم),کسریٰ (بادشاہ فارس),نجاشی (بادشاہ حبشہ),مختلف مقامات,"","letters.jpg","دعوت,مدنی دور","دعوت و مشکلات"
16,"محرم ٧ ہجری میں، مسلمانوں نے خیبر کے یہودی قلعوں کو فتح کیا۔ یہ علاقہ مسلمانوں کے لیے معاشی طور پر بہت اہم ثابت ہوا۔",مرحب یہودی,حضرت علیؓ,خیبر,"25.7000,39.5000","khaybar.jpg","غزوہ,فتح,مدنی دور","اہم غزوات"
17,"رمضان ٨ ہجری میں، قریش کی طرف سے صلح حدیبیہ کی خلاف ورزی کے بعد، آپ ﷺ دس ہزار صحابہ کے ساتھ مکہ میں داخل ہوئے۔ مکہ بغیر خونریزی کے فتح ہوا۔ بتوں کو توڑا گیا۔",ابوسفیان (اسلام قبول کیا),بلال بن رباحؓ,مکہ مکرمہ,"21.3891,39.8579","fath_makkah.jpg","فتح مکہ,مدنی دور,فتح","اہم غزوات"
18,"فتح مکہ کے بعد، ہوازن اور ثقیف قبائل نے مسلمانوں پر حملہ کیا۔ حنین کے مقام پر ہونے والی اس جنگ میں ابتدائی مشکل کے بعد مسلمانوں کو فتح نصیب ہوئی۔",مالک بن عوف نصری,حنین (مکہ اور طائف کے درمیان),"21.3891,39.8579","hunayn.jpg","غزوہ,جنگ,مدنی دور","اہم غزوات"
19,"رومیوں کی شام میں تیاریوں کی خبر پر، آپ ﷺ نے تبوک کا سفر کیا۔ یہ ایک مشکل سفر تھا لیکن مسلمانوں کی تیاری دیکھ کر رومیوں نے جنگ سے گریز کیا۔",تبوک,"28.3920,36.5771","tabuk.jpg","غزوہ,مدنی دور","اہم غزوات"
20,"ذوالحجہ ١٠ ہجری میں، آپ ﷺ نے اپنا آخری حج ادا کیا۔ عرفات کے میدان میں آپ ﷺ نے ایک عظیم الشان خطبہ دیا جس میں انسانی حقوق، اخوت اور مساوات پر زور دیا۔",تمام صحابہ کرامؓ,عرفات (مکہ کے قریب),"21.3547,40.0761","farewell_pilgrimage.jpg","حج,خطبہ,مدنی دور","آخری ایام"
21,"ربیع الاول ١١ ہجری میں، تریسٹھ سال کی عمر میں، آپ ﷺ مدینہ منورہ میں اپنے حجرہ مبارک میں وفات پا گئے۔",حضرت عائشہؓ,حضرت ابوبکر صدیقؓ,مدینہ منورہ,"24.4686,39.6142","prophet_death.jpg","وفات,مدنی دور,آخری ایام","آخری ایام"
`;


        // --- Utility Functions ---
        function parseCSV(csvText) {
            if (!csvText || typeof csvText !== 'string') return [];
            const lines = csvText.trim().split('\n');
            if (lines.length < 2) return []; // Needs header and at least one data row

            // Simple CSV parsing assuming no commas within quoted fields
            const header = lines[0].split(',').map(h => h.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                if (values.length === header.length) {
                    const entry = {};
                    header.forEach((col, index) => {
                        entry[col] = values[index];
                    });
                    data.push(entry);
                } else {
                    console.warn(`Skipping malformed CSV line: ${lines[i]}`);
                }
            }
            return data;
        }

        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // --- IndexedDB Functions ---
        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (event) => {
                    console.error("Database error:", event.target.errorCode, event.target.error);
                    reject("Database error: " + (event.target.error ? event.target.error.message : event.target.errorCode));
                };
                request.onsuccess = (event) => {
                    db = event.target.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    const storeDb = event.target.result;
                    if (!storeDb.objectStoreNames.contains(STORE_NAME)) {
                        const objectStore = storeDb.createObjectStore(STORE_NAME, { keyPath: KEY_PATH });
                        // Create indexes if needed for filtering/sorting (optional but good practice)
                        // objectStore.createIndex("عیسوی سال (تقریباً)", "عیسوی سال (تقریباً)", { unique: false });
                        // objectStore.createIndex("ہجری سال / دور", "ہجری سال / دور", { unique: false });
                        // objectStore.createIndex("ٹیگز", "ٹیگز", { unique: false, multiEntry: true }); // multiEntry for array fields
                        // objectStore.createIndex("مقام", "مقام", { unique: false });
                        console.log("IndexedDB upgrade: Object store created.");
                    }
                };
            });
        }

        async function addDataToDB(data) {
            if (!db) {
                console.error("DB not initialized for addDataToDB");
                return Promise.reject("DB not initialized");
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                let completedCount = 0;
                let errorOccurred = false;

                if (!Array.isArray(data)) data = [data];

                if (data.length === 0) {
                    resolve();
                    return;
                }

                data.forEach(item => {
                    // Ensure 'شمار' is a number
                    const id = parseInt(item[KEY_PATH]);
                    if (isNaN(id)) {
                        console.warn(`Skipping item with invalid ID:`, item);
                        errorOccurred = true; // Mark error but continue
                        return; // Skip this item
                    }
                     item[KEY_PATH] = id; // Ensure ID is number

                    const request = store.put(item); // put will add or update
                    request.onsuccess = () => {
                        completedCount++;
                        if (completedCount === data.length) {
                            if (errorOccurred) {
                                reject("Some items failed to add.");
                            } else {
                                resolve();
                            }
                        }
                    };
                    request.onerror = (event) => {
                        console.error("Error adding item to DB:", item, event.target.error);
                        errorOccurred = true; // Mark error but continue
                        completedCount++; // Count even failed ones to know when transaction finishes
                        if (completedCount === data.length) {
                             reject("Some items failed to add."); // Reject if any error occurred
                        }
                    };
                });

                 // Handle transaction completion/errors
                transaction.oncomplete = () => {
                    if (!errorOccurred) {
                         resolve();
                    }
                    // If errorOccurred is true, the reject was called inside the loop
                };
                transaction.onerror = (event) => {
                    console.error("Transaction error:", event.target.error);
                    reject("Transaction error: " + event.target.error.message);
                };
                 transaction.onabort = (event) => {
                     console.error("Transaction aborted:", event.target.error);
                     reject("Transaction aborted: " + event.target.error.message);
                 };
            });
        }

        async function getAllDataFromDB() {
            if (!db) {
                 console.error("DB not initialized for getAllDataFromDB");
                 return Promise.resolve([]);
            }
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.getAll();
                request.onsuccess = (event) => resolve(event.target.result);
                request.onerror = (event) => {
                    console.error("Error fetching all data:", event.target.error);
                    reject("Error fetching all data: " + event.target.error.message);
                };
            });
        }

        async function clearStoreInDB() {
            if (!db) return Promise.reject("DB not initialized");
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.clear();
                request.onsuccess = () => resolve();
                request.onerror = (event) => {
                    console.error("Error clearing store:", event.target.error);
                    reject("Error clearing store: " + event.target.error.message);
                };
            });
        }

        // --- Data Loading and Processing ---
        async function fetchAndParseCSV(url, fallbackData) {
            try {
                // Use a timestamp or cache-buster to avoid stale cache during development/testing
                const cacheBuster = new Date().getTime();
                const response = await fetch(`${url}?v=${cacheBuster}`);
                if (!response.ok) {
                    console.warn(`Failed to fetch ${url} (status: ${response.status}), using fallback data.`);
                    return parseCSV(fallbackData);
                }
                const csvText = await response.text();
                if (!csvText || csvText.trim().length === 0) {
                     console.warn(`${url} is empty, using fallback data.`);
                     return parseCSV(fallbackData);
                }
                return parseCSV(csvText);
            } catch (error) {
                console.warn(`Error fetching ${url}: ${error}. Using fallback data.`);
                return parseCSV(fallbackData);
            }
        }

               function enrichEventData(historyEvents, detailEvents) {
            const detailsMap = new Map();
            detailEvents.forEach(detail => {
                detailsMap.set(String(detail['شمار']), detail);
            });

            return historyEvents.map(event => {
                const detail = detailsMap.get(String(event['شمار']));
                const enriched = {
                    ...event,
                    'شمار': parseInt(event['شمار']), // Ensure ID is number
                    // Default/fallback for detail fields
                    'تفصیلی وضاحت': event['مختصر تفصیل (اردو)'] || '',
                    'متعلقہ شخصیات': [],
                    'مقام': 'نامعلوم',
                    'نقشہ_کوآرڈینیٹس': '', // Default to empty string
                    'تصویری_حوالہ': '',
                    'ٹیگز': [],
                    'گروپ': '' // Default group
                };

                if (detail) {
                    // Overwrite with detail fields if available
                    if (detail['تفصیلی وضاحت']) enriched['تفصیلی وضاحت'] = detail['تفصیلی وضاحت'];
                    // Handle multiple personalities separated by | or ,
                    if (detail['متعلقہ شخصیات']) {
                         const personalitiesString = detail['متعلقہ شخصیات'].trim();
                         if (personalitiesString) {
                              enriched['متعلقہ شخصیات'] = personalitiesString.split(/[,|]/).map(p => p.trim()).filter(p => p);
                         }
                    }
                    // Handle multiple locations separated by | - take only the first
                    if (detail['مقام']) {
                         const locationString = detail['مقام'].trim();
                         if (locationString.includes('|')) {
                              enriched['مقام'] = locationString.split('|')[0].trim();
                         } else {
                             enriched['مقام'] = locationString;
                         }
                    }

                    // --- FIX: Simple conversion of hyphen to comma for coordinates ---
                    if (detail['نقشہ_کوآرڈینیٹس']) {
                         const coords = detail['نقشہ_کوآrdinates'].trim(); // Typo fix? Assuming it was 'نقشہ_کوآرڈینیٹس'
                         if (coords) {
                             // Replace hyphen with comma
                             const commaSeparatedCoords = coords.replace('-', ',');
                             // Simple check if it now contains a comma (basic validation)
                             if (commaSeparatedCoords.includes(',')) {
                                 enriched['نقشہ_کوآرڈینیٹس'] = commaSeparatedCoords; // Store as comma-separated
                             } else {
                                 console.warn(`Coordinate string still invalid after hyphen replacement for ID ${event['شمار']}: "${detail['نقشہ_کوآرڈینیٹس']}"`);
                                 enriched['نقشہ_کوآرڈینیٹس'] = ''; // Clear invalid coordinates
                             }
                         } else {
                             enriched['نقشہ_کوآرڈینیٹس'] = ''; // Clear empty coordinates
                         }
                    } else {
                         enriched['نقشہ_کوآرڈینیٹس'] = ''; // Ensure it's empty if missing in details
                    }


                    if (detail['تصویری_حوالہ']) enriched['تصویری_حوالہ'] = detail['تصویری_حوالہ'].trim();
                    // Handle multiple tags separated by | or ,
                     if (detail['ٹیگز']) {
                         const tagsString = detail['ٹیگز'].trim();
                         if (tagsString) {
                             enriched['ٹیگز'] = tagsString.split(/[,|]/).map(t => t.trim()).filter(t => t);
                         }
                     }

                    if (detail['گروپ']) enriched['گروپ'] = detail['گروپ'].trim();
                } else {
                    // If no detail data, ensure coordinate is explicitly empty
                     enriched['نقشہ_کوآرڈینیٹس'] = '';
                }
                return enriched;
            }).filter(event => !isNaN(event['شمار'])); // Filter out events with invalid IDs
        }

        function renderMap(eventsToRender) {
            mapLocationList.innerHTML = ''; // Clear previous list
            mapSvg.innerHTML = ''; // Clear previous SVG content
            tooltip.style.opacity = '0'; // Hide tooltip

            // --- Filter events with valid coordinates (now expecting comma-separated) ---
            const eventsWithCoords = eventsToRender.filter(e =>
                e['مقام'] && e['مقام'] !== 'نامعلوم' &&
                e['نقشہ_کوآرڈینیٹس'] && e['نقشہ_کوآرڈینیٹس'].includes(',') // Check for comma after enrichment
            );

            if (eventsWithCoords.length === 0) {
                emptyStateMessages.mapView.style.display = 'block';
                mapLocationList.innerHTML = '<li>نقشے کے لیے کوئی مقامات دستیاب نہیں۔</li>';
                return;
            }
            emptyStateMessages.mapView.style.display = 'none';

            // Basic SVG Map Placeholder - Draw points for locations
            const containerWidth = mapSvg.parentElement.getBoundingClientRect().width;
            const width = Math.max(containerWidth, 800); // Minimum width
            const height = 500;

            mapSvg.setAttribute("width", width); // Set SVG width dynamically
            mapSvg.setAttribute("height", height); // Set SVG height

            // Simple coordinate scaling (this is highly simplified and assumes coordinates within a certain range)
            // A real map would require proper projection and geographic data.
            // Assuming coordinates are roughly within Saudi Arabia/Middle East
            const minLat = 15; maxLat = 35; // Expanded example range
            const minLon = 30; maxLon = 50; // Expanded example range

            const xScale = (lon) => ((lon - minLon) / (maxLon - minLon)) * width;
            // Latitude scale needs to be inverted for SVG Y axis (top is 0)
            const yScale = (lat) => height - ((lat - minLat) / (maxLat - minLat)) * height;

            // Add a background rectangle for the map area
            const mapBackground = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            mapBackground.setAttribute("x", 0);
            mapBackground.setAttribute("y", 0);
            mapBackground.setAttribute("width", width);
            mapBackground.setAttribute("height", height);
            mapBackground.setAttribute("fill", "#e0f2f7"); // Light blue background
            mapSvg.appendChild(mapBackground);

            // Draw points for each unique location
            const locationsMap = new Map(); // Map to store events by location string
            eventsWithCoords.forEach(event => {
                 // Use the potentially cleaned location name as the key
                 if (!locationsMap.has(event['مقام'])) {
                     locationsMap.set(event['مقام'], []);
                 }
                 locationsMap.get(event['مقام']).push(event);
            });

            locationsMap.forEach((eventsAtLocation, locationName) => {
                 // --- Get coordinates from the first event in the group ---
                 // The coordinates should already be comma-separated due to enrichment
                 const coords = eventsAtLocation[0]['نقشہ_کوآرڈینیٹس'].split(',').map(c => parseFloat(c.trim())).filter(c => !isNaN(c));

                 if (coords.length === 2) {
                     const lat = coords[0]; // Latitude is typically first
                     const lon = coords[1]; // Longitude is typically second

                     // Check if coordinates are within assumed range, otherwise skip or warn
                     if (lon >= minLon && lon <= maxLon && lat >= minLat && lat <= maxLat) {
                         const cx = xScale(lon);
                         const cy = yScale(lat);

                         const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                         circle.setAttribute("cx", cx);
                         circle.setAttribute("cy", cy);
                         circle.setAttribute("r", 7 + eventsAtLocation.length * 0.5); // Radius based on number of events
                         circle.setAttribute("fill", "var(--danger-bg)"); // Use a distinct color for locations
                         circle.setAttribute("opacity", 0.8);
                         circle.style.cursor = 'pointer';
                         circle.dataset.location = locationName; // Store location name

                         circle.addEventListener('mouseover', (e) => {
                             tooltip.innerHTML = `<strong>${locationName}</strong><br>${eventsAtLocation.length} واقعات`;
                             tooltip.style.opacity = '0.9';
                             // Position tooltip near cursor
                             tooltip.style.left = (e.pageX - tooltip.offsetWidth - 10) + 'px';
                             tooltip.style.top = (e.pageY + 10) + 'px';
                         });
                         circle.addEventListener('mouseout', () => {
                             tooltip.style.opacity = '0';
                         });
                         circle.addEventListener('click', () => {
                             // Filter by this location and switch to list view
                             locationFilter.value = locationName;
                             handleFilterChange();
                             activateTab('eventListView');
                         });
                         mapSvg.appendChild(circle);

                         // Add location label
                         const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                         text.setAttribute("x", cx + 10); // Offset text
                         text.setAttribute("y", cy);
                         text.setAttribute("fill", "var(--text-color)");
                         text.style.fontFamily = "var(--font-family-urdu)";
                         text.style.fontSize = "12px";
                         text.textContent = locationName;
                         mapSvg.appendChild(text);

                     } else {
                         console.warn(`Location "${locationName}" has coordinates (${lat}, ${lon}) outside assumed range.`);
                     }
                 } else {
                     // This warning indicates an issue in enrichment if coordinates are still invalid here
                     console.warn(`Location "${locationName}" has invalid coordinate format after enrichment: "${eventsAtLocation[0]['نقشہ_کوآرڈینیٹس']}"`);
                 }
            });


            // Also render the list below the map
            eventsWithCoords.forEach(event => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>${event['واقعہ (اردو)']}</strong>: ${event['مقام']} (${event['نقشہ_کوآرڈینیٹس']})`;
                listItem.style.cursor = 'pointer';
                listItem.addEventListener('click', () => showEventModal(event['شمار']));
                mapLocationList.appendChild(listItem);
            });
        }

     async function loadInitialData() {
            showLoading(true);
            try {
                const existingEvents = await getAllDataFromDB();
                if (existingEvents.length === 0) {
                    console.log("IndexedDB is empty or data migration needed. Loading initial data...");
                    // Fetch from external files instead of using embedded samples
                    const historyEvents = await fetchAndParseCSV('history.csv');
                    const detailEvents = await fetchAndParseCSV('details.csv');

                    if (historyEvents.length === 0) {
                        console.error("Failed to load primary history.csv data.");
                        showToast("بنیادی تاریخی ڈیٹا لوڈ کرنے میں ناکامی! براہ کرم بعد میں دوبارہ کوشش کریں۔", "error");
                        showLoading(false);
                        return;
                    }

                    const enrichedEvents = enrichEventData(historyEvents, detailEvents);
                    if (enrichedEvents.length > 0) {
                         await addDataToDB(enrichedEvents);
                         console.log("Initial data loaded and enriched.");
                         showToast("ابتدائی ڈیٹا کامیابی سے لوڈ ہوگیا۔", "success");
                    } else {
                         console.warn("No valid events found after enrichment.");
                         showToast("ڈیٹا فائلیں خالی یا غلط فارمیٹ میں ہیں۔", "warning");
                    }

                } else {
                    console.log("Data already exists in IndexedDB.");
                    // If data exists, you might still want to check for updates
                    // This part was removed based on your previous request,
                    // but if you want updates from historyupdate.csv, add it back here.
                    // await loadUpdateData();
                }
            } catch (error) {
                console.error("Error during initial data load:", error);
                showToast("ڈیٹا لوڈنگ میں خرابی: " + error.message, "error");
            } finally {
                await refreshAllDataAndViews();
                showLoading(false);
            }
        }

        // Modify fetchAndParseCSV to not use fallback data when fetching
        async function fetchAndParseCSV(url) {
            try {
                const cacheBuster = new Date().getTime();
                const response = await fetch(`${url}?v=${cacheBuster}`);
                if (!response.ok) {
                    // If fetch fails, throw an error instead of using fallback
                    throw new Error(`Failed to fetch ${url} (status: ${response.status})`);
                }
                const csvText = await response.text();
                 if (!csvText || csvText.trim().length === 0) {
                     // If file is empty, return empty array
                     console.warn(`${url} is empty.`);
                     return [];
                 }
                return parseCSV(csvText);
            } catch (error) {
                console.error(`Error fetching or parsing ${url}: ${error}`);
                throw error; // Re-throw the error to be caught by loadInitialData
            }
        }

        async function refreshAllDataAndViews() {
            try {
                 allEvents = await getAllDataFromDB();
                 // Sort by Gregorian year primarily, then Hijri year if available, then ID
                 allEvents.sort((a, b) => {
                     const yearA = parseInt(a['عیسوی سال (تقریباً)']) || 0;
                     const yearB = parseInt(b['عیسوی سال (تقریباً)']) || 0;
                     if (yearA !== yearB) return yearA - yearB;

                     // Optional: Secondary sort by Hijri year if numeric
                     const hijriA = parseInt(a['ہجری سال / دور']) || 0;
                     const hijriB = parseInt(b['ہجری سال / دور']) || 0;
                     if (hijriA !== hijriB) return hijriA - hijriB;

                     return a[KEY_PATH] - b[KEY_PATH]; // Fallback to ID
                 });

                 applyFiltersAndRender();
                 populateFilterOptions();
            } catch (error) {
                 console.error("Error refreshing data:", error);
                 showToast("ڈیٹا ریفریش کرنے میں خرابی: " + error.message, "error");
            }
        }

        // --- UI Rendering Functions ---
        function renderEventCard(event) {
            const card = document.createElement('div');
            card.className = 'event-card';
            card.innerHTML = `
                <h3>${event['واقعہ (اردو)'] || 'نامعلوم واقعہ'}</h3>
                <p class="meta-info">
                    <strong>عیسوی سال:</strong> ${event['عیسوی سال (تقریباً)'] || 'نامعلوم'} |
                    <strong>ہجری سال / دور:</strong> ${event['ہجری سال / دور'] || 'نامعلوم'}
                </p>
                <p>${event['مختصر تفصیل (اردو)'] || 'کوئی مختصر تفصیل دستیاب نہیں'}</p>
                <button class="details-button" data-id="${event['شمار']}">مزید تفصیلات</button>
            `;
            card.querySelector('.details-button').addEventListener('click', () => showEventModal(event['شمار']));
            return card;
        }

        // ... rest of your code ...

      function renderEventList(eventsToRender) {
            // Clear *only* the event cards content, but keep the pagination container if it exists
            const existingPagination = eventListView.querySelector('.pagination');
            if (existingPagination) {
                // Remove all children except the pagination container
                while (eventListView.firstChild && eventListView.firstChild !== existingPagination) {
                    eventListView.removeChild(eventListView.firstChild);
                }
            } else {
                 // If no pagination exists yet, clear everything to start fresh
                 eventListView.innerHTML = '';
            }


            // Calculate pagination
            totalPages = Math.ceil(eventsToRender.length / EVENTS_PER_PAGE);
            const paginatedEvents = eventsToRender.slice((currentPage - 1) * EVENTS_PER_PAGE, currentPage * EVENTS_PER_PAGE);

            // Find or create the pagination container
            let paginationContainer = document.querySelector('#eventListView .pagination');
            if (!paginationContainer) {
                console.log("Creating pagination container..."); // Debugging
                paginationContainer = document.createElement('div');
                paginationContainer.className = 'pagination';
                paginationContainer.innerHTML = `
                    <button id="prevPageBtn"><i class="fas fa-chevron-right"></i> پچھلا</button>
                    <span id="pageInfo">صفحہ 1</span>
                    <button id="nextPageBtn">اگلا <i class="fas fa-chevron-left"></i></button>
                `;
                 // Append it after the event list content area
                 eventListView.appendChild(paginationContainer); // Append directly to eventListView


                 // Re-get references to the buttons if they were just created
                 // Use the 'let' variables declared at the top
                 prevPageBtn = document.getElementById('prevPageBtn');
                 nextPageBtn = document.getElementById('nextPageBtn');
                 pageInfoSpan = document.getElementById('pageInfo');

                 // --- Attach listeners if they weren't already ---
                 if (prevPageBtn && nextPageBtn) {
                      if (!prevPageBtn._hasClickListener) {
                           prevPageBtn.addEventListener('click', () => handlePaginationClick('prev'));
                           prevPageBtn._hasClickListener = true;
                           console.log("Attached prevPageBtn listener in renderEventList."); // Debugging
                      }
                       if (!nextPageBtn._hasClickListener) {
                           nextPageBtn.addEventListener('click', () => handlePaginationClick('next'));
                           nextPageBtn._hasClickListener = true;
                           console.log("Attached nextPageBtn listener in renderEventList."); // Debugging
                       }
                 } else {
                      console.error("Pagination buttons not found after creation attempt!");
                 }
            } else {
                 console.log("Pagination container already exists."); // Debugging
            }


            if (paginatedEvents.length === 0) {
                emptyStateMessages.eventListView.style.display = 'block';
                 if (paginationContainer) paginationContainer.style.display = 'none'; // Safely hide pagination
                return;
            }
            emptyStateMessages.eventListView.style.display = 'none';
             if (paginationContainer) paginationContainer.style.display = 'flex'; // Safely show pagination


            const fragment = document.createDocumentFragment();
            paginatedEvents.forEach(event => {
                fragment.appendChild(renderEventCard(event));
            });

             // Append event cards *before* the pagination container
            eventListView.insertBefore(fragment, paginationContainer);


            // Update pagination controls
            if (pageInfoSpan && prevPageBtn && nextPageBtn) {
                pageInfoSpan.textContent = `صفحہ ${currentPage} از ${totalPages}`;
                prevPageBtn.disabled = currentPage === 1;
                nextPageBtn.disabled = currentPage === totalPages;
                 console.log(`Pagination updated: Page ${currentPage}/${totalPages}`); // Debugging
            } else {
                 console.error("Pagination control elements are null after render!");
            }
        }

        function showEventModal(eventId) {
            const event = allEvents.find(e => e['شمار'] === eventId);
            if (!event) {
                console.error("Event not found for modal:", eventId);
                showToast("واقعہ کی تفصیلات نہیں ملیں۔", "error");
                return;
            }

            document.getElementById('modalTitle').textContent = event['واقعہ (اردو)'] || 'نامعلوم واقعہ';
            document.getElementById('modalGregorianYear').textContent = event['عیسوی سال (تقریباً)'] || 'نامعلوم';
            document.getElementById('modalHijriYear').textContent = event['ہجری سال / دور'] || 'نامعلوم';
            document.getElementById('modalShortDescription').textContent = event['مختصر تفصیل (اردو)'] || 'کوئی مختصر تفصیل دستیاب نہیں';
            document.getElementById('modalDetailedExplanation').textContent = event['تفصیلی وضاحت'] || 'کوئی تفصیلی وضاحت دستیاب نہیں';

            const personalitiesContainer = document.getElementById('modalPersonalities');
            personalitiesContainer.innerHTML = '';
            if (Array.isArray(event['متعلقہ شخصیات']) && event['متعلقہ شخصیات'].length > 0) {
                 event['متعلقہ شخصیات'].forEach((person, index) => {
                     const personSpan = document.createElement('span');
                     personSpan.textContent = person;
                     // Make personalities clickable to filter? Or just list? Listing for now.
                     personalitiesContainer.appendChild(personSpan);
                     if (index < event['متعلقہ شخصیات'].length - 1) {
                         personalitiesContainer.appendChild(document.createTextNode(', '));
                     }
                 });
            } else {
                personalitiesContainer.textContent = 'کوئی نہیں';
            }

            document.getElementById('modalLocation').textContent = event['مقام'] || 'نامعلوم';
            document.getElementById('modalCoordinates').textContent = event['نقشہ_کوآرڈینیٹس'] || 'دستیاب نہیں';
            document.getElementById('modalImageRef').textContent = event['تصویری_حوالہ'] || 'دستیاب نہیں';

            const tagsContainer = document.getElementById('modalTags');
            tagsContainer.innerHTML = '';
            if (Array.isArray(event['ٹیگز']) && event['ٹیگز'].length > 0) {
                event['ٹیگز'].forEach(tagText => {
                    const tagEl = document.createElement('span');
                    tagEl.className = 'tag';
                    tagEl.textContent = tagText;
                    tagEl.style.cursor = 'pointer'; // Make tags clickable
                    tagEl.title = `ٹیگ "${tagText}" کے واقعات فلٹر کریں`;
                    tagEl.addEventListener('click', () => {
                         modal.style.display = 'none'; // Close modal
                         tagFilter.value = tagText; // Set filter
                         handleFilterChange(); // Apply filter
                         activateTab('eventListView'); // Switch to list view
                    });
                    tagsContainer.appendChild(tagEl);
                });
            } else {
                tagsContainer.textContent = 'کوئی نہیں';
            }

            modal.style.display = 'block';
        }

        function populateFilterOptions() {
            const periods = new Set();
            const tags = new Set();
            const locations = new Set();

            allEvents.forEach(event => {
                if (event['ہجری سال / دور']) periods.add(event['ہجری سال / دور']);
                if (Array.isArray(event['ٹیگز'])) {
                    event['ٹیگز'].forEach(tag => tags.add(tag));
                }
                 if (event['مقام'] && event['مقام'] !== 'نامعلوم') {
                     locations.add(event['مقام']);
                 }
            });

            // Sort periods (basic sort, might need custom sort for complex periods)
            const sortedPeriods = Array.from(periods).sort();
            periodFilter.innerHTML = '<option value="">تمام ادوار</option>';
            sortedPeriods.forEach(p => {
                const option = document.createElement('option');
                option.value = p;
                option.textContent = p;
                periodFilter.appendChild(option);
            });

            const sortedTags = Array.from(tags).sort();
            tagFilter.innerHTML = '<option value="">تمام ٹیگز</option>';
            sortedTags.forEach(t => {
                const option = document.createElement('option');
                option.value = t;
                option.textContent = t;
                tagFilter.appendChild(option);
            });

            const sortedLocations = Array.from(locations).sort();
            locationFilter.innerHTML = '<option value="">تمام مقامات</option>';
            sortedLocations.forEach(loc => {
                 const option = document.createElement('option');
                 option.value = loc;
                 option.textContent = loc;
                 locationFilter.appendChild(option);
            });

             // Restore filter selections if they exist in currentFilters
             if (currentFilters.period) periodFilter.value = currentFilters.period;
             if (currentFilters.tag) tagFilter.value = currentFilters.tag;
             if (currentFilters.location) locationFilter.value = currentFilters.location;
        }

        function applyFiltersAndRender() {
            filteredEvents = allEvents;

            if (currentFilters.searchTerm) {
                const term = currentFilters.searchTerm.toLowerCase();
                filteredEvents = filteredEvents.filter(event =>
                    (event['واقعہ (اردو)'] && event['واقعہ (اردو)'].toLowerCase().includes(term)) ||
                    (event['مختصر تفصیل (اردو)'] && event['مختصر تفصیل (اردو)'].toLowerCase().includes(term)) ||
                    (event['تفصیلی وضاحت'] && event['تفصیلی وضاحت'].toLowerCase().includes(term)) ||
                    (Array.isArray(event['متعلقہ شخصیات']) && event['متعلقہ شخصیات'].some(p => p.toLowerCase().includes(term))) ||
                    (Array.isArray(event['ٹیگز']) && event['ٹیگز'].some(t => t.toLowerCase().includes(term))) ||
                    (event['مقام'] && event['مقام'].toLowerCase().includes(term)) ||
                     (event['ہجری سال / دور'] && event['ہجری سال / دور'].toLowerCase().includes(term)) ||
                     (event['عیسوی سال (تقریباً)'] && String(event['عیسوی سال (تقریباً)']).includes(term))
                );
            }

            if (currentFilters.period) {
                filteredEvents = filteredEvents.filter(event => event['ہجری سال / دور'] === currentFilters.period);
            }

            if (currentFilters.tag) {
                filteredEvents = filteredEvents.filter(event => Array.isArray(event['ٹیگز']) && event['ٹیگز'].includes(currentFilters.tag));
            }

             if (currentFilters.location) {
                 filteredEvents = filteredEvents.filter(event => event['مقام'] === currentFilters.location);
             }

            // Reset pagination to page 1 whenever filters change
            currentPage = 1;

            // Render based on the active tab
            renderActiveTabContent();
        }

        function renderActiveTabContent() {
             // Hide all empty state messages first
            Object.values(emptyStateMessages).forEach(msg => msg.style.display = 'none');

            switch (activeTab) {
                case 'eventListView':
                    renderEventList(filteredEvents);
                    break;
                case 'timelineView':
                    renderTimeline(filteredEvents);
                    break;
                case 'chartsView':
                    renderCharts(filteredEvents);
                    break;
                case 'mapView':
                    renderMap(filteredEvents);
                    break;
                case 'personalitiesView':
                    renderPersonalitiesView(filteredEvents);
                    break;
                case 'groupedView':
                    renderGroupedEvents(filteredEvents);
                    break;
            }
        }

        function showLoading(isLoading) {
            loadingIndicator.style.display = isLoading ? 'block' : 'none';
        }

        function showToast(message, type = 'info') { // type can be 'info', 'success', 'error', 'warning'
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toast.style.position = 'fixed';
            toast.style.bottom = '20px';
            toast.style.right = '20px';
            toast.style.padding = '10px 20px';
            toast.style.borderRadius = '5px';
            toast.style.color = 'white';
            toast.style.zIndex = '10000'; // Ensure it's on top
            toast.style.fontFamily = 'var(--font-family-urdu)';
            toast.style.maxWidth = '300px';
            toast.style.wordBreak = 'break-word';

            if (type === 'success') toast.style.backgroundColor = "var('--success-bg')";
            else if (type === 'error') toast.style.backgroundColor = "var('--danger-bg')";
            else if (type === 'warning') toast.style.backgroundColor = "var('--warning-bg')";
            else toast.style.backgroundColor = "var('--accent-color')";

            document.body.appendChild(toast);
            setTimeout(() => {
                toast.remove();
            }, 4000); // Show for 4 seconds
        }

        // --- Visualization Functions (SVG) ---
         function renderTimeline(eventsToRender) {
            timelineSvg.innerHTML = ''; // Clear previous
            tooltip.style.opacity = '0'; // Hide tooltip

            const eventsWithYear = eventsToRender.filter(e => !isNaN(parseInt(e['عیسوی سال (تقریباً)'])));

            if (eventsWithYear.length === 0) {
                emptyStateMessages.timelineView.style.display = 'block';
                return;
            }
            emptyStateMessages.timelineView.style.display = 'none';

            // Use getBoundingClientRect for accurate width, fallback to default
            const containerWidth = timelineSvg.parentElement.getBoundingClientRect().width;
            const width = Math.max(containerWidth, 1000); // Ensure minimum width for detailed timeline
            const height = 400;
            const margin = { top: 40, right: 50, bottom: 60, left: 50 };
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            timelineSvg.setAttribute("width", width); // Set SVG width dynamically
            timelineSvg.setAttribute("height", height); // Set SVG height

            const years = eventsWithYear.map(e => parseInt(e['عیسوی سال (تقریباً)']));
            const minYear = Math.min(...years);
            const maxYear = Math.max(...years);

            // Add padding to the year range
            const yearRangePadding = Math.max(5, Math.ceil((maxYear - minYear) * 0.1)); // 10% padding, min 5 years
            const paddedMinYear = minYear - yearRangePadding;
            const paddedMaxYear = maxYear + yearRangePadding;


            // Create a scale for X axis
            const xScale = (year) => {
                if (paddedMaxYear === paddedMinYear) return innerWidth / 2;
                return ((year - paddedMinYear) / (paddedMaxYear - paddedMinYear)) * innerWidth;
            };

            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("transform", `translate(${margin.left},${margin.top})`);
            timelineSvg.appendChild(g);

            // Draw X axis line
            const xAxisLine = document.createElementNS("http://www.w3.org/2000/svg", "line");
            xAxisLine.setAttribute("x1", 0);
            xAxisLine.setAttribute("y1", innerHeight);
            xAxisLine.setAttribute("x2", innerWidth);
            xAxisLine.setAttribute("y2", innerHeight);
            xAxisLine.setAttribute("stroke", "var(--text-color)");
            xAxisLine.classList.add("timeline-axis");
            g.appendChild(xAxisLine);

             // Add year labels and ticks
            const yearSpan = paddedMaxYear - paddedMinYear;
            const approxNumTicks = Math.min(15, yearSpan + 1); // Max 15 ticks or total years + 1
            const tickInterval = Math.max(1, Math.round(yearSpan / approxNumTicks));

            for (let year = paddedMinYear; year <= paddedMaxYear; year += tickInterval) {
                const xPos = xScale(year);

                const tickMark = document.createElementNS("http://www.w3.org/2000/svg", "line");
                tickMark.setAttribute("x1", xPos);
                tickMark.setAttribute("y1", innerHeight);
                tickMark.setAttribute("x2", xPos);
                tickMark.setAttribute("y2", innerHeight + 5);
                tickMark.setAttribute("stroke", "var(--text-color)");
                 tickMark.classList.add("timeline-axis");
                g.appendChild(tickMark);

                const yearLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
                yearLabel.setAttribute("x", xPos);
                yearLabel.setAttribute("y", innerHeight + 20);
                yearLabel.setAttribute("text-anchor", "middle");
                yearLabel.setAttribute("fill", "var(--text-color)");
                yearLabel.style.fontFamily = "var(--font-family-urdu)";
                yearLabel.style.fontSize = "12px";
                yearLabel.textContent = year;
                 yearLabel.classList.add("timeline-axis");
                g.appendChild(yearLabel);
            }

             // Axis title
            const axisTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            axisTitle.setAttribute("x", innerWidth / 2);
            axisTitle.setAttribute("y", innerHeight + 45);
            axisTitle.setAttribute("text-anchor", "middle");
            axisTitle.setAttribute("fill", "var(--text-color)");
            axisTitle.style.fontFamily = "var(--font-family-urdu)";
            axisTitle.style.fontWeight = "bold";
            axisTitle.textContent = "عیسوی سال (تقریباً)";
            g.appendChild(axisTitle);


            // Plot events
            // Use a simple stacking mechanism for events in the same year
            const eventsByYear = eventsWithYear.reduce((acc, event) => {
                const year = parseInt(event['عیسوی سال (تقریباً)']);
                if (!acc[year]) acc[year] = [];
                acc[year].push(event);
                return acc;
            }, {});

            Object.entries(eventsByYear).forEach(([year, eventsInYear]) => {
                 const baseCx = xScale(parseInt(year));
                 eventsInYear.forEach((event, index) => {
                    const cx = baseCx;
                    // Stagger Y position
                    const cy = innerHeight - 20 - (index % 5) * 15; // Max 5 levels before repeating

                    const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                    circle.setAttribute("cx", cx);
                    circle.setAttribute("cy", cy);
                    circle.setAttribute("r", 5); // Fixed radius for simplicity
                    circle.setAttribute("fill", "var(--accent-color)");
                    circle.classList.add("timeline-event-marker");
                    circle.dataset.id = event['شمار'];

                    circle.addEventListener('mouseover', (e) => {
                        // Build rich tooltip content
                        let tooltipContent = `<strong>${event['واقعہ (اردو)'] || 'نامعلوم واقعہ'}</strong>`;
                        tooltipContent += `<br>عیسوی: ${event['عیسوی سال (تقریباً)'] || 'نامعلوم'} | ہجری/دور: ${event['ہجری سال / دور'] || 'نامعلوم'}`;
                        if (event['مختصر تفصیل (اردو)']) {
                            tooltipContent += `<br>${event['مختصر تفصیل (اردو)']}`;
                        }
                         if (event['مقام'] && event['مقام'] !== 'نامعلوم') {
                            tooltipContent += `<br>مقام: ${event['مقام']}`;
                         }
                         if (Array.isArray(event['متعلقہ شخصیات']) && event['متعلقہ شخصیات'].length > 0) {
                             tooltipContent += `<br>شخصیات: ${event['متعلقہ شخصیات'].join(', ')}`;
                         }
                         if (Array.isArray(event['ٹیگز']) && event['ٹیگز'].length > 0) {
                             tooltipContent += `<br>ٹیگز: ${event['ٹیگز'].join(', ')}`;
                         }


                        tooltip.innerHTML = tooltipContent;
                        tooltip.style.opacity = '0.9';

                        // Position tooltip near cursor, adjusting for RTL and screen edge
                        const mouseX = e.pageX;
                        const mouseY = e.pageY;
                        const tooltipWidth = tooltip.offsetWidth;
                        const tooltipHeight = tooltip.offsetHeight;
                        const windowWidth = window.innerWidth;
                        const windowHeight = window.innerHeight;

                        let tooltipLeft = mouseX + 15; // Default position to the right (in LTR sense)
                        let tooltipTop = mouseY + 15; // Default position below

                        // Adjust for RTL (position to the left of cursor)
                         tooltipLeft = mouseX - tooltipWidth - 15;


                        // Prevent tooltip from going off-screen (right/left edge)
                        if (tooltipLeft < 5) { // Too far left
                            tooltipLeft = mouseX + 15; // Position to the right
                        }
                         if (tooltipLeft + tooltipWidth > windowWidth - 5) { // Too far right
                             tooltipLeft = windowWidth - tooltipWidth - 5;
                         }


                        // Prevent tooltip from going off-screen (bottom edge)
                        if (tooltipTop + tooltipHeight > windowHeight - 5) {
                            tooltipTop = mouseY - tooltipHeight - 15; // Position above
                        }
                         // Prevent tooltip from going off-screen (top edge)
                         if (tooltipTop < 5) {
                             tooltipTop = 5;
                         }


                        tooltip.style.left = tooltipLeft + 'px';
                        tooltip.style.top = tooltipTop + 'px';
                    });
                    circle.addEventListener('mouseout', () => {
                        tooltip.style.opacity = '0';
                    });
                    circle.addEventListener('click', () => showEventModal(event['شمار']));
                    g.appendChild(circle);
                });
            });
        }




        function renderBarChart(svgElement, data, title, dataLabelKey, dataValueKey) {
            svgElement.innerHTML = ''; // Clear previous
            if (data.length === 0) {
                 svgElement.innerHTML = `<text x="50%" y="50%" text-anchor="middle" fill="var(--text-color)">${title} کے لیے ڈیٹا نہیں۔</text>`;
                 return;
            }

            const containerWidth = svgElement.parentElement.getBoundingClientRect().width;
            const width = Math.max(containerWidth, 400); // Minimum width
            const height = 300;
            const margin = { top: 30, right: 20, bottom: 90, left: 50 }; // Increased bottom margin for labels
            const innerWidth = width - margin.left - margin.right;
            const innerHeight = height - margin.top - margin.bottom;

            svgElement.setAttribute("width", width);

            const g = document.createElementNS("http://www.w3.org/2000/svg", "g");
            g.setAttribute("transform", `translate(${margin.left},${margin.top})`);
            svgElement.appendChild(g);

            const maxValue = Math.max(...data.map(d => d[dataValueKey]));
            const barWidth = innerWidth / data.length * 0.7;
            const barSpacing = innerWidth / data.length * 0.3;


            data.forEach((d, i) => {
                const barHeight = (d[dataValueKey] / maxValue) * innerHeight;
                const x = i * (barWidth + barSpacing);
                const y = innerHeight - barHeight;

                const rect = document.createElementNS("http://www.w3.org/2000/svg", "rect");
                rect.setAttribute("x", x);
                rect.setAttribute("y", y);
                rect.setAttribute("width", barWidth);
                rect.setAttribute("height", barHeight);
                rect.setAttribute("fill", "var(--accent-color)");
                 rect.style.transition = 'fill 0.3s';
                 rect.addEventListener('mouseover', () => rect.setAttribute('fill', 'var(--accent-color-dark)'));
                 rect.addEventListener('mouseout', () => rect.setAttribute('fill', 'var(--accent-color)'));
                g.appendChild(rect);

                // Value label on bar
                const valueLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
                valueLabel.setAttribute("x", x + barWidth / 2);
                valueLabel.setAttribute("y", y - 5); // Position above bar
                valueLabel.setAttribute("text-anchor", "middle");
                valueLabel.setAttribute("fill", "var(--text-color)");
                valueLabel.style.fontSize = "10px";
                valueLabel.textContent = d[dataValueKey];
                g.appendChild(valueLabel);

                // Category label below bar
                const catLabel = document.createElementNS("http://www.w3.org/2000/svg", "text");
                catLabel.setAttribute("x", x + barWidth / 2);
                catLabel.setAttribute("y", innerHeight + 15);
                catLabel.setAttribute("text-anchor", "middle");
                catLabel.setAttribute("fill", "var(--text-color)");
                catLabel.style.fontFamily = "var(--font-family-urdu)";
                catLabel.style.fontSize = "12px";
                 // Rotate labels if needed (simple check)
                 if (data.length > 8 || data[i][dataLabelKey].length > 10) {
                    catLabel.setAttribute("transform", `rotate(-45 ${x + barWidth / 2},${innerHeight + 15})`);
                    catLabel.setAttribute("text-anchor", "end"); // Adjust anchor point after rotation
                    catLabel.setAttribute("dx", "-0.5em"); // Shift slightly
                    catLabel.setAttribute("dy", "0.5em"); // Shift slightly
                 }
                catLabel.textContent = d[dataLabelKey];
                g.appendChild(catLabel);
            });

            // Chart title
            const chartTitle = document.createElementNS("http://www.w3.org/2000/svg", "text");
            chartTitle.setAttribute("x", width / 2);
            chartTitle.setAttribute("y", margin.top / 2 + 5);
            chartTitle.setAttribute("text-anchor", "middle");
            chartTitle.setAttribute("fill", "var(--accent-color)");
            chartTitle.style.fontFamily = "var(--font-family-urdu)";
            chartTitle.style.fontWeight = "bold";
            chartTitle.textContent = title;
            svgElement.appendChild(chartTitle);
        }


        function renderCharts(eventsToRender) {
            if (eventsToRender.length === 0) {
                emptyStateMessages.chartsView.style.display = 'block';
                tagsChartSvg.innerHTML = '';
                periodsChartSvg.innerHTML = '';
                locationsChartSvg.innerHTML = '';
                return;
            }
            emptyStateMessages.chartsView.style.display = 'none';

            // Tags chart
            const tagCounts = {};
            eventsToRender.forEach(event => {
                if (Array.isArray(event['ٹیگز'])) {
                    event['ٹیگز'].forEach(tag => {
                        if(tag) tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                    });
                }
            });
            const tagData = Object.entries(tagCounts).map(([tag, count]) => ({ tag, count })).sort((a,b) => b.count - a.count).slice(0,15); // Top 15 tags
            renderBarChart(tagsChartSvg, tagData, "ٹاپ 15 ٹیگز کے لحاظ سے واقعات", "tag", "count");

            // Periods chart
            const periodCounts = {};
             eventsToRender.forEach(event => {
                 if(event['ہجری سال / دور']) periodCounts[event['ہجری سال / دور']] = (periodCounts[event['ہجری سال / دور']] || 0) + 1;
             });
            const periodData = Object.entries(periodCounts).map(([period, count]) => ({ period, count })).sort((a,b) => b.period.localeCompare(a.period, 'ur', { numeric: true })); // Sort periods alphabetically/numerically
            renderBarChart(periodsChartSvg, periodData, "ادوار کے لحاظ سے واقعات", "period", "count");

             // Locations chart
             const locationCounts = {};
             eventsToRender.forEach(event => {
                 if(event['مقام'] && event['مقام'] !== 'نامعلوم') locationCounts[event['مقام']] = (locationCounts[event['مقام']] || 0) + 1;
             });
             const locationData = Object.entries(locationCounts).map(([location, count]) => ({ location, count })).sort((a,b) => b.count - a.count).slice(0,15); // Top 15 locations
             renderBarChart(locationsChartSvg, locationData, "ٹاپ 15 مقامات کے لحاظ سے واقعات", "location", "count");
        }

        function renderMap(eventsToRender) {
            mapLocationList.innerHTML = ''; // Clear previous list
            mapSvg.innerHTML = ''; // Clear previous SVG content
            tooltip.style.opacity = '0'; // Hide tooltip

            const eventsWithCoords = eventsToRender.filter(e => e['مقام'] && e['مقام'] !== 'نامعلوم' && e['نقشہ_کوآرڈینیٹس']);

            if (eventsWithCoords.length === 0) {
                emptyStateMessages.mapView.style.display = 'block';
                mapLocationList.innerHTML = '<li>نقشے کے لیے کوئی مقامات دستیاب نہیں۔</li>';
                return;
            }
            emptyStateMessages.mapView.style.display = 'none';

            // Basic SVG Map Placeholder - Draw points for locations
            const width = mapSvg.clientWidth || 800;
            const height = 500;

            // Simple coordinate scaling (this is highly simplified and assumes coordinates within a certain range)
            // A real map would require proper projection and geographic data.
            // Assuming coordinates are roughly within Saudi Arabia/Middle East
            const minLat = 20; maxLat = 30; // Example range
            const minLon = 35; maxLon = 45; // Example range

            const xScale = (lon) => ((lon - minLon) / (maxLon - minLon)) * width;
            // Latitude scale needs to be inverted for SVG Y axis (top is 0)
            const yScale = (lat) => height - ((lat - minLat) / (maxLat - minLat)) * height;

            // Add a background rectangle for the map area
            const mapBackground = document.createElementNS("http://www.w3.org/2000/svg", "rect");
            mapBackground.setAttribute("x", 0);
            mapBackground.setAttribute("y", 0);
            mapBackground.setAttribute("width", width);
            mapBackground.setAttribute("height", height);
            mapBackground.setAttribute("fill", "#e0f2f7"); // Light blue background
            mapSvg.appendChild(mapBackground);

            // Draw points for each unique location
            const locationsMap = new Map(); // Map to store events by location string
            eventsWithCoords.forEach(event => {
                 if (!locationsMap.has(event['مقام'])) {
                     locationsMap.set(event['مقام'], []);
                 }
                 locationsMap.get(event['مقام']).push(event);
            });

            locationsMap.forEach((eventsAtLocation, locationName) => {
                 const coords = eventsAtLocation[0]['نقشہ_کوآرڈینیٹس'].split(',').map(c => parseFloat(c.trim())).filter(c => !isNaN(c));
                 if (coords.length === 2) {
                     const lon = coords[1]; // Longitude is X
                     const lat = coords[0]; // Latitude is Y

                     // Check if coordinates are within assumed range, otherwise skip or warn
                     if (lon >= minLon && lon <= maxLon && lat >= minLat && lat <= maxLat) {
                         const cx = xScale(lon);
                         const cy = yScale(lat);

                         const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
                         circle.setAttribute("cx", cx);
                         circle.setAttribute("cy", cy);
                         circle.setAttribute("r", 7 + eventsAtLocation.length * 0.5); // Radius based on number of events
                         circle.setAttribute("fill", "var(--danger-bg)"); // Use a distinct color for locations
                         circle.setAttribute("opacity", 0.8);
                         circle.style.cursor = 'pointer';
                         circle.dataset.location = locationName; // Store location name

                         circle.addEventListener('mouseover', (e) => {
                             tooltip.innerHTML = `<strong>${locationName}</strong><br>${eventsAtLocation.length} واقعات`;
                             tooltip.style.opacity = '0.9';
                             // Position tooltip near cursor
                             tooltip.style.left = (e.pageX - tooltip.offsetWidth - 10) + 'px';
                             tooltip.style.top = (e.pageY + 10) + 'px';
                         });
                         circle.addEventListener('mouseout', () => {
                             tooltip.style.opacity = '0';
                         });
                         circle.addEventListener('click', () => {
                             // Filter by this location and switch to list view
                             locationFilter.value = locationName;
                             handleFilterChange();
                             activateTab('eventListView');
                         });
                         mapSvg.appendChild(circle);

                         // Add location label
                         const text = document.createElementNS("http://www.w3.org/2000/svg", "text");
                         text.setAttribute("x", cx + 10); // Offset text
                         text.setAttribute("y", cy);
                         text.setAttribute("fill", "var(--text-color)");
                         text.style.fontFamily = "var(--font-family-urdu)";
                         text.style.fontSize = "12px";
                         text.textContent = locationName;
                         mapSvg.appendChild(text);

                     } else {
                         console.warn(`Location "${locationName}" has coordinates outside assumed range: ${event['نقشہ_کوآرڈینیٹس']}`);
                     }
                 } else {
                     console.warn(`Location "${locationName}" has invalid coordinates: ${event['نقشہ_کوآرڈینیٹس']}`);
                 }
            });


            // Also render the list below the map
            eventsWithCoords.forEach(event => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `<strong>${event['واقعہ (اردو)']}</strong>: ${event['مقام']} (${event['نقشہ_کوآرڈینیٹس']})`;
                listItem.style.cursor = 'pointer';
                listItem.addEventListener('click', () => showEventModal(event['شمار']));
                mapLocationList.appendChild(listItem);
            });
        }


        function renderPersonalitiesView(eventsToRender) {
            personalitiesListContainer.innerHTML = '';
            const personalityMap = new Map();

            eventsToRender.forEach(event => {
                if (Array.isArray(event['متعلقہ شخصیات'])) {
                    event['متعلقہ شخصیات'].forEach(person => {
                        if (person) { // Ensure person name is not empty
                            if (!personalityMap.has(person)) {
                                personalityMap.set(person, []);
                            }
                            // Avoid adding duplicate events for the same person (based on ID)
                            if (!personalityMap.get(person).some(e => e.id === event['شمار'])) {
                                personalityMap.get(person).push({
                                    id: event['شمار'],
                                    name: event['واقعہ (اردو)'] || 'نامعلوم واقعہ',
                                    year: event['عیسوی سال (تقریباً)'] || 'نامعلوم'
                                });
                            }
                        }
                    });
                }
            });

            if (personalityMap.size === 0) {
                emptyStateMessages.personalitiesView.style.display = 'block';
                return;
            }
            emptyStateMessages.personalitiesView.style.display = 'none';

            const sortedPersonalities = Array.from(personalityMap.keys()).sort((a, b) => a.localeCompare(b, 'ur'));

            sortedPersonalities.forEach(person => {
                const personDiv = document.createElement('div');
                personDiv.className = 'personality-group';

                const personHeader = document.createElement('h5');
                personHeader.textContent = person;
                personDiv.appendChild(personHeader);

                const eventListUl = document.createElement('ul');
                // Sort events related to this person by year
                const sortedEvents = personalityMap.get(person).sort((a, b) => (parseInt(a.year) || 0) - (parseInt(b.year) || 0));

                sortedEvents.forEach(eventInfo => {
                    const eventLi = document.createElement('li');
                    eventLi.innerHTML = `<a href="#" data-event-id="${eventInfo.id}" title="${eventInfo.name}">${eventInfo.name} (${eventInfo.year})</a>`;
                    eventLi.querySelector('a').addEventListener('click', (e) => {
                        e.preventDefault();
                        showEventModal(eventInfo.id);
                    });
                    eventListUl.appendChild(eventLi);
                });
                personDiv.appendChild(eventListUl);
                personalitiesListContainer.appendChild(personDiv);
            });
        }

                function renderGroupedEvents(eventsToRender) {
            groupedEventsContainer.innerHTML = '';
            const groupsMap = new Map();

            // --- Intelligent Grouping Logic ---
            eventsToRender.forEach(event => {
                 // Prioritize explicit 'گروپ' property if it exists
                 let groupName = event['گروپ'];

                 if (!groupName || groupName === 'دیگر واقعات' || groupName.trim() === '') {
                     // If no explicit group, try to group by significant properties
                     // Group by Hijri Year / Period first
                     if (event['ہجری سال / دور'] && event['ہجری سال / دور'] !== 'نامعلوم') {
                         groupName = `دور: ${event['ہجری سال / دور']}`;
                     }
                     // Then try grouping by main location if available and not already grouped by period
                     else if (event['مقام'] && event['مقام'] !== 'نامعلوم') {
                         groupName = `مقام: ${event['مقام']}`;
                     }
                     // Fallback to a generic group if no specific criteria met
                     else {
                        groupName = 'دیگر واقعات';
                     }
                 }


                 if (!groupsMap.has(groupName)) {
                     groupsMap.set(groupName, []);
                 }
                 groupsMap.get(groupName).push(event);
            });

             // Sort groups alphabetically, with 'دیگر واقعات' usually last
            const sortedGroups = Array.from(groupsMap.keys()).sort((a, b) => {
                 if (a === 'دیگر واقعات') return 1;
                 if (b === 'دیگر واقعات') return -1;
                 return a.localeCompare(b, 'ur');
            });


            if (sortedGroups.length === 0 || (sortedGroups.length === 1 && sortedGroups[0] === 'دیگر واقعات' && groupsMap.get('دیگر واقعات').length === 0)) {
                 emptyStateMessages.groupedView.style.display = 'block';
                 return;
            }
            emptyStateMessages.groupedView.style.display = 'none';


            sortedGroups.forEach(groupName => {
                const eventsInGroup = groupsMap.get(groupName);
                 if (eventsInGroup.length === 0) return; // Skip empty groups

                const groupDiv = document.createElement('div');
                groupDiv.className = 'event-group';

                const groupHeader = document.createElement('h4');
                 groupHeader.innerHTML = `<i class="fas fa-chevron-down"></i> ${groupName} (${eventsInGroup.length})`;
                 groupHeader.classList.add('collapsed'); // Start collapsed
                groupDiv.appendChild(groupHeader);

                const groupContent = document.createElement('div');
                groupContent.className = 'event-group-content';
                groupDiv.appendChild(groupContent);

                // Sort events within the group by year
                const sortedEvents = eventsInGroup.sort((a, b) => {
                    const yearA = parseInt(a['عیسوی سال (تقریباً)']) || 0;
                    const yearB = parseInt(b['عیسوی سال (تقریباً)']) || 0;
                    if (yearA !== yearB) return yearA - yearB;
                    return a[KEY_PATH] - b[KEY_PATH]; // Fallback to ID
                });

                sortedEvents.forEach(event => {
                    groupContent.appendChild(renderEventCard(event));
                });

                // Add toggle functionality
                groupHeader.addEventListener('click', () => {
                    groupContent.classList.toggle('active');
                    groupHeader.classList.toggle('collapsed');
                    const icon = groupHeader.querySelector('i');
                    if (groupContent.classList.contains('active')) {
                         icon.classList.replace('fa-chevron-down', 'fa-chevron-up');
                    } else {
                         icon.classList.replace('fa-chevron-up', 'fa-chevron-down');
                    }
                });

                groupedEventsContainer.appendChild(groupDiv);
            });
        }

        // --- Event Handlers ---
        function handleSearch() {
            currentFilters.searchTerm = searchInput.value.trim();
            applyFiltersAndRender();
        }

        function handleFilterChange() {
            currentFilters.period = periodFilter.value;
            currentFilters.tag = tagFilter.value;
            currentFilters.location = locationFilter.value;
            applyFiltersAndRender();
        }

                function activateTab(tabId) {
            const allTabContents = document.querySelectorAll('.tab-content');
            const allTabButtons = document.querySelectorAll('.tab-button');

            if (allTabContents.length === 0 || allTabButtons.length === 0) {
                console.error("Tab buttons or tab contents not found in the DOM.");
                showToast(`ایپلیکیشن ٹیبز لوڈ کرنے میں ناکام: بنیادی عناصر غائب ہیں۔`, "error");
                return;
            }

            // Remove 'active' class and explicitly hide all tab contents
            allTabButtons.forEach(button => button.classList.remove('active'));
            allTabContents.forEach(content => {
                content.classList.remove('active');
                // Explicitly set display to none for ALL tab contents
                content.style.display = 'none';
            });

            // Add 'active' class and explicitly set display for the target tab content
            const clickedTabButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            const targetTabContent = document.getElementById(tabId);

            if (clickedTabButton && targetTabContent) {
                clickedTabButton.classList.add('active');
                targetTabContent.classList.add('active');

                // --- Set display based on tabId for the *active* tab ---
                if (tabId === 'eventListView') {
                    targetTabContent.style.display = 'grid'; // Use grid for eventListView
                } else {
                    targetTabContent.style.display = 'block'; // Use block for other tabs
                }

                activeTab = tabId; // Update the state variable

                // Now, render the content specific to the activated tab
                renderActiveTabContent();

            } else {
                console.error(`Tab button or content not found for tabId: "${tabId}".`);

                // Fallback: Activate event list if target content is missing
                const fallbackTabButton = document.querySelector('.tab-button[data-tab="eventListView"]');
                const fallbackTabContent = document.getElementById('eventListView');

                if (fallbackTabButton && fallbackTabContent) {
                    fallbackTabButton.classList.add('active');
                    fallbackTabContent.classList.add('active');
                    fallbackTabContent.style.display = 'grid'; // Use grid for fallback eventListView
                    activeTab = 'eventListView'; // Update the state variable to fallback tab
                    renderActiveTabContent();
                     showToast(`منتخب کردہ ٹیب دستیاب نہیں، واقعات کی فہرست دکھائی جا رہی ہے۔`, "warning");
                } else {
                     console.error("Fallback tab (eventListView) also not found. Cannot activate any tab.");
                     showToast(`ایپلیکیشن ٹیبز لوڈ کرنے میں ناکام۔`, "error");
                }
            }
        }

        function handleTabClick(event) {
            const clickedTab = event.target.closest('.tab-button');
            if (!clickedTab) return;
            const tabId = clickedTab.dataset.tab;
            activateTab(tabId);
        }

        function handleThemeToggle() {
            document.body.classList.toggle('dark-mode');
            localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
            // Re-render visualizations as colors might have changed
            renderActiveTabContent();
        }

        async function handleBackup() {
            showLoading(true);
            restoreStatus.textContent = "بیک اپ تیار ہو رہا ہے...";
            try {
                const dataToBackup = await getAllDataFromDB();
                if (dataToBackup.length === 0) {
                    showToast("بیک اپ کے لیے کوئی ڈیٹا موجود نہیں۔", "info");
                    restoreStatus.textContent = "بیک اپ کے لیے کوئی ڈیٹا نہیں۔";
                    return;
                }
                const jsonData = JSON.stringify(dataToBackup, null, 2);
                const blob = new Blob([jsonData], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const date = new Date().toISOString().slice(0,10);
                a.download = `seerah_events_backup_${date}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast("ڈیٹا کامیابی سے بیک اپ ہوگیا۔", "success");
                restoreStatus.textContent = "آخری بیک اپ: ابھی";
            } catch (error) {
                console.error("Backup error:", error);
                showToast("بیک اپ میں خرابی: " + error.message, "error");
                restoreStatus.textContent = "بیک اپ میں خرابی: " + error.message;
            } finally {
                 showLoading(false);
            }
        }

        async function handleRestore(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading(true);
            restoreStatus.textContent = "ڈیٹا بحال ہو رہا ہے...";

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const jsonData = e.target.result;
                    const dataToRestore = JSON.parse(jsonData);

                    if (!Array.isArray(dataToRestore) || dataToRestore.some(item => typeof item[KEY_PATH] === 'undefined' || isNaN(parseInt(item[KEY_PATH])))) {
                         throw new Error("غلط فائل فارمیٹ یا کلیدی راستہ 'شمار' غائب یا غلط ہے۔");
                    }

                    await clearStoreInDB(); // Clear existing data before restoring
                    await addDataToDB(dataToRestore); // Add new data
                    await refreshAllDataAndViews(); // Reload data and views
                    showToast("ڈیٹا کامیابی سے بحال ہوگیا۔", "success");
                    restoreStatus.textContent = `کامیابی سے بحال کیا گیا: ${file.name}`;
                } catch (error) {
                    console.error("Restore error:", error);
                    showToast("ڈیٹا بحال کرنے میں خرابی: " + error.message, "error");
                    restoreStatus.textContent = "بحالی میں خرابی: " + error.message;
                } finally {
                    restoreFileInput.value = ''; // Reset file input
                    showLoading(false);
                }
            };
            reader.onerror = (e) => {
                 console.error("FileReader error:", e);
                 showToast("فائل پڑھنے میں خرابی۔", "error");
                 restoreStatus.textContent = "فائل پڑھنے میں خرابی۔";
                 showLoading(false);
                 restoreFileInput.value = '';
            };
            reader.readAsText(file);
        }

        function handlePaginationClick(direction) {
            if (direction === 'next' && currentPage < totalPages) {
                currentPage++;
            } else if (direction === 'prev' && currentPage > 1) {
                currentPage--;
            }
            renderEventList(filteredEvents); // Re-render list for the new page
        }


        // --- Initialization ---
         async function initApp() {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // Theme setup
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark-mode');
            }

            try {
                await openDB();
                await loadInitialData(); // This also calls refreshAllDataAndViews
            } catch (error) {
                console.error("App initialization failed:", error);
                showToast("ایپلیکیشن شروع کرنے میں ناکامی: " + error.message, "error");
                showLoading(false);
                // Display a critical error message to the user if DB fails to open
                const mainContainer = document.querySelector('.container');
                if (mainContainer) {
                    mainContainer.innerHTML = `<p style="color: var(--danger-bg); text-align: center; padding: 20px;">ایپلیکیشن شروع نہیں ہو سکی۔ ڈیٹا بیس تک رسائی میں مسئلہ ہے۔ براہ کرم یقینی بنائیں کہ آپ کا براؤزر IndexedDB کو سپورٹ کرتا ہے اور پرائیویٹ موڈ میں نہیں ہے۔</p>`;
                }
                return; // Stop further execution if DB fails
            }

            // Event Listeners for static elements (like theme toggle, search, filters, tabs, modal)
            themeToggle.addEventListener('click', handleThemeToggle);
            searchInput.addEventListener('input', debounce(handleSearch, 300));
            periodFilter.addEventListener('change', handleFilterChange);
            tagFilter.addEventListener('change', handleFilterChange);
            locationFilter.addEventListener('change', handleFilterChange);

            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', handleTabClick);
            });

            modalCloseButton.addEventListener('click', () => modal.style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target == modal) {
                    modal.style.display = 'none';
                }
            });

            backupDataBtn.addEventListener('click', handleBackup);
            restoreFileInput.addEventListener('change', handleRestore);

            // --- Pagination button listeners ---
            // Attach these ONLY ONCE in initApp because the buttons are intended to be static.
            // The logic in renderEventList is now a fallback to create them if missing,
            // but the primary listener attachment should be here.
             console.log("Attempting to attach pagination listeners in initApp...");
            // Get references *again* here in case renderEventList was called before initApp finished
            // (though loadInitialData calls refreshAllDataAndViews which calls renderEventList,
            // so initApp's initial getElementById might happen before the element exists if
            // renderEventList creates it). Getting them here ensures we have the latest references.
             prevPageBtn = document.getElementById('prevPageBtn');
             nextPageBtn = document.getElementById('nextPageBtn');
             pageInfoSpan = document.getElementById('pageInfo');


            if (prevPageBtn && nextPageBtn) {
                 // Check if listeners are already attached to avoid duplicates
                 // This check is important if renderEventList also attaches them as a fallback
                 if (!prevPageBtn._hasClickListener) {
                     prevPageBtn.addEventListener('click', () => handlePaginationClick('prev'));
                     prevPageBtn._hasClickListener = true;
                     console.log("Attached prevPageBtn listener in initApp."); // Debugging
                 }
                  if (!nextPageBtn._hasClickListener) {
                     nextPageBtn.addEventListener('click', () => handlePaginationClick('next'));
                     nextPageBtn._hasClickListener = true;
                      console.log("Attached nextPageBtn listener in initApp."); // Debugging
                  }
            } else {
                 console.warn("Pagination buttons not found initially in initApp. They should be created by renderEventList.");
            }


            // Initial render based on default filters and active tab
            activateTab(activeTab); // This will call renderActiveTabContent which calls renderEventList initially
        }

        document.addEventListener('DOMContentLoaded', initApp);

        // --- handlePaginationClick function ---
        function handlePaginationClick(direction) {
             console.log(`Pagination click: ${direction}. Current page: ${currentPage}, Total pages: ${totalPages}`); // Debugging line
            if (direction === 'next' && currentPage < totalPages) {
                currentPage++;
                 console.log(`New page: ${currentPage}`); // Debugging line
            } else if (direction === 'prev' && currentPage > 1) {
                currentPage--;
                 console.log(`New page: ${currentPage}`); // Debugging line
            } else {
                 console.log("Pagination click ignored (boundary reached)."); // Debugging line
                 return; // Do nothing if boundary reached
            }
            renderEventList(filteredEvents); // Re-render list for the new page
        }

        document.addEventListener('DOMContentLoaded', initApp);

        setTimeout(() => {
            //document.querySelectorAll("body > div.container > div.pagination")[0].style.display = "none";
        }, 200);
    })();
</script>
</body>
</html>