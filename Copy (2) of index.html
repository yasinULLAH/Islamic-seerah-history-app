<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>سیرت النبی ﷺ - جامع انفوگرافک تاریخ</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap');

        :root {
            --primary-color: #006778; /* Tealish Blue */
            --secondary-color: #0093AB; /* Lighter Teal */
            --accent-color: #FFD700; /* Gold/Yellow Accent */
            --text-color: #333333;
            --bg-color: #F0F8FF; /* Alice Blue - light background */
            --card-bg-color: #FFFFFF;
            --border-color: #D1E8E2; /* Light minty green */
            --header-bg: #004852;
            --header-text: #FFFFFF;
            --font-family-urdu: 'Noto Nastaliq Urdu', serif;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        body.dark-mode {
            --primary-color: #0093AB;
            --secondary-color: #00C2CB;
            --accent-color: #FFEC8B;
            --text-color: #E0E0E0;
            --bg-color: #1A202C; /* Dark Slate Gray */
            --card-bg-color: #2D3748; /* Lighter Slate Gray */
            --border-color: #4A5568;
            --header-bg: #102a30;
            --header-text: #E0E0E0;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family-urdu);
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.8;
            transition: background-color 0.3s, color 0.3s;
            overflow-x: hidden;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 3px solid var(--accent-color);
            margin-bottom: 20px;
        }

        header h1 {
            font-size: 1.8em;
            margin: 0;
        }

        .theme-toggle-btn {
            background-color: var(--accent-color);
            color: #333;
            border: none;
            padding: 8px 12px;
            font-family: var(--font-family-urdu);
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.3s;
        }
        body.dark-mode .theme-toggle-btn {
            background-color: var(--secondary-color);
            color: var(--header-text);
        }

        .controls, .navigation-tabs {
            background-color: var(--card-bg-color);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
        }

        .controls input[type="text"],
        .controls select {
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 5px;
            font-family: var(--font-family-urdu);
            background-color: var(--bg-color);
            color: var(--text-color);
            min-width: 200px;
        }
        body.dark-mode .controls input[type="text"],
        body.dark-mode .controls select {
            background-color: #3e4c59;
        }


        .navigation-tabs button {
            padding: 10px 15px;
            font-family: var(--font-family-urdu);
            border: none;
            background-color: var(--secondary-color);
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .navigation-tabs button.active,
        .navigation-tabs button:hover {
            background-color: var(--primary-color);
        }
        body.dark-mode .navigation-tabs button {
             background-color: var(--primary-color);
        }
        body.dark-mode .navigation-tabs button.active,
        body.dark-mode .navigation-tabs button:hover {
            background-color: var(--accent-color);
            color: #333;
        }


        .view { display: none; }
        .view.active { display: block; }

        #event-list-view .event-card {
            background-color: var(--card-bg-color);
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 20px;
            box-shadow: var(--box-shadow);
            border-right: 5px solid var(--primary-color);
            transition: transform 0.2s ease-in-out;
        }
        #event-list-view .event-card:hover {
            transform: translateY(-5px);
        }

        .event-card h3 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 5px;
            font-size: 1.5em;
        }
        body.dark-mode .event-card h3 {
            color: var(--accent-color);
        }

        .event-card .meta-info {
            font-size: 0.9em;
            color: #777;
            margin-bottom: 10px;
        }
        body.dark-mode .event-card .meta-info { color: #aaa; }

        .event-card .meta-info span { margin-left: 15px; }
        .event-card .meta-info .icon { margin-right: 5px; } /* For potential icons */

        .event-card .short-detail {
            margin-bottom: 10px;
        }

        .event-card .tags span {
            background-color: var(--secondary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            margin-left: 5px;
            display: inline-block;
            margin-bottom: 5px;
        }
        body.dark-mode .event-card .tags span {
             background-color: var(--primary-color);
        }


        .event-card .actions button {
            background-color: var(--accent-color);
            color: #333;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-family: var(--font-family-urdu);
            margin-left: 10px;
            font-size: 0.9em;
        }
         body.dark-mode .event-card .actions button {
            background-color: var(--secondary-color);
            color: white;
        }


        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.6);
        }
        .modal-content {
            background-color: var(--card-bg-color);
            margin: 5% auto;
            padding: 25px;
            border: 1px solid var(--border-color);
            width: 80%;
            max-width: 700px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        .close-btn {
            color: #aaa;
            float: left; /* RTL */
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close-btn:hover, .close-btn:focus {
            color: var(--text-color);
            text-decoration: none;
        }
        #modal-event-title { color: var(--primary-color); margin-bottom: 15px; }
        body.dark-mode #modal-event-title { color: var(--accent-color); }
        .modal-section { margin-bottom: 15px; }
        .modal-section h4 { margin-bottom: 5px; color: var(--secondary-color); }
        body.dark-mode .modal-section h4 { color: var(--primary-color); }
        .modal-section ul { padding-right: 20px; }


        /* Timeline, Map, Charts Placeholder Styles */
        .infographic-placeholder {
            min-height: 300px;
            background-color: var(--card-bg-color);
            border: 2px dashed var(--border-color);
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
            font-size: 1.2em;
            color: #999;
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--box-shadow);
        }
        body.dark-mode .infographic-placeholder { color: #777; }

        /* Loading indicator */
        .loader {
            text-align: center;
            padding: 50px;
            font-size: 1.5em;
            color: var(--primary-color);
        }
         body.dark-mode .loader { color: var(--accent-color); }

        /* Utility */
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .narrative-path-selector { margin-bottom: 20px; }
        .narrative-path-selector label { margin-left: 10px; }


        /* Simple SVG Timeline attempt */
        #timeline-svg-container {
            width: 100%;
            overflow-x: auto;
            padding: 20px 0;
        }
        #timeline-svg {
            display: block;
            min-width: 1500px; /* Allow horizontal scrolling */
        }
        .timeline-axis {
            stroke: var(--text-color);
            stroke-width: 2;
        }
        .timeline-event-group:hover .timeline-event-circle {
            r: 8;
            fill: var(--accent-color);
        }
        .timeline-event-group:hover .timeline-event-text {
            font-weight: bold;
            fill: var(--primary-color);
        }
        body.dark-mode .timeline-event-group:hover .timeline-event-text {
            fill: var(--accent-color);
        }
        .timeline-event-circle {
            fill: var(--secondary-color);
            stroke: var(--primary-color);
            stroke-width: 1;
            cursor: pointer;
            transition: r 0.2s, fill 0.2s;
        }
        .timeline-event-text {
            font-family: var(--font-family-urdu);
            font-size: 12px;
            fill: var(--text-color);
            text-anchor: middle;
            cursor: pointer;
        }
        .timeline-period-rect {
            fill: var(--primary-color);
            opacity: 0.1;
        }
        .timeline-period-text {
            font-family: var(--font-family-urdu);
            font-size: 14px;
            fill: var(--primary-color);
            text-anchor: middle;
            font-weight: bold;
        }
        body.dark-mode .timeline-period-text { fill: var(--accent-color); }
        body.dark-mode .timeline-period-rect { fill: var(--accent-color); }


    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>سیرت النبی ﷺ - جامع انفوگرافک تاریخ</h1>
            <button id="themeToggleBtn" class="theme-toggle-btn">ڈارک موڈ</button>
        </header>

        <div class="controls">
            <input type="text" id="searchInput" placeholder="تلاش کریں (واقعہ، تفصیل، شخصیت، ٹیگ)">
            <select id="filterPeriod">
                <option value="">تمام ادوار</option>
                <option value="قبل از نبوت">قبل از نبوت</option>
                <option value="نبوی">نبوی (مکی)</option>
                <option value="ہجری">ہجری (مدنی)</option>
            </select>
            <select id="filterTag">
                <option value="">تمام ٹیگز</option>
                <!-- Tags will be populated by JS -->
            </select>
            <select id="filterSignificance">
                <option value="">اہمیت (تمام)</option>
                <option value="5">5 (انتہائی اہم)</option>
                <option value="4">4</option>
                <option value="3">3</option>
                <option value="2">2</option>
                <option value="1">1 (کم اہم)</option>
            </select>
        </div>

        <div class="navigation-tabs">
            <button class="tab-btn active" data-view="event-list-view">فہرستِ واقعات</button>
            <button class="tab-btn" data-view="timeline-view">ٹائم لائن</button>
            <button class="tab-btn" data-view="map-view">نقشہ</button>
            <button class="tab-btn" data-view="charts-view">شماریات</button>
            <button class="tab-btn" data-view="narrative-paths-view">موضوعاتی سفر</button>
            <button class="tab-btn" data-view="glossary-view">اصطلاحات</button>
            <button class="tab-btn" data-view="bookmarks-view">پسندیدہ</button>
        </div>
        
        <div id="narrative-paths-view" class="view narrative-path-selector">
            <label for="narrativePathSelect">ایک موضوعاتی سفر منتخب کریں:</label>
            <select id="narrativePathSelect">
                <option value="">- منتخب کریں -</option>
                <option value="hijrat">ہجرت کا سفر</option>
                <option value="treaties">اہم معاہدے</option>
                <option value="battles">اہم غزوات</option>
                 <!-- More paths can be added -->
            </select>
            <div id="narrative-path-content" class="infographic-placeholder">موضوعاتی مواد یہاں ظاہر ہوگا</div>
        </div>


        <div id="event-list-view" class="view active">
            <!-- Event cards will be dynamically inserted here -->
            <div class="loader">ڈیٹا لوڈ ہو رہا ہے...</div>
        </div>

        <div id="timeline-view" class="view">
             <div id="timeline-svg-container">
                <svg id="timeline-svg" height="400"></svg>
            </div>
            <div class="infographic-placeholder hidden">ٹائم لائن لوڈ ہو رہی ہے...</div>
        </div>

        <div id="map-view" class="view">
            <div class="infographic-placeholder">نقشے کی خصوصیت جلد آرہی ہے۔ (جیو اسپیشل ڈیٹا پر مبنی)</div>
        </div>

        <div id="charts-view" class="view">
            <div class="infographic-placeholder">شماریاتی چارٹ جلد آرہے ہیں۔</div>
        </div>

        <div id="glossary-view" class="view">
            <div class="infographic-placeholder">اہم اصطلاحات کی فہرست جلد آرہی ہے۔</div>
        </div>
        <div id="bookmarks-view" class="view">
             <div id="bookmarked-events-list"></div>
            <div class="infographic-placeholder hidden">کوئی پسندیدہ واقعہ موجود نہیں۔</div>
        </div>

    </div>

    <!-- Event Detail Modal -->
    <div id="eventDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeModalBtn">×</span>
            <h2 id="modal-event-title"></h2>
            <div class="modal-section">
                <h4>دورانیہ:</h4>
                <p id="modal-event-period"></p>
            </div>
            <div class="modal-section">
                <h4>عیسوی تاریخ:</h4>
                <p id="modal-event-gregorian-year"></p>
            </div>
            <div class="modal-section">
                <h4>مختصر تفصیل:</h4>
                <p id="modal-event-short-detail"></p>
            </div>
            <div class="modal-section">
                <h4>تفصیلی وضاحت:</h4>
                <p id="modal-event-long-detail"></p>
            </div>
            <div class="modal-section">
                <h4>کلیدی نکات (انفوگرافک):</h4>
                <ul id="modal-event-infographic-points"></ul>
            </div>
            <div class="modal-section">
                <h4>متعلقہ شخصیات:</h4>
                <p id="modal-event-personalities"></p>
            </div>
            <div class="modal-section">
                <h4>مقام:</h4>
                <p id="modal-event-location"></p>
            </div>
            <div class="modal-section">
                <h4>اہمیت:</h4>
                <p id="modal-event-significance"></p>
            </div>
            <div class="modal-section">
                <h4>ٹیگز:</h4>
                <div id="modal-event-tags" class="tags"></div>
            </div>
             <div class="modal-section">
                <h4>تصویری حوالہ:</h4>
                <p id="modal-event-image-ref">(امیج ڈسپلے یہاں آئے گا)</p>
            </div>
        </div>
    </div>

    <script>
    // --- Constants ---
    const DB_NAME = 'SeerahInfographicDB_v1';
    const STORE_NAME = 'enriched_events';
    const DB_VERSION = 1;
    let db;
    let allEventsData = []; // To hold all events in memory for filtering/searching

    // --- DOM Elements ---
    const searchInput = document.getElementById('searchInput');
    const filterPeriodSelect = document.getElementById('filterPeriod');
    const filterTagSelect = document.getElementById('filterTag');
    const filterSignificanceSelect = document.getElementById('filterSignificance');
    const eventListView = document.getElementById('event-list-view');
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    const modal = document.getElementById('eventDetailModal');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const views = document.querySelectorAll('.view');
    const narrativePathSelect = document.getElementById('narrativePathSelect');
    const bookmarkedEventsList = document.getElementById('bookmarked-events-list');
    const timelineSvgContainer = document.getElementById('timeline-svg-container');
    const timelineSvg = document.getElementById('timeline-svg');

    // --- IndexedDB Functions ---
    function openDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);
            request.onerror = (event) => reject("IndexedDB خرابی: " + event.target.errorCode);
            request.onsuccess = (event) => {
                db = event.target.result;
                resolve(db);
            };
            request.onupgradeneeded = (event) => {
                db = event.target.result;
                if (!db.objectStoreNames.contains(STORE_NAME)) {
                    db.createObjectStore(STORE_NAME, { keyPath: 'شمار' });
                }
            };
        });
    }

    function addDataToDB(dataArray) {
        return new Promise((resolve, reject) => {
            if (!db) { reject("DB not initialized"); return; }
            const transaction = db.transaction([STORE_NAME], 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            let operations = dataArray.length;
            if (operations === 0) resolve();

            dataArray.forEach(item => {
                const request = store.put(item); // put will add or update
                request.onsuccess = () => {
                    operations--;
                    if (operations === 0) resolve();
                };
                request.onerror = (event) => reject("ڈیٹا شامل کرنے میں خرابی: " + event.target.error);
            });
            transaction.oncomplete = () => resolve();
            transaction.onerror = (event) => reject("ٹرانزیکشن خرابی: " + event.target.error);
        });
    }
    
    function updateEventInDB(eventData) {
        return addDataToDB([eventData]); // `put` handles update
    }


    function getAllDataFromDB() {
        return new Promise((resolve, reject) => {
            if (!db) { reject("DB not initialized"); return; }
            const transaction = db.transaction([STORE_NAME], 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const request = store.getAll();
            request.onsuccess = (event) => resolve(event.target.result);
            request.onerror = (event) => reject("ڈیٹا حاصل کرنے میں خرابی: " + event.target.error);
        });
    }

    // --- CSV Parsing ---
    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length < 2) return []; // Need header and at least one data row
        const headers = lines[0].trim().split(',').map(h => h.trim());
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].trim().split(',');
            if (values.length === headers.length) {
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header] = values[index] ? values[index].trim() : '';
                });
                data.push(entry);
            }
        }
        return data;
    }

    async function fetchAndParseCSV(filePath) {
        try {
            const response = await fetch(filePath);
            if (!response.ok) {
                if (response.status === 404 && (filePath.includes('historyupdate.csv') || filePath.includes('details.csv')) ) {
                    console.log(`${filePath} نہیں ملی، نظر انداز کیا جا رہا ہے۔`);
                    return []; // Okay if update or details file not found
                }
                throw new Error(`فائل ${filePath} لوڈ کرنے میں ناکامی: ${response.statusText}`);
            }
            const csvText = await response.text();
            return parseCSV(csvText);
        } catch (error) {
            console.error(error.message);
            if (filePath.includes('historyupdate.csv') || filePath.includes('details.csv')) return [];
            throw error; // Re-throw for critical files like history.csv
        }
    }

    // --- Data Loading and Processing ---
    async function loadInitialData() {
        try {
            await openDB();
            const existingData = await getAllDataFromDB();
            if (existingData && existingData.length > 0) {
                console.log("موجودہ ڈیٹا IndexedDB سے لوڈ کیا گیا۔");
                allEventsData = existingData;
                await loadUpdateData(); // Check for updates even if existing data is present
                return;
            }

            console.log("ابتدائی ڈیٹا لوڈ کیا جا رہا ہے...");
            const historyData = await fetchAndParseCSV('history.csv');
            const detailsDataArray = await fetchAndParseCSV('details.csv');
            
            if (!historyData || historyData.length === 0) {
                eventListView.innerHTML = '<p class="text-center">ابتدائی تاریخ کی فائل (history.csv) لوڈ کرنے میں ناکامی۔</p>';
                return;
            }

            const detailsMap = new Map();
            detailsDataArray.forEach(detail => detailsMap.set(detail['شمار'], detail));

            const enrichedData = historyData.map(event => {
                const details = detailsMap.get(event['شمار']) || {};
                return { ...event, ...details, isBookmarked: false }; // Add bookmark flag
            });

            await addDataToDB(enrichedData);
            allEventsData = enrichedData;
            console.log("ابتدائی ڈیٹا کامیابی سے لوڈ اور اسٹور کیا گیا۔");
            await loadUpdateData();

        } catch (error) {
            console.error("ابتدائی ڈیٹا لوڈنگ میں خرابی:", error);
            eventListView.innerHTML = `<p class="text-center">ڈیٹا لوڈ کرنے میں خرابی: ${error.message}</p>`;
        }
    }

    async function loadUpdateData() {
        try {
            console.log("اپ ڈیٹ فائل چیک کی جا رہی ہے...");
            const updateData = await fetchAndParseCSV('historyupdate.csv');
            if (updateData && updateData.length > 0) {
                // Assuming updateData does not have corresponding details in this flow
                // For simplicity, new events from update.csv get default empty detail fields
                const newEnrichedUpdateData = updateData.map(event => ({
                    ...event, 
                    تفصیلی_وضاحت: '', 
                    متعلقہ_شخصیات: '',
                    مقام: '',
                    نقشہ_کوآرڈینیٹس: '',
                    اہمیت_اسکور: event['اہمیت_اسکور'] || '3', // Default if not present
                    تصویری_حوالہ: '',
                    ٹیگز: event['ٹیگز'] || '',
                    کلیدی_نکات_انفوگرافک: '',
                    isBookmarked: false
                }));

                await addDataToDB(newEnrichedUpdateData);
                console.log(`${newEnrichedUpdateData.length} اپ ڈیٹ شدہ واقعات شامل کیے گئے۔`);
                // Refresh allEventsData from DB to include updates
                allEventsData = await getAllDataFromDB();
            } else {
                console.log("کوئی نئی اپ ڈیٹ فائل نہیں ملی۔");
            }
        } catch (error) {
            console.error("اپ ڈیٹ ڈیٹا لوڈنگ میں خرابی:", error);
        }
    }
    

    // --- UI Rendering Functions ---
    function renderEventList(events) {
        eventListView.innerHTML = ''; // Clear previous list
        if (!events || events.length === 0) {
            eventListView.innerHTML = '<p class="text-center">کوئی واقعات نہیں ملے۔</p>';
            return;
        }

        const fragment = document.createDocumentFragment();
        events.forEach(event => {
            const card = document.createElement('div');
            card.className = 'event-card';
            card.dataset.id = event['شمار'];

            const title = document.createElement('h3');
            title.textContent = event['واقعہ (اردو)'] || 'N/A';

            const metaInfo = document.createElement('div');
            metaInfo.className = 'meta-info';
            metaInfo.innerHTML = `
                <span><span class="icon">📅</span> ${event['عیسوی سال (تقریباً)'] || 'N/A'}</span>
                <span><span class="icon">⏳</span> ${event['ہجری سال / دور'] || 'N/A'}</span>
                ${event['اہمیت_اسکور'] ? `<span><span class="icon">⭐</span> اہمیت: ${event['اہمیت_اسکور']}</span>` : ''}
            `;

            const shortDetail = document.createElement('p');
            shortDetail.className = 'short-detail';
            shortDetail.textContent = event['مختصر تفصیل (اردو)'] || '';
            
            const tagsContainer = document.createElement('div');
            tagsContainer.className = 'tags';
            if (event['ٹیگز']) {
                event['ٹیگز'].split('|').forEach(tag => { // Assuming tags are pipe-separated
                    const tagSpan = document.createElement('span');
                    tagSpan.textContent = tag.trim();
                    tagsContainer.appendChild(tagSpan);
                });
            }


            const actions = document.createElement('div');
            actions.className = 'actions';
            const detailButton = document.createElement('button');
            detailButton.textContent = 'مزید تفصیلات';
            detailButton.onclick = () => showEventDetailModal(event['شمار']);
            
            const bookmarkButton = document.createElement('button');
            bookmarkButton.textContent = event.isBookmarked ? 'پسندیدہ سے ہٹائیں' : 'پسندیدہ بنائیں';
            bookmarkButton.className = 'bookmark-btn';
            bookmarkButton.onclick = (e) => {
                e.stopPropagation(); // Prevent card click if any
                toggleBookmark(event['شمار']);
            };

            actions.appendChild(detailButton);
            actions.appendChild(bookmarkButton);

            card.appendChild(title);
            card.appendChild(metaInfo);
            card.appendChild(shortDetail);
            card.appendChild(tagsContainer);
            card.appendChild(actions);
            fragment.appendChild(card);
        });
        eventListView.appendChild(fragment);
    }

    function showEventDetailModal(eventId) {
        const event = allEventsData.find(e => e['شمار'] === eventId);
        if (!event) return;

        document.getElementById('modal-event-title').textContent = event['واقعہ (اردو)'] || 'N/A';
        document.getElementById('modal-event-period').textContent = event['ہجری سال / دور'] || 'N/A';
        document.getElementById('modal-event-gregorian-year').textContent = event['عیسوی سال (تقریباً)'] || 'N/A';
        document.getElementById('modal-event-short-detail').textContent = event['مختصر تفصیل (اردو)'] || 'N/A';
        document.getElementById('modal-event-long-detail').textContent = event['تفصیلی وضاحت'] || 'کوئی تفصیلی وضاحت دستیاب نہیں۔';
        
        const infographicPointsList = document.getElementById('modal-event-infographic-points');
        infographicPointsList.innerHTML = '';
        if (event['کلیدی_نکات_انفوگرافک']) {
            event['کلیدی_نکات_انفوگرافک'].split('|').forEach(point => {
                const li = document.createElement('li');
                li.textContent = point.trim();
                infographicPointsList.appendChild(li);
            });
        } else {
            infographicPointsList.innerHTML = '<li>کوئی کلیدی نکات دستیاب نہیں۔</li>';
        }

        document.getElementById('modal-event-personalities').textContent = event['متعلقہ شخصیات'] || 'N/A';
        document.getElementById('modal-event-location').textContent = event['مقام'] || 'N/A';
        document.getElementById('modal-event-significance').textContent = event['اہمیت_اسکور'] ? `${event['اہمیت_اسکور']} / 5` : 'N/A';
        
        const modalTagsContainer = document.getElementById('modal-event-tags');
        modalTagsContainer.innerHTML = '';
         if (event['ٹیگز']) {
            event['ٹیگز'].split('|').forEach(tag => {
                const tagSpan = document.createElement('span');
                tagSpan.textContent = tag.trim();
                modalTagsContainer.appendChild(tagSpan);
            });
        }

        document.getElementById('modal-event-image-ref').textContent = event['تصویری_حوالہ'] || 'کوئی تصویری حوالہ نہیں۔';

        modal.style.display = 'block';
    }
    
    function renderTimeline(events) {
        // Simplified SVG Timeline - this needs significant improvement for a real app
        timelineSvg.innerHTML = ''; // Clear previous
        if (!events || events.length === 0) {
            document.getElementById('timeline-view').querySelector('.infographic-placeholder').classList.remove('hidden');
            return;
        }
        document.getElementById('timeline-view').querySelector('.infographic-placeholder').classList.add('hidden');

        const PADDING = 50;
        const SVG_HEIGHT = 400;
        const EVENT_RADIUS = 5;
        const YEAR_STEP = 1; // How many years per "tick" - adjust for density

        // Sort events by approximate Gregorian year for timeline plotting
        const sortedEvents = [...events].sort((a, b) => {
            const yearA = parseInt(a['عیسوی سال (تقریباً)']);
            const yearB = parseInt(b['عیسوی سال (تقریباً)']);
            return yearA - yearB;
        });
        
        if (sortedEvents.length === 0) return;

        const firstYear = parseInt(sortedEvents[0]['عیسوی سال (تقریباً)']);
        const lastYear = parseInt(sortedEvents[sortedEvents.length - 1]['عیسوی سال (تقریباً)']);
        const yearRange = lastYear - firstYear || 1; // Avoid division by zero

        // Dynamically set SVG width based on year range and density
        const estimatedWidth = Math.max(1500, yearRange * 20 + 2 * PADDING); // Min width or calculated
        timelineSvg.setAttribute('width', estimatedWidth);
        timelineSvg.setAttribute('height', SVG_HEIGHT);


        // Main axis line
        const axis = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        axis.setAttribute('x1', PADDING);
        axis.setAttribute('y1', SVG_HEIGHT / 2);
        axis.setAttribute('x2', estimatedWidth - PADDING);
        axis.setAttribute('y2', SVG_HEIGHT / 2);
        axis.setAttribute('class', 'timeline-axis');
        timelineSvg.appendChild(axis);

        // Render Periods (conceptual)
        const periods = {
            "قبل از نبوت": { start: 570, end: 609, color: "rgba(0, 103, 120, 0.1)" },
            "نبوی": { start: 610, end: 621, color: "rgba(0, 147, 171, 0.1)" },
            "ہجری": { start: 622, end: 632, color: "rgba(255, 215, 0, 0.1)" }
        };

        for (const periodName in periods) {
            const period = periods[periodName];
            const periodStartYear = period.start;
            const periodEndYear = period.end;

            const xStart = PADDING + ((periodStartYear - firstYear) / yearRange) * (estimatedWidth - 2 * PADDING);
            const xWidth = ((periodEndYear - periodStartYear) / yearRange) * (estimatedWidth - 2 * PADDING);
            
            if (xWidth > 0) {
                const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                rect.setAttribute('x', xStart);
                rect.setAttribute('y', PADDING / 2);
                rect.setAttribute('width', xWidth);
                rect.setAttribute('height', SVG_HEIGHT - PADDING);
                rect.setAttribute('fill', period.color);
                rect.setAttribute('class', 'timeline-period-rect');
                timelineSvg.appendChild(rect);

                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('x', xStart + xWidth / 2);
                text.setAttribute('y', PADDING - 10);
                text.setAttribute('class', 'timeline-period-text');
                text.textContent = periodName;
                timelineSvg.appendChild(text);
            }
        }


        // Plot events
        let yOffsetAlternate = 0; // To alternate event text position
        sortedEvents.forEach((event, index) => {
            const eventYear = parseInt(event['عیسوی سال (تقریباً)']);
            if (isNaN(eventYear)) return;

            const x = PADDING + ((eventYear - firstYear) / yearRange) * (estimatedWidth - 2 * PADDING);
            const yBase = SVG_HEIGHT / 2;
            
            const group = document.createElementNS('http://www.w3.org/2000/svg', 'g');
            group.setAttribute('class', 'timeline-event-group');
            group.onclick = () => showEventDetailModal(event['شمار']);

            const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            circle.setAttribute('cx', x);
            circle.setAttribute('cy', yBase);
            circle.setAttribute('r', EVENT_RADIUS);
            circle.setAttribute('class', 'timeline-event-circle');
            
            const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            text.setAttribute('x', x);
            const textY = yBase + (yOffsetAlternate % 2 === 0 ? -15 : 25) + ( (yOffsetAlternate / 2) % 3 * 10); // Basic staggering
            text.setAttribute('y', textY);
            text.setAttribute('class', 'timeline-event-text');
            text.textContent = `${event['واقعہ (اردو)'].substring(0,15)}... (${eventYear})`;

            group.appendChild(circle);
            group.appendChild(text);
            timelineSvg.appendChild(group);
            yOffsetAlternate++;
        });
    }


    function populateFilterTags(events) {
        const tags = new Set();
        events.forEach(event => {
            if (event['ٹیگز']) {
                event['ٹیگز'].split('|').forEach(tag => tags.add(tag.trim()));
            }
        });
        filterTagSelect.innerHTML = '<option value="">تمام ٹیگز</option>'; // Reset
        tags.forEach(tag => {
            const option = document.createElement('option');
            option.value = tag;
            option.textContent = tag;
            filterTagSelect.appendChild(option);
        });
    }

    // --- Filtering and Searching ---
    function applyFiltersAndSearch() {
        const searchTerm = searchInput.value.toLowerCase();
        const selectedPeriod = filterPeriodSelect.value;
        const selectedTag = filterTagSelect.value;
        const selectedSignificance = filterSignificanceSelect.value;

        let filteredEvents = allEventsData.filter(event => {
            const matchesSearch = !searchTerm ||
                (event['واقعہ (اردو)'] && event['واقعہ (اردو)'].toLowerCase().includes(searchTerm)) ||
                (event['مختصر تفصیل (اردو)'] && event['مختصر تفصیل (اردو)'].toLowerCase().includes(searchTerm)) ||
                (event['تفصیلی وضاحت'] && event['تفصیلی وضاحت'].toLowerCase().includes(searchTerm)) ||
                (event['متعلقہ شخصیات'] && event['متعلقہ شخصیات'].toLowerCase().includes(searchTerm)) ||
                (event['ٹیگز'] && event['ٹیگز'].toLowerCase().includes(searchTerm));

            const matchesPeriod = !selectedPeriod || (event['ہجری سال / دور'] && event['ہجری سال / دور'].includes(selectedPeriod));
            const matchesTag = !selectedTag || (event['ٹیگز'] && event['ٹیگز'].includes(selectedTag));
            const matchesSignificance = !selectedSignificance || (event['اہمیت_اسکور'] && event['اہمیت_اسکور'] === selectedSignificance);
            
            return matchesSearch && matchesPeriod && matchesTag && matchesSignificance;
        });
        
        // Update current view with filtered events
        const activeViewId = document.querySelector('.view.active').id;
        if (activeViewId === 'event-list-view' || document.querySelector('#narrative-paths-view.active')) { // For narrative view as well
             renderEventList(filteredEvents);
        } else if (activeViewId === 'timeline-view') {
            renderTimeline(filteredEvents);
        } else if (activeViewId === 'bookmarks-view') {
            renderBookmarks(); // Re-render bookmarks based on current allEventsData and filters
        }
        // Add similar logic for map and charts if they use filtered data
    }
    
    function filterForNarrativePath(pathKey) {
        let narrativeEvents = [];
        // This is a very basic implementation. Real narrative paths would need more complex logic or specific tags.
        switch(pathKey) {
            case 'hijrat':
                narrativeEvents = allEventsData.filter(e => 
                    (e['واقعہ (اردو)'] && e['واقعہ (اردو)'].includes('ہجرت')) || 
                    (e['ٹیگز'] && e['ٹیگز'].includes('ہجرت'))
                );
                break;
            case 'treaties':
                narrativeEvents = allEventsData.filter(e => e['ٹیگز'] && e['ٹیگز'].includes('معاہدہ'));
                break;
            case 'battles':
                narrativeEvents = allEventsData.filter(e => e['ٹیگز'] && (e['ٹیگز'].includes('غزوہ') || e['ٹیگز'].includes('جنگ')));
                break;
            default:
                narrativeEvents = allEventsData; // Show all if no path or unknown path
        }
        document.getElementById('narrative-path-content').classList.add('hidden');
        eventListView.innerHTML = ''; // Clear event list view content area if it's not the target
        renderEventList(narrativeEvents); // Render into the default list view for now
    }


    // --- Theme Toggle ---
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
        const isDarkMode = document.body.classList.contains('dark-mode');
        localStorage.setItem('seerahInfographicTheme', isDarkMode ? 'dark' : 'light');
        themeToggleBtn.textContent = isDarkMode ? 'لائٹ موڈ' : 'ڈارک موڈ';
    }

    function applySavedTheme() {
        const savedTheme = localStorage.getItem('seerahInfographicTheme');
        if (savedTheme === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggleBtn.textContent = 'لائٹ موڈ';
        } else {
             themeToggleBtn.textContent = 'ڈارک موڈ';
        }
    }
    
    // --- Bookmarking ---
    async function toggleBookmark(eventId) {
        const eventIndex = allEventsData.findIndex(e => e['شمار'] === eventId);
        if (eventIndex === -1) return;

        allEventsData[eventIndex].isBookmarked = !allEventsData[eventIndex].isBookmarked;
        try {
            await updateEventInDB(allEventsData[eventIndex]);
            applyFiltersAndSearch(); // Re-render to update button text and bookmarks view if active
            if(document.querySelector('#bookmarks-view.active')) {
                renderBookmarks();
            }
        } catch (error) {
            console.error("بک مارک اپ ڈیٹ کرنے میں خرابی:", error);
            // Revert UI change if DB update fails (optional)
            allEventsData[eventIndex].isBookmarked = !allEventsData[eventIndex].isBookmarked;
        }
    }

    function renderBookmarks() {
        const bookmarked = allEventsData.filter(event => event.isBookmarked);
        bookmarkedEventsList.innerHTML = '';
        const placeholder = document.querySelector('#bookmarks-view .infographic-placeholder');
        if (bookmarked.length === 0) {
            placeholder.classList.remove('hidden');
            return;
        }
        placeholder.classList.add('hidden');
        renderEventListToContainer(bookmarked, bookmarkedEventsList); // Use a helper to render cards
    }
    
    // Helper to render event cards to a specific container
    function renderEventListToContainer(events, container) {
        container.innerHTML = ''; // Clear previous list
        const fragment = document.createDocumentFragment();
        events.forEach(event => {
            const card = document.createElement('div');
            card.className = 'event-card'; // Re-use existing card style
            card.dataset.id = event['شمار'];

            const title = document.createElement('h3');
            title.textContent = event['واقعہ (اردو)'] || 'N/A';

            const metaInfo = document.createElement('div');
            metaInfo.className = 'meta-info';
            metaInfo.innerHTML = `<span>${event['عیسوی سال (تقریباً)'] || 'N/A'}</span> | <span>${event['ہجری سال / دور'] || 'N/A'}</span>`;
            
            const actions = document.createElement('div');
            actions.className = 'actions';
            const detailButton = document.createElement('button');
            detailButton.textContent = 'مزید تفصیلات';
            detailButton.onclick = () => showEventDetailModal(event['شمار']);
            
            const unbookmarkButton = document.createElement('button');
            unbookmarkButton.textContent = 'پسندیدہ سے ہٹائیں';
            unbookmarkButton.onclick = (e) => {
                e.stopPropagation();
                toggleBookmark(event['شمار']);
            };

            actions.appendChild(detailButton);
            actions.appendChild(unbookmarkButton);

            card.appendChild(title);
            card.appendChild(metaInfo);
            card.appendChild(actions);
            fragment.appendChild(card);
        });
        container.appendChild(fragment);
    }


    // --- Event Listeners and Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        applySavedTheme();
        await loadInitialData();
        if (allEventsData && allEventsData.length > 0) {
            renderEventList(allEventsData); // Initial render
            populateFilterTags(allEventsData);
            renderTimeline(allEventsData); // Also render initial timeline
        } else {
             eventListView.innerHTML = '<div class="loader">کوئی واقعات لوڈ نہیں ہوئے۔ براہ کرم CSV فائلیں چیک کریں۔</div>';
        }

        searchInput.addEventListener('input', applyFiltersAndSearch);
        filterPeriodSelect.addEventListener('change', applyFiltersAndSearch);
        filterTagSelect.addEventListener('change', applyFiltersAndSearch);
        filterSignificanceSelect.addEventListener('change', applyFiltersAndSearch);
        themeToggleBtn.addEventListener('click', toggleTheme);
        closeModalBtn.onclick = () => modal.style.display = 'none';
        window.onclick = (event) => {
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        };
        
        narrativePathSelect.addEventListener('change', (e) => {
            if (e.target.value) {
                 // Switch to event list view for narrative path display if not already active
                views.forEach(v => v.classList.remove('active'));
                tabButtons.forEach(b => b.classList.remove('active'));
                
                eventListView.classList.add('active');
                document.querySelector('.tab-btn[data-view="event-list-view"]').classList.add('active'); // Visually activate list tab
                // Also hide the placeholder in narrative path view itself
                document.getElementById('narrative-path-content').classList.add('hidden');
                filterForNarrativePath(e.target.value);
            } else {
                 document.getElementById('narrative-path-content').classList.remove('hidden');
                 document.getElementById('narrative-path-content').innerHTML = "موضوعاتی مواد یہاں ظاہر ہوگا";
                 applyFiltersAndSearch(); // Show all/filtered events if no path selected
            }
        });


        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                const viewId = button.dataset.view;
                views.forEach(view => {
                    view.classList.remove('active');
                    if (view.id === viewId) {
                        view.classList.add('active');
                    }
                });
                // Special rendering logic for views if needed when tab is clicked
                if (viewId === 'timeline-view') renderTimeline(allEventsData); // Re-render with all data or filtered data
                if (viewId === 'bookmarks-view') renderBookmarks();
                if (viewId === 'event-list-view') applyFiltersAndSearch(); // Apply current filters to list view
                if (viewId === 'narrative-paths-view') {
                     // Reset narrative path selector and content
                    narrativePathSelect.value = '';
                    document.getElementById('narrative-path-content').classList.remove('hidden');
                    document.getElementById('narrative-path-content').innerHTML = "موضوعاتی مواد یہاں ظاہر ہوگا";
                }
            });
        });
    });

    </script>
</body>
</html>